<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" manifest="smfplayer.appcache">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content="Web Soundfont2 based MIDI Player written in JavaScript." />
		<meta name="author" content="Logue" />
		<title>SMF.Player for MIDI</title>
		<link type="text/css" rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
		<link type="text/css" rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" />
		<style type="text/css">
/*<![CDATA[*/
body {
	padding-top: 20px;
	padding-bottom: 20px;
}

iframe{
	width: 100%;
	height: 580px;
	border:thin;
}

/*]]>*/
		</style>
	</head>
	<body>
		<div class="container">
			<header class="header clearfix">
				<nav>
					<ul class="nav nav-pills pull-right">
						<li role="presentation" class="active"><a href="#">Sample</a></li>
						<li role="presentation"><a href="https://github.com/logue/smfplayer.js/">smfplayer.js</a></li>
						<li role="presentation"><a href="https://github.com/logue/sf2synth.js/">sf2synth.js</a></li>
					</ul>
				</nav>
				<h3 class="text-muted">MIDI Player XG</h3>
			</header>
			<hr />
			<aside class="pull-right">
				<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://logue.github.io/smfplayer.js" data-count="vertical" data-via="logue256" data-lang="ja" data-count="vertica">ツイート</a>
				<div class="g-plusone" data-size="tall" data-href="https://logue.github.io/smfplayer.js"></div>
				<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Flogue.github.io%2Fsmfplayer.js&amp;width=70&amp;height=65&amp;colorscheme=light&amp;layout=box_count&amp;action=like&amp;show_faces=true&amp;send=true&amp;appId=249014621810580" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:70px; height:65px;" allowTransparency="true"></iframe>
			</aside>
			<div id="info" class="alert alert-warning">Initializing...</div>
			<div class="panel panel-info clearfix" id="player">
				<div class="panel-heading">MIDI Player <small>(drag and drop midi file here to play your file.)</small></div>
				<div class="panel-body">
					<div class="row">
						<div class="col-md-4">
							<div class="form-inline">
								<button class="btn btn-info btn-lg" value="prev" id="prev" disabled="disabled" title="Previous Music"><span class="glyphicon glyphicon-chevron-left"></span></button>
								<button class="btn btn-primary btn-lg" value="play" id="play" disabled="disabled" title="Play / Pause"><span class="glyphicon glyphicon-play"></span></button>
								<button class="btn btn-danger btn-lg" value="stop" id="stop" disabled="disabled" title="Stop"><span class="glyphicon glyphicon-stop"></span></button>
								<button class="btn btn-info btn-lg" value="next" id="next" disabled="disabled" title="Next Music"><span class="glyphicon glyphicon-chevron-right"></span></button>
								<!--button class="btn btn-default btn-lg" value="panic" id="panic" disabled="disabled" title="Random"><span class="glyphicon glyphicon-remove-circle"></span></button-->
							</div>
						</div>
						<div class="col-md-5 form-group">
							<label for="files">MIDI file: </label>
							<select id="files" class="form-control"></select>
						</div>
						<div class="col-md-3 form-group">
							<label for="zips">Zip archive file:</label>
							<select id="zips" class="form-control">
								<option value="midifiles/YAMAHA mididata library.zip">YAMAHA mididata library.zip</option>
								<option value="midifiles/適当詰め合わせ.zip">適当詰め合わせ.zip</option>
								<option value="midifiles/Midi01.zip">Midi01.zip</option>
								<option value="midifiles/Midi03.zip">Midi03.zip</option>
								<option value="midifiles/Midi04.zip">Midi04.zip</option>
							</select>
						</div>
					</div>
					<div class="row">
						<div class="form-group col-md-3">
							<label>Music Progress</label>
							<div class="progress" style="margin-bottom:0;" id="music-progress">
								<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
							</div>
						</div>
						<div class="form-group col-md-9">
							<label for="url">URL for this MIDI :</label>
							<input id="url" size="100" readonly="readonly" onclick="this.select()" class="form-control" />
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">Settings</div>
				<div class="panel-body">
					<div class="form-group">
						<label for="synth">Select <a href="http://www.g200kg.com/en/docs/webmidilink/" target="_blank">WebMidiLink<span class="glyphicon glyphicon-new-window"></span></a> based synthesizer</label>
						<select id="synth" class="form-control">
							<option value="//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html" selected="selected">Yamaha XG Sound Set.sf2</option>
							<option value="//www.g200kg.com/webmidilink/gmplayer/">GMPlayer</option>
							<option value="//imaya.github.io/demo/sf2.js/wml.html">A320U.sf2</option>
						</select>
					</div>
					<div class="row">
						<div class="col-md-5">
							<div class="checkbox">
								<label for="random"><input type="checkbox" id="random" />Random</label>
							</div>
							<div class="checkbox">
								<label for="playerloop"><input id="playerloop" type="checkbox" onchange="player.setLoop(this.checked);" />Loop</label>
							</div>
							<div class="checkbox">
								<label for="cc111loop"><input id="cc111loop" type="checkbox" onchange="player.setCC111Loop(this.checked);" />CC#111</label>
							</div>
							<div class="checkbox">
								<label for="falcomloop"><input id="falcomloop" type="checkbox" onchange="player.setFalcomLoop(this.checked);" />Marker A-B (Ys2 Eternal)</label>
							</div>
							<div class="checkbox">
								<label for="mfiloop"><input id="mfiloop" type="checkbox" onchange="player.setMFiLoop(this.checked);" />MFi</label>
							</div>
						</div>
						<div class="col-md-7">
							<div class="form-group">
								<label for="tempo">Tempo: x<span id="tempo_value" class="badge">1.0</span></label>
								<input id="tempo" type="range" class="form-control" min="0.1" max="10.0" step="0.1" value="1.0" />
							</div>
							<div class="form-group">
								<label for="volume">Master Volume: <span id="volume_value" class="badge">0.5</span></label>
								<input id="volume" type="range" class="form-control" min="0" max="1" step="0.01" value="0.5" />
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="panel panel-default">
				<div class="panel-heading">Synthesyther</div>
				<div class="panel-body" id="wml"></div>
			</div>

			<footer class="footer">
				<address><a href="//github.com/gree/smfplayer.js">SMF.Player</a> (c) 2013 imaya / GREE Inc. Modified by <a href="//logue.be/">Logue</a>. Licensed under the <a href="http://opensource.org/licenses/mit-license.php">MIT License</a>.</address>
			</footer>
		</div>
		<aside><a href="https://github.com/logue/smfplayer.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a></aside>
		<script type="text/javascript" src="https:////code.jquery.com/jquery-2.2.4.min.js"></script>
		<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="./js/smf.player.min.js"></script>
		<!-- script src="../smfplayer.js/closure-primitives/base.js"></script>
		<script type="text/javascript">
/*<![CDATA[*/
var USE_TYPEDARRAY = true;
Object.keys(goog.dependencies_.nameToPath).forEach(function(name) {
  goog.require(name);
});
/*]]>*/</script -->
		<script type="text/javascript" src="./js/unzip.min.js"></script>
		<script type="text/javascript" src="./js/encoding.min.js"></script>
		<script type="text/javascript">
/*<![CDATA[*/
// インターバル関数用。準備完了フラグ
var isReady = false;
// QueryStrings
var params={};
location.search.substr(1).split('&').forEach(function(param){
	var param=decodeURIComponent(param);
	var p=param.split('=');params[p[0]]=p[1];
});
// SMF Player
var player=new SMF.Player();

/**
 * メイン処理
 */
$(document).ready(function(){
	// フォームを無効化
	$(':input').attr('disabled','disabled');
	// AudioContextが使用可能化のチェック
	window.AudioContext = window.AudioContext||window.webkitAudioContext||window.mozAudioContext;
	if ( typeof(window.AudioContext) === 'undefined'){
		$('#info').addClass('alert-danger').removeClass('alert-warning').text('Your browser has not supported AudioContent function. Please use Firefox or Blink based browser. (such as Chrome)');
		return;
	}
	// fileプロトコルは使用不可。（Ajaxを使うため）
	if (location.protocol === 'file:') {
		$('#info').addClass('alert-danger').removeClass('alert-warning').text('This program require runs by server.');
		return;
//	}else if (location.protocol === 'http:') {
//		location.href = 'https://logue.github.io/smfplayer.js';
	}
	

	// Zipファイルの取得
	var zips=document.querySelector('#zips');
	if(params.zips){
		zips.value=params.zips;
	} else{
		zips.selectedIndex=~~(zips.length*Math.random());
	}
	
	// smfplayer.jsの初期化
	player.setLoop($('#playerloop').is(':checked'));
	player.setCC111Loop($('#cc111loop').is(':checked'));
	player.setFalcomLoop($('#falcomloop').is(':checked'));
	player.setMFiLoop($('#mfiloop').is(':checked'));
	player.setTempoRate($('#tempo').val());
	player.setMasterVolume($('#volume').val() * 16383);
	// WebMidiLink設定
	//player.setWebMidiLink('//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html', 'wml');
	player.setWebMidiLink('wml.html', 'wml');

	loadSample();

	$('#files').change(function(e){
		handleSelect(this);
	});
	
	$('#zips').change(function(e){
		loadSample();
	});
	
	// MIDIファイルのドラッグアンドドロップ
	$('#player *').on('drop',function(e){
		if(e.originalEvent.dataTransfer){
			if(e.originalEvent.dataTransfer.files.length) {
				e.preventDefault();
				e.stopPropagation();
				/*UPLOAD FILES HERE*/
				handleFile(e.originalEvent.dataTransfer.files[0]);
			}
		}
		$('#player').removeClass('panel-danger').addClass('panel-info');
	}).
	on('dragover', function(e){
		e.preventDefault();
		e.stopPropagation();
		$('#player').removeClass('panel-info').addClass('panel-danger');
	}).
	on('dragleave', function(e){
		e.preventDefault();
		e.stopPropagation();
		$('#player').removeClass('panel-danger').addClass('panel-info');
	});

	// テンポ設定
	$('#tempo').change(function(){
		var value = $(this).val();
		player.setTempoRate(value);
		$('#tempo_value').text(value);
	});

	// マスターボリューム
	$('#volume').change(function(){
		var value = $(this).val();
		player.setMasterVolume(value * 16383);
		$('#volume_value').text(value);
	});
	
	// 前に戻るボタン
	$('#prev').click(function(){
		// 現在選択中の項目を取得
		var selected_music = $('#files').prop('selectedIndex');
		if (selected_music == $('#files option').length){
			// 末尾の場合、最後の曲へ
			$('#files').prop('selectedIndex',$('#files option').length);
		}else{
			// 選択されている項目の前の項目を選択
			$('#files').prop('selectedIndex',selected_music-1);
		}
		handleSelect(document.getElementById('files'));
	});

	// 次に進むボタン
	$('#next').click(function(){
		var selected_music = $('#files').prop('selectedIndex');
		if (selected_music == $('#files option').length){
			// 末尾の場合最初に戻る
			$('#files').prop('selectedIndex',0);
		}else{
			// 今選択されてる項目の次の項目を選択
			$('#files').prop('selectedIndex',selected_music+1);
		}
		handleSelect(document.getElementById('files'));
	});
	
	// 再生／一時停止ボタン
	$('#play').click(function(){
		if (player.pause) {
			// 再生
			player.play();
		}else{
			// 停止
			player.stop();
		}
	});

	// 停止ボタン
	$('#stop').click(function(){
		handleSelect(document.getElementById('files'));
		setTimeout(function(){
			player.stop();
		},51);//よく分からんが非同期で読み込むらしい
	});
/*
	// パニックボタン
	$('#panic').click(function(){
		player.getWebMidiLink().contentWindow.postMessage('midi, b0, 78,0');
	});
*/
	// WebMidiLinkセレクタ
	// うーん、デッドリンクだったり仕様が違ったりで全然使えないじゃん・・・。
	$.ajax({
		type: 'GET',
		url: 'http://www.g200kg.com/webmidilink/synthlist.js',
		dataType: 'jsonp',
		jsonpCallback: 'SynthListCallback',
		success: function(json){
			var $synths = $('#synth');
			$synths.html('');
			json.forEach(function(line){
				var $option = $('<option>')
					.val(line.url)
					.text(line.name);
				if (line.name == 'Yamaha XG Sound Set.sf2'){
					$option.prop('selected', true);
				}
//				if (line.name.match
				$('#synth').append($option);
			});
		}
	});
	$('#synth').change(function(e){
		player.setWebMidiLink($(this).val(), 'wml');
	});
	$('*[title]').tooltip();
});

/**
 * ファイルを読み込む
 */
function handleFile(file) {
	var reader = new FileReader();

	reader.onload = function(e) {
		var input = new Uint8Array(e.target.result);
		handleInput(file.name, input);
		$('#info').text = 'Ready.';
		$('#info').removeClass('alert-warning').addClass('alert-success');
	};
	reader.onloadstart = function(e) {
		$('#info').removeClass('alert-success').addClass('alert-warning');
	};
      
	reader.onprogress = function(e) {
		if (e.lengthComputable) {
			var percentLoaded = Math.round((e.loaded / e.total) * 100);
			$('#info').html('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="' + percentLoaded + '" aria-valuemin="0" aria-valuemax="100" style="width: ' + percentLoaded + '%;">' + percentLoaded + '%</div></div>');
		}
	}
	reader.readAsArrayBuffer(file);
}
var initialized=false;

/**
 * Zipファイルの内容を取得し、selectタグに割り当てる
 */
function loadSample() {
	var xhr = new XMLHttpRequest();
	var url = document.querySelector('#zips').value;

	// ZipファイルをXHRで読み込む
	xhr.open('GET', url, true);
	xhr.responseType = "arraybuffer";
	xhr.onload = function() {
		var input = new Uint8Array(this.response);

		var select = document.getElementById('files');
		while (select.childNodes.length > 0) {
			select.removeChild(select.firstChild);
		}

		// Zipファイルからファイル名一覧を取得
		var zip = select.zip = new Zlib.Unzip(input);
		var filenames = zip.getFilenames();
		
		filenames.forEach(function(name, i) {
			var ext = name.slice(name.lastIndexOf('.')).toLowerCase();
			if (ext === '/'){
				return;
			}

			var option = document.createElement('option');
			// 文字化け対策
			var ret = Encoding.convert(name, 'UNICODE', 'SJIS');
			
			//option.textContent = name.split('/').pop();
			option.textContent = ret;
			option.setAttribute('data-midiplayer-filename', name);
			select.appendChild(option);
		});

		if(document.querySelector('#random').checked==null){
			select.insertBefore(select.firstChild,document.createElement('option'));
		}
		else{
			if(params.files&&initialized==false){
				select.value=params.files;
			}
			else{
				var prev=select.selectedIndex;
				var next=prev;
				while(prev==next){
					next=~~(select.length*Math.random());
				}
				select.selectedIndex=next;
			}
			if(initialized){
				handleSelect(select);
			}
		}
		$('#info').html('Ready.');
		$('#info').removeClass('alert-warning').addClass('alert-success');
	};
	xhr.responseType = 'arraybuffer';
	xhr.onloadstart = function(e) {
		$('#info').removeClass('alert-success').addClass('alert-warning');
	};
      
	xhr.onprogress = function(e) {
		if (e.lengthComputable) {
			var percentLoaded = Math.round((e.loaded / e.total) * 10000);
			$('#info').html('Now loading... <br /><div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="' + percentLoaded + '" aria-valuemin="0" aria-valuemax="100" style="width: ' + percentLoaded + '%;">' + percentLoaded + '%</div></div>');
		}
	};
	xhr.send();
}
/**
 * 選択されたファイルを解凍
 * @param dom select 対象のselectタグ
 */
function handleSelect(select) {
	var option = select.querySelectorAll("option")[select.selectedIndex];
	var filename = option.getAttribute('data-midiplayer-filename');

	if (filename) {
		handleInput(filename, select.zip.decompress(filename));

		// このファイルのURLを生成
		var url= location.toString();
		var queries=[];
		if(location.search.indexOf('a320u')>0){
			queries.push('a320u');
		}
		queries.push("files="+encodeURIComponent(document.getElementById('files').value));
		queries.push("zips="+encodeURIComponent(document.getElementById('zips').value));
		url+='?'+queries.join('&');
		document.querySelector("#url").value=url;

		// ページのタイトルを反映
		var title=document.getElementById('files').value;
		title=title.substr(0,title.lastIndexOf('.'));
		document.title=title+' '+document.getElementById('zips').value+' / SMF.Player';
	}
}
/**
 * MIDI/MLDファイルを読み込ませる
 * @param string filename ファイル名
 * @param array buffer ファイルの中身
 */
function handleInput(filename, buffer) {
	// 再生中のMIDIを停止。
	player.stop();

	// なんかボリュームが書き換わってしまうことがあるため
	player.setMasterVolume($('#volume').val() * 16383);

	switch (filename.slice(filename.lastIndexOf('.')).toLowerCase()) {
		case '.mld':
		case '.midi':
			player.loadMldFile(buffer);
			break;
		case '.mid':
			player.loadMidiFile(buffer);
			break;
	}
	// マスターボリュームが低いままになるので
	player.setMasterVolume($('#volume').val() * 16383);

	//よく分からんが非同期で読み込むらしい
	setTimeout(function(){
		player.play();
	},50);
}

/**
 * ランダム再生
 */
function randomPlay(){
	var select=document.getElementById('files');
	select.selectedIndex=~~(select.length*Math.random());
	handleSelect(select);
}

/**
 * IFRAMEから送られてくるwindow.postMessageを監視
 */
$(window).on('message', function(e) {
	var event = e.originalEvent.data;  // Should work.

	switch (event) {
		case 'endoftrack':
			// 曲が終了したとき
			// 曲一覧の現在選択中の項目番号
			var selected_music = $('#music').prop('selectedIndex');
			
			player.stop();

			// 曲は終了しても、player.pauseの値が変化しないので、ここで、再生ボタンにする。
			$('#play').
				html('<span class="glyphicon glyphicon-play"></span>').
				removeClass('btn-success').
				addClass('btn-primary');
			if ($('#random').is(':checked')){
				randomPlay();
			}else{
				var selected_music = $('#files').prop('selectedIndex');
				if( selected_music !== 0){
					// ループで最初に戻った場合（player.positionがリセットされた場合）
					// 次の曲を選択
					if (selected_music == $('#files option').length){
						// 末尾の場合最初に戻る
						$('#files').prop('selectedIndex',0);
					}else{
						$('#files').prop('selectedIndex',selected_music+1);
					}
					// 曲を変更
					handleSelect(document.getElementById('files'));
				}
			}
			break;
		case 'link,ready':
			// WMLが読み込まれた時
			isReady=true;
			if(document.querySelector('#random').checked){
				handleSelect(document.querySelector('#files'));
			}
			$('#info').addClass('alert-success').removeClass('alert-warning').text('Ready.');
			$(':input').prop('disabled', false);
			break;
	}
});

/**
 * インターバル関数
 */
setInterval(function(){
	if (isReady) {
		// player.pauseの値で再生/一時停止ボタンを変化させる
		// ただし、smfplayer.jsのバグでplayer.loadMidiFile()が実行された直後、
		// 再生していない状態でもplayer.pauseの値がtrueになってしまうので、
		// もう一工夫いる。
		if (player.pause){
			$('#play').
				html('<span class="glyphicon glyphicon-play"></span>').
				removeClass('btn-success').
				addClass('btn-primary');
		}else{
			$('#play').
				html('<span class="glyphicon glyphicon-pause"></span>').
				removeClass('btn-primary').
				addClass('btn-success');
		}
		$('#music-progress .progress-bar').css('width',((player.getPosition()/player.getLength())*100)+'%');
	}
},100);

$.getScript('//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=129144050466298',function(){
	$('body').append('<div id="fb-root"></div>');
});
$.getScript('//apis.google.com/js/plusone.js');
$.getScript('//platform.twitter.com/widgets.js');

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-33600926-1', 'auto');
ga('send', 'pageview');

/*]]>*/
		</script>
	</body>
</html>