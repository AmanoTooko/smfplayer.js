/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {var q,t=this;function u(c,d){var e=c.split("."),b=t;e[0]in b||!b.execScript||b.execScript("var "+e[0]);for(var a;e.length&&(a=e.shift());)e.length||void 0===d?b[a]?b=b[a]:b=b[a]={}:b[a]=d}function v(c){var d=w;function e(){}e.prototype=d.prototype;c.da=d.prototype;c.prototype=new e;c.prototype.constructor=c;c.$=function(b,a,c){for(var e=Array(arguments.length-2),g=2;g<arguments.length;g++)e[g-2]=arguments[g];return d.prototype[a].apply(b,e)}};function w(c,d,e){this.f=c;this.time=e}function y(c,d,e,b,a,f){this.f=c;this.time=e;this.b=b;this.F=a;this.a=f}v(y);function z(c,d,e,b){this.f=c;this.time=e;this.data=b}v(z);function A(c,d,e,b){this.f=c;this.time=e;this.data=b}v(A);function C(c){var d;d=d||{};this.b=c;this.a=d.index||0}
function D(c){function d(){var c=b[a++]<<8|b[a++],c=a+c,d=[],e;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;)e={},e.part=b[a++]>>4&3,e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&
15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.octaveSelect=b[a++]&3,d.push(e);return d}function e(){var c=b[a++]<<8|b[a++],c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}}var b=c.b,a=c.a,f,k,g,l=c.m=[],n,h,m;h=0;for(m=c.g.o;h<m;++h){f=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==f)throw Error("invalid track signature:"+f);f=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];f=a+f;for(n=l[h]=[];a<f;){g={};g.deltaTime=b[a++];
k=b[a++];if(255!==k)g.type="note",g.subType="Note",g.voice=k>>6,g.key=k&63,g.length=b[a++],1===c.c.note&&(k=b[a++],g.velocity=k>>2,g.octaveShift=k&3);else switch(g.type="meta",k=b[a++],k>>4){case 11:switch(k&15){case 0:g.subType="MasterVolume";g.value=b[a++];break;case 10:g.subType="DrumScale";g.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+k.toString(16));}break;case 12:g.subType="SetTempo";g.value={timeBase:7===(k&7)?NaN:Math.pow(2,k&7)*(0===(k&8)?6:15),
tempo:b[a++]};break;case 13:switch(k&15){case 0:g.subType="Point";g.value=b[a++];break;case 13:g.subType="Loop";g.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:g.subType="Nop";g.value=b[a++];break;case 15:g.subType="EndOfTrack";g.value=b[a++];break;default:throw Error("unkwnon message type:"+k.toString(16));}break;case 14:switch(k&15){case 0:g.subType="InstrumentLowPart";g.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:g.subType="InstrumentHighPart";g.value={part:b[a]>>
6,instrument:b[a++]&1};break;case 2:g.subType="Volume";g.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:g.subType="Valance";g.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:g.subType="PitchBend";g.value={part:b[a]>>6,value:b[a++]&63};break;case 5:g.subType="ChannelAssign";g.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:g.subType="VolumeChange";g.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:g.subType="PitchBendRange";g.value={part:b[a]>>6,value:b[a++]&63};break;case 9:g.subType=
"MasterCoarseTuning";g.value={part:b[a]>>6,value:b[a++]&63};break;case 10:g.subType="Modulation";g.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+k.toString(16));}break;case 15:switch(k&15){case 0:g.subType="EditInstrument";g.value=d();break;case 1:g.subType="Vibrato";k=g;var p;a++;a++;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);p={part:b[a++]>>5&3,"switch":b[a++]>>6};k.value=p;break;case 15:g.subType="DeviceSpecific";g.value=e();break;
default:throw Error("unkwnon message type:"+k.toString(16));}break;default:throw Error("unkwnon message type:"+k.toString(16));}n.push(g)}a=f}c.a=a}
function E(c){var d={timeDivision:48},e=d.tracks=[],d=d.plainTracks=[],b=c.m,a,f,k,g,l,n,h,m,p,x,r=[];for(h=0;16>h;++h)d[h]=[],r[h]=0;h=0;for(m=b.length;h<m;++h){a=b[h];g=[];l=n=p=0;for(x=a.length;p<x;++p)switch(f=a[p],l+=f.deltaTime,f.id=n,f.time=l,f.subType){case "Nop":break;case "Note":g[n++]=f;g[n]={id:n,type:"internal",subType:"NoteOff",time:l+f.length,key:f.key,voice:f.voice,velocity:f.velocity,octaveShift:f.octaveShift};n++;break;case "InstrumentHighPart":k=f;f=a[++p];if("InstrumentLowPart"!==
f.subType)throw Error("broken instrument");g[n]={id:n,type:"internal",subType:"ProgramChange",time:l,part:f.value.part,instrument:k.value.instrument<<6|f.value.instrument};n++;break;default:g[n++]=f}g.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});e[h]=[];l=p=0;for(x=g.length;p<x;++p){f=g[p];l=f.time;switch(f.subType){case "Note":k=F(f.key+45,f.octaveShift);a=4*h+f.voice;9===a&&(k-=10);d[a].push(G(l-r[a]).concat(144|a,k,2*f.velocity));break;case "NoteOff":k=
F(f.key+45,f.octaveShift);a=4*h+f.voice;9===a&&(k-=10);d[a].push(G(l-r[a]).concat(128|a,k,2*f.velocity));break;case "ProgramChange":a=4*h+f.part;d[a].push(G(l-r[a]).concat(192|a,f.instrument));break;case "SetTempo":k=288E7/(f.value.tempo*f.value.timeBase);a=0;d[a].push(G(l-r[a]).concat(255,81,3,k>>16&255,k>>8&255,k&255));break;case "Loop":k=f.value.count;k="LOOP_"+(0===f.value.point?"START":"END")+"=ID:"+f.value.id+",COUNT:"+(0===k?-1:k);a=0;d[a].push(G(l-r[a]).concat([255,6,k.length],k.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":k=f.value;a=0;d[a].push(G(l-r[a]).concat(240,7,127,127,4,1,k,k,247));break;case "Modulation":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(176|a,1,2*f.value.depth));break;case "Volume":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(176|a,7,2*f.value.volume));break;case "Valance":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(176|a,10,2*(f.value.valance-32)+64));break;case "PitchBend":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(224|a,2*f.value.value,2*f.value.value));break;
case "PitchBendRange":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(176|a,100,0),[0,176|a,101,0],[0,176|a,6,2*f.value.value]);break;case "MasterCoarseTuning":a=4*h+f.value.part;d[a].push(G(l-r[a]).concat(176|a,100,0),[0,176|a,101,2],[0,176|a,6,2*f.value.value]);break;default:continue}r[a]=f.time}}return H(c,d)}function F(c,d){var e=[0,12,-24,-12];if(void 0!==e[d])return c+e[d];throw Error("invalid OctaveShift value:"+d);}
function H(c,d){var e,b,a=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],f,k,g;if(void 0!==c.c.copy){k=c.c.copy;f=k.length;e=Array(f);for(b=0;b<f;++b)e[b]=k.charCodeAt(b);b=e;k=b.length;b=[0,255,2].concat(G(k),b);d[0].unshift(b)}f=0;for(k=d.length;f<k;++f){var l=d[f];b=[];e=0;for(g=l.length;e<g;++e)Array.prototype.push.apply(b,l[e]);g=b.length;e=[77,84,114,107,g>>24&255,g>>16&255,g>>8&255,g&255];a=a.concat(e,b)}return new Uint8Array(a)}
function G(c){for(var d=[];128<=c;)d.unshift(c&127|(0===d.length?0:128)),c>>>=7;d.unshift(c|(0===d.length?0:128));return d};function I(c,d){d=d||{};this.g=c;this.a=d.index||0;this.length=d.length||c.length-this.a;this.b=this.a;this.h=void 0!==d.padding?d.padding:!0;this.i=void 0!==d.bigEndian?d.bigEndian:!1}function J(c,d){var e=c.c[d];return void 0===e?null:e};function K(c){var d;d=d||{};d.padding=!1;d.bigEndian=!0;this.b=c;this.c=0;this.a=new I(c,d);this.m=[];this.G=[]}
function L(c){function d(){var c=0,d;do d=b[a++],c=c<<7|d&127;while(0!==(d&128));return c}var e=J(c.a,c.c++),b=c.b,a=e.offset,f,k,g,l=-1,n=-1,h,m=0,p;if(!e||"MTrk"!==e.type)throw Error("invalid header signature");for(var e=e.offset+e.size,x=[],r=[];a<e;){f=d();m+=f;p=a;f=b[a++];k=f>>4&15;g=f&15;8>k?(k=l,g=n,f=l<<4|n,a--,p--):(l=k,n=g);var B=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(k){case 8:case 9:case 10:case 11:case 13:case 14:h=
new y(B[k],0,m,g,b[a++],b[a++]);break;case 12:h=new y(B[k],0,m,g,b[a++]);break;case 15:switch(g){case 0:h=d();if(247!==b[a+h-1])throw Error("invalid SysEx event");h=new z("SystemExclusive",0,m,b.subarray(a,(a+=h)-1));break;case 7:h=d();h=new z("SystemExclusive(F7)",0,m,b.subarray(a,a+=h));break;case 15:k=b[a++];h=d();switch(k){case 0:h=new A("SequenceNumber",0,m,[b[a++],b[a++]]);break;case 1:h=new A("TextEvent",0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 2:h=new A("CopyrightNotice",
0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 3:h=new A("SequenceTrackName",0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 4:h=new A("InstrumentName",0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 5:h=new A("Lyrics",0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 6:h=new A("Marker",0,m,[String.fromCharCode.apply(null,b.subarray(a,a+=h))]);break;case 7:h=new A("CuePoint",0,m,[String.fromCharCode.apply(null,b.subarray(a,
a+=h))]);break;case 32:h=new A("MidiChannelPrefix",0,m,[b[a++]]);break;case 47:h=new A("EndOfTrack",0,m,[]);break;case 81:h=new A("SetTempo",0,m,[b[a++]<<16|b[a++]<<8|b[a++]]);break;case 84:h=new A("SmpteOffset",0,m,[b[a++],b[a++],b[a++],b[a++],b[a++]]);break;case 88:h=new A("TimeSignature",0,m,[b[a++],b[a++],b[a++],b[a++]]);break;case 89:h=new A("KeySignature",0,m,[b[a++],b[a++]]);break;case 127:h=new A("SequencerSpecific",0,m,[b.subarray(a,a+=h)]);break;default:h=new A("Unknown",0,m,[k,b.subarray(a,
a+=h)])}break;default:t.console.log("unknown message:",f.toString(16))}break;default:throw Error("invalid status");}k=a-p;p=b.subarray(p,p+k);p[0]=f;h instanceof y&&"NoteOn"===h.f&&0===h.a&&(h.f=B[8],p=new Uint8Array([128|h.b,h.F,h.a]));r.push(p);x.push(h)}c.m.push(x);c.G.push(r)};function M(){this.l=5E5;this.j=!1;this.b=0;this.H=this.I=this.D=this.C=!1;this.u=1;this.J=16383;this.window=window}q=M.prototype;q.R=function(c){this.C=c};q.S=function(c){this.D=c};q.U=function(c){this.I=c};q.T=function(c){this.H=c};q.A=function(){var c,d;this.i=!0;this.g=Date.now();if(this.a)for(c=this.a.contentWindow,d=0;16>d;++d)c.postMessage("midi,b"+d.toString(16)+",78,0","*")};q.N=function(){return this.a};
function N(c){c.A();O(c);c.i=!1;c.h=null;c.g=-1;c.K=null;c.s=null;c.B=null;c.length=0;clearTimeout(c.c);c.j?P(c):c.window.addEventListener("message",function(d){"link,ready"===d.data&&P(c)},!1)}function O(c){c.l=5E5;c.b=0;P(c)}q.P=function(){var c=this;if(!this.a)throw Error("WebMidiLink not found");this.j?(this.length=this.h.length,this.h instanceof Array&&this.b>=this.length&&(this.b=0),Q(this)):this.window.addEventListener("message",function(d){"link,ready"===d.data&&(c.j=!0,Q(c))},!1)};
function P(c){c=c.a.contentWindow;var d;for(d=0;16>d;++d)c.postMessage("midi,b"+d.toString(16)+",07,64","*"),c.postMessage("midi,b"+d.toString(16)+",0a,40","*"),c.postMessage("midi,e"+d.toString(16)+",00,40","*"),c.postMessage("midi,b"+d.toString(16)+",64,00","*"),c.postMessage("midi,b"+d.toString(16)+",65,00","*"),c.postMessage("midi,b"+d.toString(16)+",06,02","*"),c.postMessage("midi,b"+d.toString(16)+",26,00","*")}
q.W=function(c,d){var e=this,b;this.a&&(this.window.document.body.removeChild(this.a),this.a=null);var a=d?this.window.document.getElementById(d):this.window.document.body;b=this.a=this.window.document.createElement("iframe");b.src=c||"//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html";b.className="wml";a.appendChild(b);this.window.addEventListener("message",function(a){"link,ready"===a.data&&(e.j=!0,e.w(e.J))},!1)};
q.w=function(c){this.J=c;this.a&&this.a.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(c&127).toString(16)).substr(-2),("0"+(c>>7&127).toString(16)).substr(-2),"7f"].join(),"*")};q.V=function(c){this.u=c};
function Q(c){function d(){var c=a[k].time,n=a.length,h,m,p=Date.now();if(e.i)e.g=Date.now()-e.g;else{do{h=a[k].event;"SetTempo"===h.f&&(e.l=h.data[0]);"ControlChange"===h.f&&111===h.F&&(g[0]={pos:k});if("Marker"===h.f&&("A"===h.data[0]&&(g[0]={pos:k}),"B"===h.data[0]&&e.D&&g[0]&&"number"===typeof g[0].pos)){k=g[0].pos;e.c=this.window.setTimeout(d,0);e.b=k;return}if("Marker"===h.f&&(h=h.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===h[1])g[h[2]|0]=g[h[2]]||{pos:k,count:h[3]|
0};else if("END"===h[1]&&e.I){m=g[h[2]|0];if(0!==m.count){0<m.count&&m.count--;k=m.pos;e.c=this.window.setTimeout(d,0);e.b=k;return}g[h[2]|0]=null}f.postMessage(a[k++].webMidiLink,"*")}while(k<n&&a[k].time===c);k<n?(p=Date.now()-p,e.c=this.window.setTimeout(d,e.l/(1E3*b)*(a[k].time-c-p)*(1/e.u))):(this.window.postMessage("endoftrack","*"),e.C&&g[0]&&"number"===typeof g[0].pos?(k=g[0].pos,e.c=this.window.setTimeout(d,0)):e.H&&(O(e),Q(e)));e.b=k}}var e=c,b=c.K.Y,a=c.h,f=c.a.contentWindow,k=c.b||0,g=
[];c.i?(c.c=c.window.setTimeout(d,c.g),c.i=!1,c.g=-1):c.c=c.window.setTimeout(d,c.l/1E3*b*c.h[0].time)}
q.v=function(c){c=new K(c);N(this);var d,e;d=c.a;e=d.length+d.b;for(d.c=[];d.a<e;){var b=d,a=b.g,f=b.a;b.c.push({type:String.fromCharCode(a[f++],a[f++],a[f++],a[f++]),size:a=b.i?(a[f++]<<24|a[f++]<<16|a[f++]<<8|a[f++])>>>0:(a[f++]|a[f++]<<8|a[f++]<<16|a[f++]<<24)>>>0,offset:f});f+=a;b.h&&1===(f-b.b&1)&&f++;b.a=f}d=J(c.a,c.c++);e=c.b;b=d.offset;if(!d||"MThd"!==d.type)throw Error("invalid header signature");c.X=e[b++]<<8|e[b++];c.o=e[b++]<<8|e[b++];c.Y=e[b++]<<8|e[b++];d=0;for(e=c.o;d<e;++d)L(c);R(this,
c)};
q.O=function(c){c=new C(c);N(this);var d=c.b,e=c.a,b=c.g={},a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]);if("melo"!==a)throw Error("invalid MFi signature:"+a);b.ca=(d[e++]<<24|d[e++]<<16|d[e++]<<8|d[e++])>>>0;b.Z=(d[e++]<<16|d[e++])+e;b.aa=d[e++];b.ba=d[e++];b.o=d[e++];c.a=e;for(var d=c.b,e=c.a,b=c.c={},f;e<c.g.Z;)switch(a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]),f=d[e++]<<8|d[e++],a){case "titl":case "copy":case "vers":case "date":case "prot":b[a]=String.fromCharCode.apply(null,d.subarray(e,
e+=f));break;case "sorc":b[a]=d[e++];break;case "note":b[a]=d[e++]<<8|d[e++];break;default:b[a]=d.subarray(e,e+=f)}c.a=e;D(c);this.v(E(c))};
function R(c,d){var e=c.h=[],b,a,f,k=c.B=[],g,l,n,h;a=d.m;b=Array(a.length);f=d.G;g=0;for(l=a.length;g<l;++g)b[g]=0;g=0;for(l=a.length;g<l;++g)for(b=a[g],n=0,h=b.length;n<h;++n)0===d.X&&"SequenceTrackName"===b[n].f&&(c.s=b[n].data[0]),"CopyrightNotice"===b[n].f&&k.push(b[n].data[0]),e.push({track:g,eventId:n,time:b[n].time,event:b[n],webMidiLink:"midi,"+Array.prototype.map.call(f[g][n],function(a){return a.toString(16)}).join(",")});e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>
b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});c.K=d}q.M=function(){return this.s};q.L=function(){return this.B};u("SMF.Player",M);u("SMF.Player.prototype.play",M.prototype.P);u("SMF.Player.prototype.stop",M.prototype.A);u("SMF.Player.prototype.loadMidiFile",M.prototype.v);u("SMF.Player.prototype.loadMldFile",M.prototype.O);u("SMF.Player.prototype.setLoop",M.prototype.T);u("SMF.Player.prototype.setCC111Loop",M.prototype.R);u("SMF.Player.prototype.setFalcomLoop",M.prototype.S);u("SMF.Player.prototype.setMFiLoop",M.prototype.U);u("SMF.Player.prototype.setWebMidiLink",M.prototype.W);
u("SMF.Player.prototype.getWebMidiLink",M.prototype.N);u("SMF.Player.prototype.setTempoRate",M.prototype.V);u("SMF.Player.prototype.setMasterVolume",M.prototype.w);u("SMF.Player.prototype.getCopyright",M.prototype.L);u("SMF.Player.prototype.getSequenceName",M.prototype.M);}).call(this); //# sourceMappingURL=smf.player.min.js.map
