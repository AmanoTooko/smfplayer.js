(function(){/*
   2007-2013,2018-2019 Logue <http://logue.dev/> All rights reserved.
 @license     MIT
   2019 Logue <https://logue.dev/> All rights reserved.
 @license     MIT
 @logue/smfplayer v0.3.0 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(t,k){"object"===typeof exports&&"object"===typeof module?module.exports=k():"function"===typeof define&&define.amd?define("SMF",[],k):"object"===typeof exports?exports.SMF=k():t.SMF=k()})("undefined"!==typeof self?self:this,function(){return function(t){function k(e){if(g[e])return g[e].exports;var a=g[e]={i:e,l:!1,exports:{}};t[e].call(a.exports,a,a.exports,k);a.l=!0;return a.exports}var g={};k.m=t;k.c=g;k.d=function(e,a,c){k.o(e,a)||Object.defineProperty(e,a,{enumerable:!0,
get:c})};k.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});Object.defineProperty(e,"__esModule",{value:!0})};k.t=function(e,a){a&1&&(e=k(e));if(a&8||a&4&&"object"===typeof e&&e&&e.__esModule)return e;var c=Object.create(null);k.r(c);Object.defineProperty(c,"default",{enumerable:!0,value:e});if(a&2&&"string"!=typeof e)for(var b in e)k.d(c,b,function(b){return e[b]}.bind(null,b));return c};k.n=function(e){var a=e&&e.__esModule?
function(){return e["default"]}:function(){return e};k.d(a,"a",a);return a};k.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)};k.p="";return k(k.s=10)}([function(t,k,g){g.d(k,"a",function(){return a});g.d(k,"c",function(){return c});g.d(k,"b",function(){return b});class e{constructor(b,c,a){this.subtype=b;this.deltaTime=c;this.time=a}}class a extends e{constructor(b,c,a,f,q,p){super(b,c,a);this.channel=f;this.parameter1=q;this.parameter2=p}}class c extends e{constructor(b,c,a,f){super(b,
c,a);this.data=f}}class b extends e{constructor(b,c,a,f){super(b,c,a);this.data=f}}},function(t,k,g){g.d(k,"a",function(){return a});var e=g(0);class a{constructor(c={}){this.timeDivision=parseInt(c.timeDivision)||96;this.channel=c.channel|0;this.timeOffset=c.timeOffset|0;this.PATTERN=/[A-GLNORTV<>][\+#-]?[0-9]*\.?&?/ig;this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};this.MINIM=2*this.timeDivision;this.SEMIBREVE=4*this.timeDivision;this.mml=c.mml;this.events=[];this.plainEvents=[];this.endTime=0;this.parse()}parse(){let c;
try{c=this.mml.match(this.PATTERN)}catch(l){console.warn("Could not parse MML.",this.mml);return}let b=this.timeOffset,a=this.timeDivision,d=0,n=!1,f=8,q=4;const p=[];for(const u in c)if(c.hasOwnProperty(u)){let h=a|0;if(c[u].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i)){var m=parseInt(RegExp.$2);n&&"&"!==RegExp.$4&&(n=!1,p.push(new e.a("NoteOff",0,b,this.channel,d)));switch(RegExp.$1){case "L":case "l":1<=m&&m<=this.MINIM&&(a=Math.floor(this.SEMIBREVE/m),"."==RegExp.$3&&(a=Math.floor(1.5*a)));break;
case "O":case "o":0<=m&&8>=m&&(q=m);break;case "T":case "t":p.push(new e.b("SetTempo",0,b,[Math.floor(6E7/m)]));break;case "V":case "v":0<=m&&15>=m&&(f=m);break;case "<":q=0>=q?0:q-1;break;case ">":q=8<=q?8:q+1}}else c[u].match(/([A-GN])([\+#-]?)([0-9]*)(\.?)(&?)/i)?(m=RegExp.$3|0,"n"!==RegExp.$1&&"N"!==RegExp.$1&&(1<=m&&m<=this.MINIM&&(h=Math.floor(this.SEMIBREVE/m)),"."===RegExp.$4&&(h=Math.floor(1.5*h)),m=12*q+this.NOTE_TABLE[RegExp.$1.toLowerCase()],"+"===RegExp.$2||"#"===RegExp.$2?m++:"-"===
RegExp.$2&&m--),m+=12,n?m!==d&&p.push(new e.a("NoteOff",0,b,this.channel,d)):p.push(new e.a("NoteOn",0,b,this.channel,m,8*f)),b+=h,"&"===RegExp.$5?(n=!0,d=m):(n=!1,p.push(new e.a("NoteOff",0,b,this.channel,m)))):c[u].match(/[rR]([0-9]*)(\.?)/)?(m=RegExp.$1|0,1<=m&&m<=this.MINIM&&(h=Math.floor(this.SEMIBREVE/m)),"."===RegExp.$2&&(h=Math.floor(1.5*h)),b+=h):console.warn("unknown signeture.",c[u])}this.events=p;this.endTime=b}}},function(t,k,g){g.d(k,"a",function(){return b});var e=g(1);t=g(7);var a=
g.n(t),c=g(0);class b{constructor(b,c={}){b=String.fromCharCode.apply("",new Uint16Array(b));this.input=a.a.parse(b);this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=c.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("shift_jis");var b=this.input.infomation;this.title=b.title;this.type=b.auther;this.timeDivision=b.timeBase|0||96;delete this.input.infomation;delete this.input["mms-file"];b=[];b.push(new c.c("SystemExclusive",
0,0,[126,127,9,1]));b.push(new c.b("SequenceTrackName",0,0,[this.title]));b.push(new c.b("CopyrightNotice",0,0,[this.author]));b.push(new c.b("EndOfTrack",0,0));this.tracks.push(b)}parseTracks(){const b=this.input;let a=[];const n=[];let f=0;for(const d in b)if(b.hasOwnProperty(d)){const m=[b[d].ch0_mml,b[d].ch1_mml,b[d].ch2_mml];var q=b[d].panpot|64;a.push(new c.b("InsturumentName",0,48,[b[d].name]));a.push(new c.a("ProgramChange",0,96,f,b[d].instrument|0));a.push(new c.a("ControlChange",0,154,f,
10,q));for(q=0;q<m.length;q++){const b=new e.a({timeDivision:this.timeDivision,channel:f,timeOffset:386,mml:m[q]});a=a.concat(b.events);n.push(b.endTime)}f++;a.concat(new c.b("EndOfTrack",0,Math.max(n)));this.tracks.push(a)}this.numberOfTracks=this.tracks.length}toPlainTrack(){for(let b=0;b<this.tracks.length;b++){let a=[],u=[];const f=this.tracks[b];for(let b=0;b<f.length;b++){const a=f[b];let d;if(a instanceof c.a)switch(a.subtype){case "NoteOn":d=0===a.parameter2?new Uint8Array([128|a.channel,
a.parameter1,a.parameter2]):new Uint8Array([144|a.channel,a.parameter1,a.parameter2]);break;case "NoteOff":d=new Uint8Array([128|a.channel,a.parameter1,a.parameter2]);break;case "ControlChange":d=new Uint8Array([176|a.channel,a.parameter1,a.parameter2]);break;case "ProgramChange":d=new Uint8Array([192|a.channel,a.parameter1])}else if(a instanceof c.b){const b=this.encoder.encode(a.data);switch(a.subtype){case "SequenceTrackName":d=new Uint8Array([255,3].concat(b));break;case "CopyrightNotice":d=new Uint8Array([255,
2].concat(b));break;case "InsturumentName":d=new Uint8Array([255,4].concat(b));break;case "SetTempo":d=new Uint8Array([255,81].concat(b));break;case "EndOfTrack":d=new Uint8Array([255,47])}}else a instanceof c.c&&(d=new Uint8Array([240,5].concat(a.data)));u=u.concat(d)}a=a.concat(u);this.plainTracks[b]=a}}}},function(t,k,g){g.d(k,"a",function(){return e});class e{constructor(a,b={}){this.input=a;this.ip=b.index||0;this.length=b.length||a.length-this.ip;this.offset=this.ip;this.padding=void 0!==b.padding?
b.padding:!0;this.bigEndian=void 0!==b.bigEndian?b.bigEndian:!1}parse(){const a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()}parseChunk(){var c=this.input;let b=this.ip;this.chunkList.push(new a(String.fromCharCode(c[b++],c[b++],c[b++],c[b++]),c=this.bigEndian?(c[b++]<<24|c[b++]<<16|c[b++]<<8|c[b++])>>>0:(c[b++]|c[b++]<<8|c[b++]<<16|c[b++]<<24)>>>0,b));b+=c;this.padding&&1===(b-this.offset&1)&&b++;this.ip=b}getChunk(a){a=this.chunkList[a];return void 0===a?null:a}getNumberOfChunks(){return this.chunkList.length}}
class a{constructor(a,b,u){this.type=a;this.size=b;this.offset=u}}},function(t,k,g){g.r(k);g.d(k,"default",function(){return c});var e=g(3),a=g(0);class c{constructor(b,a={}){a.padding=!1;a.bigEndian=!0;this.input=b;this.ip=a.index||0;this.chunkIndex=0;this.riffParser_=new e.a(b,a);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[]}parse(){let b,a;this.riffParser_.parse();this.parseHeaderChunk();b=0;for(a=this.numberOfTracks;b<a;++b)this.parseTrackChunk()}parseHeaderChunk(){const b=
this.riffParser_.getChunk(this.chunkIndex++),a=this.input;let c=b.offset;if(!b||"MThd"!==b.type)throw Error("invalid header signature");this.formatType=a[c++]<<8|a[c++];this.numberOfTracks=a[c++]<<8|a[c++];this.timeDivision=a[c++]<<8|a[c++]}parseTrackChunk(){var b=this.riffParser_.getChunk(this.chunkIndex++);const c=this.input;let d=b.offset,n=0;var f=0;let q=0;var p=0;let m=-1,l=-1,h=p=0;var v=0;let e=f=0,r;const g=()=>{let b=0,a;do a=c[d++],b=b<<7|a&127;while(0!==(a&128));return b};if(!b||"MTrk"!==
b.type)throw Error("invalid header signature");n=b.offset+b.size;b=[];const k=[];for(;d<n;){f=g();h+=f;v=d;e=c[d++];q=e>>4&15;p=e&15;8>q?(q=m,p=l,e=m<<4|l,d--,v--):(m=q,l=p);const n=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(q){case 8:case 9:case 10:case 11:case 13:case 14:r=new a.a(n[q],f,h,p,c[d++],c[d++]);break;case 12:r=new a.a(n[q],f,h,p,c[d++]);break;case 15:switch(p){case 0:p=g();if(247!==c[d+p-1])throw Error("invalid SysEx event");
r=new a.c("SystemExclusive",f,h,c.subarray(d,(d+=p)-1));break;case 7:p=g();r=new a.c("SystemExclusive(F7)",f,h,c.subarray(d,d+=p));break;case 15:q=c[d++];p=g();switch(q){case 0:r=new a.b("SequenceNumber",f,h,[c[d++],c[d++]]);break;case 1:r=new a.b("TextEvent",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 2:r=new a.b("CopyrightNotice",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 3:r=new a.b("SequenceTrackName",f,h,[String.fromCharCode.apply(null,c.subarray(d,
d+=p))]);break;case 4:r=new a.b("InstrumentName",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 5:r=new a.b("Lyrics",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 6:r=new a.b("Marker",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 7:r=new a.b("CuePoint",f,h,[String.fromCharCode.apply(null,c.subarray(d,d+=p))]);break;case 32:r=new a.b("MidiChannelPrefix",f,h,[c[d++]]);break;case 47:r=new a.b("EndOfTrack",f,h,[]);break;case 81:r=new a.b("SetTempo",
f,h,[c[d++]<<16|c[d++]<<8|c[d++]]);break;case 84:r=new a.b("SmpteOffset",f,h,[c[d++],c[d++],c[d++],c[d++],c[d++]]);break;case 88:r=new a.b("TimeSignature",f,h,[c[d++],c[d++],c[d++],c[d++]]);break;case 89:r=new a.b("KeySignature",f,h,[c[d++],c[d++]]);break;case 127:r=new a.b("SequencerSpecific",f,h,[c.subarray(d,d+=p)]);break;default:r=new a.b("Unknown",f,h,[q,c.subarray(d,d+=p)])}break;default:console.warn("unknown message:",e.toString(16))}break;default:throw Error("invalid status");}f=d-v;v=c.subarray(v,
v+f);v[0]=e;r instanceof a.a&&"NoteOn"===r.subtype&&0===r.parameter2&&(r.subtype=n[8],v=new Uint8Array([128|r.channel,r.parameter1,r.parameter2]));k.push(v);b.push(r)}this.tracks.push(b);this.plainTracks.push(k)}}},function(t,k,g){g.d(k,"a",function(){return e});class e{constructor(a,c={}){this.input=a;this.ip=c.index||0;this.timeDivision=c.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const a=this.input;let c=this.ip;const b=this.header=
{},e=String.fromCharCode(a[c++],a[c++],a[c++],a[c++]);if("melo"!==e)throw Error("invalid MFi signature:"+e);b.fileLength=(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0;b.trackOffset=(a[c++]<<16|a[c++])+c;b.dataMajorType=a[c++];b.dataMinorType=a[c++];b.numberOfTracks=a[c++];this.ip=c}parseDataInformation(){const a=this.input;let c=this.ip;const b=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let e,d;for(;c<this.header.trackOffset;)switch(e=
String.fromCharCode(a[c++],a[c++],a[c++],a[c++]),d=a[c++]<<8|a[c++],e){case "titl":case "copy":case "vers":case "date":case "prot":b[e]=String.fromCharCode.apply(null,a.subarray(c,c+=d));break;case "sorc":b[e]=a[c++];break;case "note":b[e]=a[c++]<<8|a[c++];break;case "exst":break;default:b[e]=a.subarray(c,c+=d)}this.ip=c}parseTracks(){const a=this.input;let c=this.ip;let b;const e=this.tracks=[];let d,n,f;const q=()=>{var b=a[c++]<<8|a[c++];b=c+b;const f=[];let d;if(1!==a[c++])throw Error("invalid EditInstrument const value:"+
a[c-1]);for(;c<b;)d={},d.part=a[c++]>>4&3,d.modulator={ML:a[c]>>5,VIV:a[c]>>4&1,EG:a[c]>>3&1,SUS:a[c]>>2&1,RR:(a[c++]&3)<<2|a[c]>>6,DR:a[c]>>4&15,AR:(a[c++]&3)<<2|a[c]>>6,SL:a[c]>>4&15,TL:(a[c++]&3)<<4|a[c]>>4,WF:a[c]>>3&1,FB:a[c++]&7},d.carrier={ML:a[c]>>5,VIV:a[c]>>4&1,EG:a[c]>>3&1,SUS:a[c]>>2&1,RR:(a[c++]&3)<<2|a[c]>>6,DR:a[c]>>4&15,AR:(a[c++]&3)<<2|a[c]>>6,SL:a[c]>>4&15,TL:(a[c++]&3)<<4|a[c]>>4,WF:a[c]>>3&1,FB:a[c++]&7},d.octaveSelect=a[c++]&3,f.push(d);return f},p=()=>{var b=a[c++]<<8|a[c++];
b=c+b;if(17!==a[c++])throw Error("invalid DeviceSpecific const value:"+a[c-1]);return{data:a.subarray(c,c+=b-c)}};n=0;for(f=this.header.numberOfTracks;n<f;++n){var m=String.fromCharCode(a[c++],a[c++],a[c++],a[c++]);if("trac"!==m)throw Error("invalid track signature:"+m);m=a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++];m=c+m;for(d=e[n]=[];c<m;){b={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};b.deltaTime=deltaTime=a[c++];var l=a[c++];if(255!==l)b.type="note",
b.subType="Note",b.voice=l>>6,b.key=l&63,noteLength=b.length=a[c++],1===this.dataInformation.note&&(l=a[c++],b.velocity=l>>2,b.octaveShift=l&3);else switch(b.type="meta",l=a[c++],l>>4){case 11:switch(l&15){case 0:b.subType="MasterVolume";b.value=a[c++];break;case 10:b.subType="DrumScale";b.value={channel:a[c]>>3&7,drum:a[c++]&1};break;default:throw Error("unknown message type:"+l.toString(16));}break;case 12:b.subType="SetTempo";b.value={timeBase:7===(l&7)?NaN:Math.pow(2,l&7)*(0===(l&8)?6:15),tempo:a[c++]};
break;case 13:switch(l&15){case 0:b.subType="Point";b.value=a[c++];break;case 13:b.subType="Loop";b.value={id:a[c]>>6,count:a[c]>>2&15,point:a[c++]&3};break;case 14:b.subType="Nop";b.value=a[c++];break;case 15:b.subType="EndOfTrack";b.value=a[c++];break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 14:switch(l&15){case 0:b.subType="InstrumentLowPart";b.value={part:a[c]>>6,instrument:a[c++]&63};break;case 1:b.subType="InstrumentHighPart";b.value={part:a[c]>>6,instrument:a[c++]&
1};break;case 2:b.subType="Volume";b.value={part:a[c]>>6,volume:a[c++]&63};break;case 3:b.subType="Valance";b.value={part:a[c]>>6,valance:a[c++]&63};break;case 4:b.subType="PitchBend";b.value={part:a[c]>>6,value:a[c++]&63};break;case 5:b.subType="ChannelAssign";b.value={part:a[c]>>6,channel:a[c++]&63};break;case 6:b.subType="VolumeChange";b.value={part:a[c]>>6,volume:(a[c++]&63)<<26>>26};break;case 7:b.subType="PitchBendRange";b.value={part:a[c]>>6,value:a[c++]&63};break;case 8:case 9:b.subType="MasterCoarseTuning";
b.value={part:a[c]>>6,value:a[c++]&63};break;case 10:b.subType="Modulation";b.value={part:a[c]>>6,depth:a[c++]&63};break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 15:switch(l&15){case 0:b.subType="EditInstrument";b.value=q();break;case 1:b.subType="Vibrato";l=b;if(1!==a[c++])throw Error("invalid Vibrato const value:"+a[c-1]);var h={part:a[c++]>>5&3,"switch":a[c++]>>6};l.value=h;break;case 15:b.subType="DeviceSpecific";b.value=p();break;default:throw Error("unkwnon message type:"+
l.toString(16));}break;default:throw Error("unkwnon message type:"+l.toString(16));}d.push(b)}c=m}this.ip=c}convertToMidiTracks(){const a=[],c=this.tracks;let b;let e,d,n,f,q,p,m;const l=[];for(f=0;16>f;++f)a[f]=[],l[f]=0;f=0;for(q=c.length;f<q;++f){var h=c[f];e=[];d=n=p=0;for(m=h.length;p<m;++p)switch(b=h[p],d+=b.deltaTime,b.id=n,b.time=d,b.subType){case "Nop":break;case "Note":e[n++]=b;e[n]={id:n,type:"internal",subType:"NoteOff",time:d+b.length,key:b.key,voice:b.voice,velocity:b.velocity,octaveShift:b.octaveShift};
n++;break;case "InstrumentHighPart":var g=b;b=h[++p];if("InstrumentLowPart"!==b.subType)throw Error("broken instrument");e[n]={id:n,type:"internal",subType:"ProgramChange",time:d,part:b.value.part,instrument:g.value.instrument<<6|b.value.instrument};n++;break;default:e[n++]=b}e.sort((b,a)=>b.time>a.time?1:b.time<a.time?-1:b.id>a.id?1:b.id<a.id?-1:0);d=p=0;for(m=e.length;p<m;++p){b=e[p];d=b.time;switch(b.subType){case "Note":g=this.applyOctaveShift(b.key+45,b.octaveShift);h=4*f+b.voice;9===h&&(g-=
10);a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(144|h,g,2*b.velocity));break;case "NoteOff":g=this.applyOctaveShift(b.key+45,b.octaveShift);h=4*f+b.voice;9===h&&(g-=10);a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(128|h,g,2*b.velocity));break;case "ProgramChange":h=4*f+b.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(192|h,b.instrument));break;case "SetTempo":g=288E7/(b.value.tempo*b.value.timeBase);h=0;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(255,81,3,g>>16&255,g>>
8&255,g&255));break;case "Loop":g=b.value.count;g="LOOP_"+(0===b.value.point?"START":"END")+"=ID:"+b.value.id+",COUNT:"+(0===g?-1:g);h=0;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat([255,6,g.length],g.split("").map(b=>b.charCodeAt(0))));break;case "MasterVolume":g=b.value;h=0;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(240,7,127,127,4,1,g,g,247));break;case "Modulation":h=4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(176|h,1,2*b.value.depth));break;case "Volume":h=
4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(176|h,7,2*b.value.volume));break;case "Valance":h=4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(176|h,10,2*(b.value.valance-32)+64));break;case "PitchBend":h=4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(224|h,2*b.value.value,2*b.value.value));break;case "PitchBendRange":h=4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(176|h,100,0),[0,176|h,101,0],[0,176|h,6,2*b.value.value]);
break;case "MasterCoarseTuning":h=4*f+b.value.part;a[h].push(this.deltaTimeToByteArray(d-l[h]).concat(176|h,100,0),[0,176|h,101,2],[0,176|h,6,2*b.value.value]);break;default:continue}l[h]=b.time}}return this.toSMF(a)}applyOctaveShift(a,c){const b=[0,12,-24,-12];if(void 0!==b[c])return a+b[c];throw Error("invalid OctaveShift value:"+c);}toSMF(a){var c;let b=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let e;if(void 0!==this.dataInformation.copy){var d=this.dataInformation.copy;var n=d.length;var f=Array(n);
for(c=0;c<n;++c)f[c]=d.charCodeAt(c);c=d=f;d=c.length;c=[0,255,2].concat(this.deltaTimeToByteArray(d),c);a[0].unshift(c)}n=0;for(d=a.length;n<d;++n){const d=a[n];c=[];f=0;for(e=d.length;f<e;++f)Array.prototype.push.apply(c,d[f]);e=c.length;f=[77,84,114,107,e>>24&255,e>>16&255,e>>8&255,e&255];b=b.concat(f,c)}return new Uint8Array(b)}deltaTimeToByteArray(a){const c=[];for(;128<=a;)c.unshift(a&127|(0===c.length?0:128)),a>>>=7;c.unshift(a|(0===c.length?0:128));return c}}},function(t,k,g){g.d(k,"a",function(){return c});
var e=g(1);t=g(2);var a=g(0);class c extends t.a{constructor(b,a={}){super(b,a);this.encoder=new TextEncoder("utf-8");this.input=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(b)),"text/xml").querySelectorAll("ms2 > *");this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=a.timeDivision||96}parse(){this.parseTracks();this.toPlainTrack();console.log(this)}parseTracks(){let b=[];const c=[];for(let a=0;a<this.input.length;a++){const d=new e.a({timeDivision:this.timeDivision,
channel:0,mml:this.input[a].textContent.trim()});b=b.concat(d.events);c.push(d.endTime)}b.concat(new a.b("EndOfTrack",0,Math.max(c)));this.tracks.push(b)}}},function(t,k){function g(b,a){var f=[],d="";"string"===typeof a?a={section:a,whitespace:!1}:(a=a||{},a.whitespace=!0===a.whitespace);var n=a.whitespace?" = ":"=";Object.keys(b).forEach(function(a,e,h){(e=b[a])&&Array.isArray(e)?e.forEach(function(b){d+=c(a+"[]")+n+c(b)+"\n"}):e&&"object"===typeof e?f.push(a):d+=c(a)+n+c(e)+u});a.section&&d.length&&
(d="["+c(a.section)+"]"+u+d);f.forEach(function(c,f,h){f=e(c).join("\\.");c=g(b[c],{section:(a.section?a.section+".":"")+f,whitespace:a.whitespace});d.length&&c.length&&(d+=u);d+=c});return d}function e(a){return a.replace(/\1/g,"\u0002LITERAL\\1LITERAL\u0002").replace(/\\\./g,"\u0001").split(/\./).map(function(a){return a.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"\u0001")})}function a(a){return'"'===a.charAt(0)&&'"'===a.slice(-1)||"'"===a.charAt(0)&&"'"===a.slice(-1)}function c(b){return"string"!==
typeof b||b.match(/[=\r\n]/)||b.match(/^\[/)||1<b.length&&a(b)||b!==b.trim()?JSON.stringify(b):b.replace(/;/g,"\\;").replace(/#/g,"\\#")}function b(b,c){b=(b||"").trim();if(a(b)){"'"===b.charAt(0)&&(b=b.substr(1,b.length-2));try{b=JSON.parse(b)}catch(l){}}else{c=!1;for(var f="",d=0,e=b.length;d<e;d++){var m=b.charAt(d);if(c)f=-1!=="\\;#".indexOf(m)?f+m:f+("\\"+m),c=!1;else if(-1!==";#".indexOf(m))break;else"\\"===m?c=!0:f+=m}c&&(f+="\\");return f.trim()}return b}k.parse=k.decode=function(a){var c=
{},f=c,d=null,g=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;a.split(/[\r\n]+/g).forEach(function(a,e,h){if(a&&!a.match(/^\s*[;#]/)&&(e=a.match(g)))if(void 0!==e[1])d=b(e[1]),f=c[d]=c[d]||{};else{a=b(e[2]);e=e[3]?b(e[4]):!0;switch(e){case "true":case "false":case "null":e=JSON.parse(e)}2<a.length&&"[]"===a.slice(-2)&&(a=a.substring(0,a.length-2),f[a]?Array.isArray(f[a])||(f[a]=[f[a]]):f[a]=[]);Array.isArray(f[a])?f[a].push(e):f[a]=e}});Object.keys(c).filter(function(a,b,f){if(!c[a]||"object"!==typeof c[a]||
Array.isArray(c[a]))return!1;b=e(a);var d=c;f=b.pop();var h=f.replace(/\\\./g,".");b.forEach(function(a,b,c){d[a]&&"object"===typeof d[a]||(d[a]={});d=d[a]});if(d===c&&h===f)return!1;d[h]=c[a];return!0}).forEach(function(a,b,f){delete c[a]});return c};k.stringify=k.encode=g;k.safe=c;k.unsafe=b;var u="undefined"!==typeof process&&"win32"===process.platform?"\r\n":"\n"},function(t,k,g){g.d(k,"a",function(){return c});var e=g(1),a=g(0);t=g(2);class c extends t.a{constructor(a,c={}){super(a,c)}parse(){this.parseHeader();
this.parseTracks();this.toPlainTrack();console.log(this)}parseHeader(){var b=this.input.Settings;this.encoder=new TextEncoder(b.Encoding||"shift_jis");this.title=b.Title;this.author=b.Source;this.timeDivision=b.TimeBase|0||32;delete this.input["3MLE EXTENSION"];delete this.input.Settings;b=[];b.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));b.push(new a.b("SequenceTrackName",0,0,[this.title]));b.push(new a.b("CopyrightNotice",0,0,[this.author]));b.push(new a.b("EndOfTrack",0,0));this.tracks.push(b)}parseTracks(){var b=
this.input;const c=[];var d=[],g=[];for(const a in b)b.hasOwnProperty(a)&&(a.match(/^Channel(\d+)$/i)&&(d[(RegExp.$1|0)-1]=Object.keys(b[a]).join("").replace(/\/\*([^*]|\*[^\/])*\*\//g,"")),a.match(/^ChannelProperty(\d+)$/i)&&(g[(RegExp.$1|0)-1]={name:b[a].Name,instrument:b[a].Patch|0,panpot:b[a].Pan|0}));b=[];for(const a in d)d.hasOwnProperty(a)&&(b[a]=void 0!==g[a]?{mml:d[a],name:g[a].name||"",instrument:g[a].instrument||0,panpot:g[a].panpot||64}:{mml:d[a],name:"",instrument:0,panpot:64});for(const f in b)b.hasOwnProperty(f)&&
(g=f|0,d=[],""!==b[f].mml&&(d.push(new a.b("InsturumentName",0,48,[b[f].name])),d.push(new a.a("ProgramChange",0,96,g,b[f].instrument)),d.push(new a.a("ControlChange",0,154,g,10,b[f].panpot)),g=new e.a({timeDivision:this.timeDivision,channel:g,timeOffset:386,mml:b[f].mml}),d=d.concat(g.events),c.push(g.endTime),d.concat(new a.b("EndOfTrack",0,Math.max(c))),this.tracks.push(d)));this.numberOfTracks=this.tracks.length}}},function(t,k,g){g.d(k,"a",function(){return c});var e=g(1);t=g(2);var a=g(0);class c extends t.a{parse(){this.parseHeader();
this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("utf-8");this.title=this.input["mml-score"].title;this.author=this.input["mml-score"].author;this.timeDivision=96;delete this.input["mml-score"].author;delete this.input["mml-score"].version;delete this.input["mml-score"].title;delete this.input["mml-score"].time;delete this.input["mml-score"].tempo;const b=[];b.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));b.push(new a.b("SequenceTrackName",0,0,[this.title]));
b.push(new a.b("CopyrightNotice",0,0,[this.author]));b.push(new a.b("EndOfTrack",0,0));this.tracks.push(b)}parseTracks(){const b=this.input;let c=[];const d=[];let g=0;for(const f in b)if(b.hasOwnProperty(f)){if(!b[f]["mml-track"].match(/^(?:MML@)(.*)/gm))continue;const q=RegExp.$1.split(",");c.push(new a.b("InsturumentName",0,48,b[f].name));c.push(new a.a("ProgramChange",0,96,g,b[f].program|0));c.push(new a.a("ControlChange",0,154,g,10,b[f].panpot|0));for(let a=0;a<q.length;a++){3===a&&(g=15+b[f].songProgram|
0);if(void 0===q[a])continue;const m=new e.a({timeDivision:this.timeDivision,channel:g,timeOffset:386,mml:q[a]});c=c.concat(m.events);d.push(m.endTime)}g++;c.concat(new a.b("EndOfTrack",0,Math.max(d)));this.tracks.push(c)}this.numberOfTracks=this.tracks.length}}},function(t,k,g){g.r(k);g.d(k,"Player",function(){return n});var e=g(4),a=g(5),c=g(6),b=g(2),u=g(8),d=g(9);class n{constructor(a="#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=[];this.timer=0;this.sequence={};
this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=!1;this.tempoRate=1;this.masterVolume=16383;this.sequenceName="";this.copyright=[];this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a)}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(a=
0;16>a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();this.initSequence();this.pause=!0;this.track=null;this.resume=-1;this.copyright=this.sequenceName=this.sequence=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",b=>{"link,ready"===b.data&&a.sendInitMessage()},!1)}initSequence(){this.tempo=
5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px",a.playSequence())},
!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+",06,02","*"),a.postMessage("midi,b"+
b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,c=a=>{"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);this.target.firstChild&&this.target.removeChild(this.target.firstChild);const b=this.webMidiLink=this.window.document.createElement("iframe");
b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",c,!1);const f=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",f,!1);let d=0;this.window.addEventListener("resize",()=>{0<d&&clearTimeout(d);d=setTimeout(f,100)},!1)}else this.webMidiLink.addEventListener("message",c,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+
[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,d=this.webMidiLink.contentWindow;let e=this.position||0;const h=[],g=()=>{const f=c[e].time,m=c.length;let k,p=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{var l=c[e].event;"SetTempo"===l.subtype&&(a.tempo=l.data[0]);"ControlChange"===l.subtype&&111===l.parameter1&&(h[0]={pos:e});if("Marker"===
l.subtype&&("A"===l.data[0]&&(h[0]={pos:e}),"B"===l.data[0]&&a.enableFalcomLoop&&h[0]&&"number"===typeof h[0].pos)){e=h[0].pos;a.timer=a.window.setTimeout(g,0);a.position=e;return}if("Marker"===l.subtype&&(l=l.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===l[1])h[l[2]|0]=h[l[2]]||{pos:e,count:l[3]|0};else if("END"===l[1]&&a.enableMFiLoop){k=h[l[2]|0];if(0!==k.count){0<k.count&&k.count--;e=k.pos;a.timer=a.window.setTimeout(g,0);a.position=e;return}h[l[2]|0]=null}d.postMessage(c[e++].webMidiLink,
"*")}while(e<m&&c[e].time===f);e<m?(p=Date.now()-p,a.timer=a.window.setTimeout(g,a.tempo/(1E3*b)*(c[e].time-f-p)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&h[0]&&"number"===typeof h[0].pos?e=h[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=e;a.time=f}};this.pause?(this.timer=a.window.setTimeout(g,this.resume),this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(g,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=new e["default"](a);this.init();a.parse();
this.mergeMidiTracks(a)}loadMldFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b.convertToMidiTracks())}loadMs2MmlFile(a){a=new c.a(a);this.init();a.parse();this.mergeMidiTracks(a)}loadMakiMabiSequenceFile(a){a=new b.a(a);this.init();a.parse();this.mergeMidiTracks(a)}load3MleFile(a){a=new u.a(a);this.init();a.parse();this.mergeMidiTracks(a)}loadMmiFile(a){a=new d.a(a);this.init();a.parse();this.mergeMidiTracks(a)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var d=Array(c.length);
const e=a.plainTracks,f=this.copyright=[];let g,k,n,t;g=0;for(k=c.length;g<k;++g)d[g]=0;g=0;for(k=c.length;g<k;++g)for(d=c[g],n=0,t=d.length;n<t;++n)0===a.formatType&&"SequenceTrackName"===d[n].subtype&&(this.sequenceName=d[n].data[0]),"CopyrightNotice"===d[n].subtype&&f.push(d[n].data[0]),b.push({track:g,eventId:n,time:d[n].time,event:d[n],webMidiLink:"midi,"+Array.prototype.map.call(e[g][n],a=>a.toString(16)).join(",")});b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?
-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getPosition(){return this.position}setPosition(a){this.position=a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(a){a*=this.tempo/
6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
