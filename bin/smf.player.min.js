(function(){/*
 2007-2013,2018-2019 Logue <http://logue.be/> All rights reserved.
 @license MIT
 2019 Logue <http://logue.be/> All rights reserved.
 @license MIT
 @logue/smfplayer v0.2.3 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(u,n){"object"===typeof exports&&"object"===typeof module?module.exports=n():"function"===typeof define&&define.amd?define("SMF",[],n):"object"===typeof exports?exports.SMF=n():u.SMF=n()})("undefined"!==typeof self?self:this,function(){return function(u){function n(h){if(l[h])return l[h].exports;var b=l[h]={i:h,l:!1,exports:{}};u[h].call(b.exports,b,b.exports,n);b.l=!0;return b.exports}var l={};n.m=u;n.c=l;n.d=function(h,b,a){n.o(h,b)||Object.defineProperty(h,b,{enumerable:!0,
get:a})};n.r=function(h){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(h,Symbol.toStringTag,{value:"Module"});Object.defineProperty(h,"__esModule",{value:!0})};n.t=function(h,b){b&1&&(h=n(h));if(b&8||b&4&&"object"===typeof h&&h&&h.__esModule)return h;var a=Object.create(null);n.r(a);Object.defineProperty(a,"default",{enumerable:!0,value:h});if(b&2&&"string"!=typeof h)for(var c in h)n.d(a,c,function(a){return h[a]}.bind(null,c));return a};n.n=function(h){var b=h&&h.__esModule?
function(){return h["default"]}:function(){return h};n.d(b,"a",b);return b};n.o=function(h,b){return Object.prototype.hasOwnProperty.call(h,b)};n.p="";return n(n.s=9)}([function(u,n,l){l.d(n,"a",function(){return b});l.d(n,"c",function(){return a});l.d(n,"b",function(){return c});class h{constructor(a,c,b){this.subtype=a;this.deltaTime=c;this.time=b}}class b extends h{constructor(a,c,b,g,r,p){super(a,c,b);this.channel=g;this.parameter1=r;this.parameter2=p}}class a extends h{constructor(a,c,b,g){super(a,
c,b);this.data=g}}class c extends h{constructor(a,c,b,g){super(a,c,b);this.data=g}}},function(u,n,l){l.d(n,"a",function(){return b});var h=l(0);class b{constructor(a={}){this.timeDivision=parseInt(a.timeDivision)||96;this.channel=a.channel|0;this.timeOffset=a.timeOffset|0;this.PATTERN=/[A-GLNORTV<>][\+#-]?[0-9]*\.?&?/ig;this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};this.MINIM=2*this.timeDivision;this.SEMIBREVE=4*this.timeDivision;this.mml=a.mml.match(this.PATTERN);this.events=[];this.plainEvents=
[];this.endTime=0;this.parse()}parse(){const a=this.mml;let c=this.timeOffset,b=this.timeDivision,d=0,k=!1,g=8,r=4;const p=[];for(const e in a)if(a.hasOwnProperty(e)){let f=b|0;if(a[e].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i)){var m=parseInt(RegExp.$2);k&&"&"!==RegExp.$4&&(k=!1,p.push(new h.a("NoteOff",0,c,this.channel,d)));switch(RegExp.$1){case "L":case "l":1<=m&&m<=this.MINIM&&(b=Math.floor(this.SEMIBREVE/m),"."==RegExp.$3&&(b=Math.floor(1.5*b)));break;case "O":case "o":0<=m&&8>=m&&(r=m);
break;case "T":case "t":p.push(new h.b("SetTempo",0,c,[Math.floor(6E7/m)]));break;case "V":case "v":0<=m&&15>=m&&(g=m);break;case "<":r=0>=r?0:r-1;break;case ">":r=8<=r?8:r+1}}else a[e].match(/([A-GN])([\+#-]?)([0-9]*)(\.?)(&?)/i)?(m=RegExp.$3|0,"n"!==RegExp.$1&&"N"!==RegExp.$1&&(1<=m&&m<=this.MINIM&&(f=Math.floor(this.SEMIBREVE/m)),"."===RegExp.$4&&(f=Math.floor(1.5*f)),m=12*r+this.NOTE_TABLE[RegExp.$1.toLowerCase()],"+"===RegExp.$2||"#"===RegExp.$2?m++:"-"===RegExp.$2&&m--),m+=12,k?m!==d&&p.push(new h.a("NoteOff",
0,c,this.channel,d)):p.push(new h.a("NoteOn",0,c,this.channel,m,8*g)),c+=f,"&"===RegExp.$5?(k=!0,d=m):(k=!1,p.push(new h.a("NoteOff",0,c,this.channel,m)))):a[e].match(/[rR]([0-9]*)(\.?)/)?(m=RegExp.$1|0,1<=m&&m<=this.MINIM&&(f=Math.floor(this.SEMIBREVE/m)),"."===RegExp.$2&&(f=Math.floor(1.5*f)),c+=f):console.warn("unknown signeture.",a[e])}this.events=p;this.endTime=c}}},function(u,n,l){l.d(n,"a",function(){return c});var h=l(1);u=l(5);var b=l.n(u),a=l(0);class c{constructor(a,c={}){a=String.fromCharCode.apply("",
new Uint16Array(a));this.input=b.a.parse(a);this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=c.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack();console.log(this)}parseHeader(){this.encoder=new TextEncoder("shift_jis");var b=this.input.infomation;this.title=b.title;this.author=b.auther;this.timeDivision=b.timeBase|0||96;delete this.input.infomation;delete this.input["mms-file"];b=[];b.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));b.push(new a.b("SequenceTrackName",
0,0,[this.title]));b.push(new a.b("CopyrightNotice",0,0,[this.author]));b.push(new a.b("EndOfTrack",0,0));this.tracks.push(b)}parseTracks(){const b=this.input;let c=[];const k=[];let g=0;for(const d in b)if(b.hasOwnProperty(d)){const m=[b[d].ch0_mml,b[d].ch1_mml,b[d].ch2_mml];var r=b[d].panpot|64;c.push(new a.b("InsturumentName",0,48,[b[d].name]));c.push(new a.a("ProgramChange",0,96,g,b[d].instrument|0));c.push(new a.a("ControlChange",0,154,g,10,r));for(r=0;r<m.length;r++){const a=new h.a({timeDivision:this.timeDivision,
channel:g,timeOffset:386,mml:m[r]});c=c.concat(a.events);k.push(a.endTime)}g++;c.concat(new a.b("EndOfTrack",0,Math.max(k)));this.tracks.push(c)}this.numberOfTracks=this.tracks.length}toPlainTrack(){for(let b=0;b<this.tracks.length;b++){let c=[],k=[];const g=this.tracks[b];for(let b=0;b<g.length;b++){const c=g[b];let d;if(c instanceof a.a)switch(c.subtype){case "NoteOn":d=0===c.parameter2?new Uint8Array([128|c.channel,c.parameter1,c.parameter2]):new Uint8Array([144|c.channel,c.parameter1,c.parameter2]);
break;case "NoteOff":d=new Uint8Array([128|c.channel,c.parameter1,c.parameter2]);break;case "ControlChange":d=new Uint8Array([176|c.channel,c.parameter1,c.parameter2]);break;case "ProgramChange":d=new Uint8Array([192,64|c.channel,c.parameter1])}else if(c instanceof a.b){const a=this.encoder.encode(c.data);switch(c.subtype){case "SequenceTrackName":d=new Uint8Array([255,3].concat(a));break;case "CopyrightNotice":d=new Uint8Array([255,2].concat(a));break;case "InsturumentName":d=new Uint8Array([255,
4].concat(a));break;case "SetTempo":d=new Uint8Array([255,81].concat(a));break;case "EndOfTrack":d=new Uint8Array([255,47])}}else c instanceof a.c&&(d=new Uint8Array([240,5].concat(c.data)));k=k.concat(d)}c=c.concat(k);this.plainTracks[b]=c}}}},function(u,n,l){l.d(n,"a",function(){return h});class h{constructor(a,c={}){this.input=a;this.ip=c.index||0;this.length=c.length||a.length-this.ip;this.offset=this.ip;this.padding=void 0!==c.padding?c.padding:!0;this.bigEndian=void 0!==c.bigEndian?c.bigEndian:
!1}parse(){const a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()}parseChunk(){var a=this.input;let c=this.ip;this.chunkList.push(new b(String.fromCharCode(a[c++],a[c++],a[c++],a[c++]),a=this.bigEndian?(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0:(a[c++]|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,c));c+=a;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}getChunk(a){a=this.chunkList[a];return void 0===a?null:a}getNumberOfChunks(){return this.chunkList.length}}class b{constructor(a,
c,b){this.type=a;this.size=c;this.offset=b}}},function(u,n,l){l.r(n);l.d(n,"default",function(){return a});var h=l(3),b=l(0);class a{constructor(a,b={}){b.padding=!1;b.bigEndian=!0;this.input=a;this.ip=b.index||0;this.chunkIndex=0;this.riffParser_=new h.a(a,b);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[]}parse(){let a,b;this.riffParser_.parse();this.parseHeaderChunk();a=0;for(b=this.numberOfTracks;a<b;++a)this.parseTrackChunk()}parseHeaderChunk(){const a=
this.riffParser_.getChunk(this.chunkIndex++),b=this.input;let d=a.offset;if(!a||"MThd"!==a.type)throw Error("invalid header signature");this.formatType=b[d++]<<8|b[d++];this.numberOfTracks=b[d++]<<8|b[d++];this.timeDivision=b[d++]<<8|b[d++]}parseTrackChunk(){var a=this.riffParser_.getChunk(this.chunkIndex++);const e=this.input;let d=a.offset,k=0;var g=0;let r=0;var p=0;let m=-1,q=-1,f=p=0;var v=0;let h=g=0,t;const l=()=>{let a=0,b;do b=e[d++],a=a<<7|b&127;while(0!==(b&128));return a};if(!a||"MTrk"!==
a.type)throw Error("invalid header signature");k=a.offset+a.size;a=[];const n=[];for(;d<k;){g=l();f+=g;v=d;h=e[d++];r=h>>4&15;p=h&15;8>r?(r=m,p=q,h=m<<4|q,d--,v--):(m=r,q=p);const c=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(r){case 8:case 9:case 10:case 11:case 13:case 14:t=new b.a(c[r],g,f,p,e[d++],e[d++]);break;case 12:t=new b.a(c[r],g,f,p,e[d++]);break;case 15:switch(p){case 0:p=l();if(247!==e[d+p-1])throw Error("invalid SysEx event");
t=new b.c("SystemExclusive",g,f,e.subarray(d,(d+=p)-1));break;case 7:p=l();t=new b.c("SystemExclusive(F7)",g,f,e.subarray(d,d+=p));break;case 15:r=e[d++];p=l();switch(r){case 0:t=new b.b("SequenceNumber",g,f,[e[d++],e[d++]]);break;case 1:t=new b.b("TextEvent",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 2:t=new b.b("CopyrightNotice",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 3:t=new b.b("SequenceTrackName",g,f,[String.fromCharCode.apply(null,e.subarray(d,
d+=p))]);break;case 4:t=new b.b("InstrumentName",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 5:t=new b.b("Lyrics",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 6:t=new b.b("Marker",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 7:t=new b.b("CuePoint",g,f,[String.fromCharCode.apply(null,e.subarray(d,d+=p))]);break;case 32:t=new b.b("MidiChannelPrefix",g,f,[e[d++]]);break;case 47:t=new b.b("EndOfTrack",g,f,[]);break;case 81:t=new b.b("SetTempo",
g,f,[e[d++]<<16|e[d++]<<8|e[d++]]);break;case 84:t=new b.b("SmpteOffset",g,f,[e[d++],e[d++],e[d++],e[d++],e[d++]]);break;case 88:t=new b.b("TimeSignature",g,f,[e[d++],e[d++],e[d++],e[d++]]);break;case 89:t=new b.b("KeySignature",g,f,[e[d++],e[d++]]);break;case 127:t=new b.b("SequencerSpecific",g,f,[e.subarray(d,d+=p)]);break;default:t=new b.b("Unknown",g,f,[r,e.subarray(d,d+=p)])}break;default:console.warn("unknown message:",h.toString(16))}break;default:throw Error("invalid status");}g=d-v;v=e.subarray(v,
v+g);v[0]=h;t instanceof b.a&&"NoteOn"===t.subtype&&0===t.parameter2&&(t.subtype=c[8],v=new Uint8Array([128|t.channel,t.parameter1,t.parameter2]));n.push(v);a.push(t)}this.tracks.push(a);this.plainTracks.push(n)}}},function(u,n){function l(b,c){var k=[],d="";"string"===typeof c?c={section:c,whitespace:!1}:(c=c||{},c.whitespace=!0===c.whitespace);var p=c.whitespace?" = ":"=";Object.keys(b).forEach(function(c,g,f){(g=b[c])&&Array.isArray(g)?g.forEach(function(b){d+=a(c+"[]")+p+a(b)+"\n"}):g&&"object"===
typeof g?k.push(c):d+=a(c)+p+a(g)+e});c.section&&d.length&&(d="["+a(c.section)+"]"+e+d);k.forEach(function(a,k,g){k=h(a).join("\\.");a=l(b[a],{section:(c.section?c.section+".":"")+k,whitespace:c.whitespace});d.length&&a.length&&(d+=e);d+=a});return d}function h(a){return a.replace(/\1/g,"\u0002LITERAL\\1LITERAL\u0002").replace(/\\\./g,"\u0001").split(/\./).map(function(a){return a.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"\u0001")})}function b(a){return'"'===a.charAt(0)&&'"'===a.slice(-1)||
"'"===a.charAt(0)&&"'"===a.slice(-1)}function a(a){return"string"!==typeof a||a.match(/[=\r\n]/)||a.match(/^\[/)||1<a.length&&b(a)||a!==a.trim()?JSON.stringify(a):a.replace(/;/g,"\\;").replace(/#/g,"\\#")}function c(a,c){a=(a||"").trim();if(b(a)){"'"===a.charAt(0)&&(a=a.substr(1,a.length-2));try{a=JSON.parse(a)}catch(q){}}else{c=!1;for(var k="",d=0,e=a.length;d<e;d++){var m=a.charAt(d);if(c)k=-1!=="\\;#".indexOf(m)?k+m:k+("\\"+m),c=!1;else if(-1!==";#".indexOf(m))break;else"\\"===m?c=!0:k+=m}c&&(k+=
"\\");return k.trim()}return a}n.parse=n.decode=function(a){var b={},d=b,e=null,p=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;a.split(/[\r\n]+/g).forEach(function(a,k,g){if(a&&!a.match(/^\s*[;#]/)&&(k=a.match(p)))if(void 0!==k[1])e=c(k[1]),d=b[e]=b[e]||{};else{a=c(k[2]);k=k[3]?c(k[4]):!0;switch(k){case "true":case "false":case "null":k=JSON.parse(k)}2<a.length&&"[]"===a.slice(-2)&&(a=a.substring(0,a.length-2),d[a]?Array.isArray(d[a])||(d[a]=[d[a]]):d[a]=[]);Array.isArray(d[a])?d[a].push(k):d[a]=k}});Object.keys(b).filter(function(a,
c,k){if(!b[a]||"object"!==typeof b[a]||Array.isArray(b[a]))return!1;c=h(a);var d=b;k=c.pop();var g=k.replace(/\\\./g,".");c.forEach(function(a,b,c){d[a]&&"object"===typeof d[a]||(d[a]={});d=d[a]});if(d===b&&g===k)return!1;d[g]=b[a];return!0}).forEach(function(a,c,k){delete b[a]});return b};n.stringify=n.encode=l;n.safe=a;n.unsafe=c;var e="undefined"!==typeof process&&"win32"===process.platform?"\r\n":"\n"},function(u,n,l){l.d(n,"a",function(){return h});class h{constructor(b,a={}){this.input=b;this.ip=
a.index||0;this.timeDivision=a.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const b=this.input;let a=this.ip;const c=this.header={},e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("melo"!==e)throw Error("invalid MFi signature:"+e);c.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;c.trackOffset=(b[a++]<<16|b[a++])+a;c.dataMajorType=b[a++];c.dataMinorType=b[a++];c.numberOfTracks=b[a++];this.ip=a}parseDataInformation(){const b=
this.input;let a=this.ip;const c=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let e,d;for(;a<this.header.trackOffset;)switch(e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),d=b[a++]<<8|b[a++],e){case "titl":case "copy":case "vers":case "date":case "prot":c[e]=String.fromCharCode.apply(null,b.subarray(a,a+=d));break;case "sorc":c[e]=b[a++];break;case "note":c[e]=b[a++]<<8|b[a++];break;case "exst":break;default:c[e]=b.subarray(a,
a+=d)}this.ip=a}parseTracks(){const b=this.input;let a=this.ip;let c;const e=this.tracks=[];let d,k,g;const r=()=>{var c=b[a++]<<8|b[a++];c=a+c;const k=[];let d;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;)d={},d.part=b[a++]>>4&3,d.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},d.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>
3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},d.octaveSelect=b[a++]&3,k.push(d);return k},p=()=>{var c=b[a++]<<8|b[a++];c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}};k=0;for(g=this.header.numberOfTracks;k<g;++k){var m=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==m)throw Error("invalid track signature:"+m);m=b[a++]<<
24|b[a++]<<16|b[a++]<<8|b[a++];m=a+m;for(d=e[k]=[];a<m;){c={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};c.deltaTime=deltaTime=b[a++];var q=b[a++];if(255!==q)c.type="note",c.subType="Note",c.voice=q>>6,c.key=q&63,noteLength=c.length=b[a++],1===this.dataInformation.note&&(q=b[a++],c.velocity=q>>2,c.octaveShift=q&3);else switch(c.type="meta",q=b[a++],q>>4){case 11:switch(q&15){case 0:c.subType="MasterVolume";c.value=b[a++];break;case 10:c.subType="DrumScale";
c.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+q.toString(16));}break;case 12:c.subType="SetTempo";c.value={timeBase:7===(q&7)?NaN:Math.pow(2,q&7)*(0===(q&8)?6:15),tempo:b[a++]};break;case 13:switch(q&15){case 0:c.subType="Point";c.value=b[a++];break;case 13:c.subType="Loop";c.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:c.subType="Nop";c.value=b[a++];break;case 15:c.subType="EndOfTrack";c.value=b[a++];break;default:throw Error("unkwnon message type:"+
q.toString(16));}break;case 14:switch(q&15){case 0:c.subType="InstrumentLowPart";c.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:c.subType="InstrumentHighPart";c.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:c.subType="Volume";c.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:c.subType="Valance";c.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:c.subType="PitchBend";c.value={part:b[a]>>6,value:b[a++]&63};break;case 5:c.subType="ChannelAssign";c.value={part:b[a]>>6,channel:b[a++]&
63};break;case 6:c.subType="VolumeChange";c.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:c.subType="PitchBendRange";c.value={part:b[a]>>6,value:b[a++]&63};break;case 8:case 9:c.subType="MasterCoarseTuning";c.value={part:b[a]>>6,value:b[a++]&63};break;case 10:c.subType="Modulation";c.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+q.toString(16));}break;case 15:switch(q&15){case 0:c.subType="EditInstrument";c.value=r();break;case 1:c.subType="Vibrato";
q=c;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var f={part:b[a++]>>5&3,"switch":b[a++]>>6};q.value=f;break;case 15:c.subType="DeviceSpecific";c.value=p();break;default:throw Error("unkwnon message type:"+q.toString(16));}break;default:throw Error("unkwnon message type:"+q.toString(16));}d.push(c)}a=m}this.ip=a}convertToMidiTracks(){const b=[],a=this.tracks;let c;let e,d,k,g,r,p,m;const q=[];for(g=0;16>g;++g)b[g]=[],q[g]=0;g=0;for(r=a.length;g<r;++g){var f=a[g];e=[];d=k=p=0;for(m=
f.length;p<m;++p)switch(c=f[p],d+=c.deltaTime,c.id=k,c.time=d,c.subType){case "Nop":break;case "Note":e[k++]=c;e[k]={id:k,type:"internal",subType:"NoteOff",time:d+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};k++;break;case "InstrumentHighPart":var h=c;c=f[++p];if("InstrumentLowPart"!==c.subType)throw Error("broken instrument");e[k]={id:k,type:"internal",subType:"ProgramChange",time:d,part:c.value.part,instrument:h.value.instrument<<6|c.value.instrument};k++;break;
default:e[k++]=c}e.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0);d=p=0;for(m=e.length;p<m;++p){c=e[p];d=c.time;switch(c.subType){case "Note":h=this.applyOctaveShift(c.key+45,c.octaveShift);f=4*g+c.voice;9===f&&(h-=10);b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(144|f,h,2*c.velocity));break;case "NoteOff":h=this.applyOctaveShift(c.key+45,c.octaveShift);f=4*g+c.voice;9===f&&(h-=10);b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(128|f,h,2*c.velocity));break;case "ProgramChange":f=
4*g+c.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(192|f,c.instrument));break;case "SetTempo":h=288E7/(c.value.tempo*c.value.timeBase);f=0;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(255,81,3,h>>16&255,h>>8&255,h&255));break;case "Loop":h=c.value.count;h="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===h?-1:h);f=0;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat([255,6,h.length],h.split("").map(a=>a.charCodeAt(0))));break;case "MasterVolume":h=c.value;
f=0;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(240,7,127,127,4,1,h,h,247));break;case "Modulation":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(176|f,1,2*c.value.depth));break;case "Volume":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(176|f,7,2*c.value.volume));break;case "Valance":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(176|f,10,2*(c.value.valance-32)+64));break;case "PitchBend":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-
q[f]).concat(224|f,2*c.value.value,2*c.value.value));break;case "PitchBendRange":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(176|f,100,0),[0,176|f,101,0],[0,176|f,6,2*c.value.value]);break;case "MasterCoarseTuning":f=4*g+c.value.part;b[f].push(this.deltaTimeToByteArray(d-q[f]).concat(176|f,100,0),[0,176|f,101,2],[0,176|f,6,2*c.value.value]);break;default:continue}q[f]=c.time}}return this.toSMF(b)}applyOctaveShift(b,a){const c=[0,12,-24,-12];if(void 0!==c[a])return b+c[a];
throw Error("invalid OctaveShift value:"+a);}toSMF(b){var a;let c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let e;if(void 0!==this.dataInformation.copy){var d=this.dataInformation.copy;var k=d.length;var g=Array(k);for(a=0;a<k;++a)g[a]=d.charCodeAt(a);a=d=g;d=a.length;a=[0,255,2].concat(this.deltaTimeToByteArray(d),a);b[0].unshift(a)}k=0;for(d=b.length;k<d;++k){const d=b[k];a=[];g=0;for(e=d.length;g<e;++g)Array.prototype.push.apply(a,d[g]);e=a.length;g=[77,84,114,107,e>>24&255,e>>16&255,e>>8&255,e&255];
c=c.concat(g,a)}return new Uint8Array(c)}deltaTimeToByteArray(b){const a=[];for(;128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a}}},function(u,n,l){l.d(n,"a",function(){return a});var h=l(1);u=l(2);var b=l(0);class a extends u.a{constructor(a,b={}){super(a,b);this.input=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(a)),"text/xml").querySelectorAll("ms2 > *");this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=
b.timeDivision||96}parse(){this.parseTracks();this.toPlainTrack();console.log(this)}parseTracks(){let a=[];const e=[];for(let b=0;b<this.input.length;b++){const c=new h.a({timeDivision:this.timeDivision,channel:0,mml:this.input[b].textContent.trim()});a=a.concat(c.events);e.push(c.endTime)}a.concat(new b.b("EndOfTrack",0,Math.max(e)));this.tracks.push(a)}}},function(u,n,l){l.d(n,"a",function(){return c});var h=l(1);u=l(5);var b=l.n(u),a=l(0);l=l(2);class c extends l.a{constructor(a,c={}){super(a,
c);a=String.fromCharCode.apply("",new Uint16Array(a));this.input=b.a.parse(a);this.tracks=[];this.dataInformation=[];this.plainTracks=[]}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack();console.log(this)}parseHeader(){const a=this.input.Settings;this.title=a.Title;this.author=a.Source;this.TimeBase=parseInt(a.TimeBase);delete this.input["3MLE EXTENSION"];delete this.input.Settings}parseTracks(){const b=this.input;let c=[];const k=[];let g=0;for(const d in b)if(b.hasOwnProperty(d)){const e=
[b[d].ch0_mml,b[d].ch1_mml,b[d].ch2_mml];c.push(new a.a("ProgramChange",0,96,g,parseInt(b[d].instrument)));c.push(new a.a("ControlChange",0,154,g,parseInt(b[d].panpot)));for(let a=0;a<e.length;a++){const b=new h.a({timeDivision:this.timeDivision,channel:g,timeOffset:386,mml:e[a]});c=c.concat(b.events);k.push(b.endTime)}c.concat(new a.b("EndOfTrack",0,Math.max(k)));this.tracks.push(c);g++}}toPlainTrack(){const b=[];console.log(this.tracks);for(let c=0;c<this.tracks.length;c++){const k=this.tracks[c];
for(let c=0;c<k.length;c++){const d=k[c];let g;if(d instanceof a.a)switch(d.subtype){case "NoteOn":g=0===d.parameter2?new Uint8Array([128|d.channel,d.parameter1,d.parameter2]):new Uint8Array([144|d.channel,d.parameter1,d.parameter2]);break;case "NoteOff":g=new Uint8Array([128|d.channel,d.parameter1,d.parameter2]);break;case "ControlChange":g=new Uint8Array([11|d.channel,d.parameter1,d.parameter2]);break;case "ProgramChange":g=new Uint8Array([12|d.channel,d.parameter1,d.parameter2])}else if(d instanceof
a.b)switch(d.subtype){case "SetTempo":g=new Uint8Array([255,81,3,7,161,32])}b.push(g)}}this.plainTracks.push(b)}}},function(u,n,l){l.r(n);l.d(n,"Player",function(){return d});var h=l(4),b=l(6),a=l(7),c=l(2),e=l(8);class d{constructor(a="#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=[];this.timer=0;this.sequence={};this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=!1;this.tempoRate=1;this.masterVolume=16383;this.sequenceName="";this.copyright=
[];this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a)}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(a=0;16>a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();
this.initSequence();this.pause=!0;this.track=null;this.resume=-1;this.copyright=this.sequenceName=this.sequence=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",b=>{"link,ready"===b.data&&a.sendInitMessage()},!1)}initSequence(){this.tempo=5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");
this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px",a.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=
0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+",06,02","*"),a.postMessage("midi,b"+b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,c=a=>{"string"===
typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);this.target.firstChild&&this.target.removeChild(this.target.firstChild);const b=this.webMidiLink=this.window.document.createElement("iframe");b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",
c,!1);const d=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",d,!1);let k=0;this.window.addEventListener("resize",()=>{0<k&&clearTimeout(k);k=setTimeout(d,100)},!1)}else this.webMidiLink.addEventListener("message",c,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),
"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,d=this.webMidiLink.contentWindow;let e=this.position||0;const h=[],f=()=>{const k=c[e].time,g=c.length;let p,l=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{var m=c[e].event;"SetTempo"===m.subtype&&(a.tempo=m.data[0]);"ControlChange"===m.subtype&&111===m.parameter1&&(h[0]={pos:e});if("Marker"===m.subtype&&("A"===m.data[0]&&(h[0]={pos:e}),"B"===m.data[0]&&a.enableFalcomLoop&&h[0]&&
"number"===typeof h[0].pos)){e=h[0].pos;a.timer=a.window.setTimeout(f,0);a.position=e;return}if("Marker"===m.subtype&&(m=m.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===m[1])h[m[2]|0]=h[m[2]]||{pos:e,count:m[3]|0};else if("END"===m[1]&&a.enableMFiLoop){p=h[m[2]|0];if(0!==p.count){0<p.count&&p.count--;e=p.pos;a.timer=a.window.setTimeout(f,0);a.position=e;return}h[m[2]|0]=null}d.postMessage(c[e++].webMidiLink,"*")}while(e<g&&c[e].time===k);e<g?(l=Date.now()-l,a.timer=a.window.setTimeout(f,
a.tempo/(1E3*b)*(c[e].time-k-l)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&h[0]&&"number"===typeof h[0].pos?e=h[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=e;a.time=k}};this.pause?(this.timer=a.window.setTimeout(f,this.resume),this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(f,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=new h["default"](a);this.init();a.parse();console.log(a);this.mergeMidiTracks(a)}loadMldFile(a){a=new b.a(a);this.init();
a.parse();this.mergeMidiTracks(a.convertToMidiTracks())}loadMs2MmlFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b)}loadMakiMabiSequenceFile(a){a=new c.a(a);this.init();a.parse();this.mergeMidiTracks(a)}load3MleFile(a){a=new e.a(a);this.init();a.parse();this.mergeMidiTracks(a)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var d=Array(c.length);const e=a.plainTracks,h=this.copyright=[];let f,k,l,n;f=0;for(k=c.length;f<k;++f)d[f]=0;f=0;for(k=c.length;f<k;++f)for(d=c[f],l=0,n=
d.length;l<n;++l)0===a.formatType&&"SequenceTrackName"===d[l].subtype&&(this.sequenceName=d[l].data[0]),"CopyrightNotice"===d[l].subtype&&h.push(d[l].data[0]),b.push({track:f,eventId:l,time:d[l].time,event:d[l],webMidiLink:"midi,"+Array.prototype.map.call(e[f][l],a=>a.toString(16)).join(",")});b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getPosition(){return this.position}setPosition(a){this.position=
a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(a){a*=this.tempo/6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
