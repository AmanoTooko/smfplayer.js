(function(){/*
 2007-2013,2018,2019 Logue <http://logue.be/> All rights reserved.
 @license MIT
 2019 Logue <http://logue.be/> All rights reserved.
 @license MIT
 @logue/smfplayer v0.2.3 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(u,l){"object"===typeof exports&&"object"===typeof module?module.exports=l():"function"===typeof define&&define.amd?define("SMF",[],l):"object"===typeof exports?exports.SMF=l():u.SMF=l()})("undefined"!==typeof self?self:this,function(){return function(u){function l(h){if(p[h])return p[h].exports;var b=p[h]={i:h,l:!1,exports:{}};u[h].call(b.exports,b,b.exports,l);b.l=!0;return b.exports}var p={};l.m=u;l.c=p;l.d=function(h,b,a){l.o(h,b)||Object.defineProperty(h,b,{enumerable:!0,
get:a})};l.r=function(h){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(h,Symbol.toStringTag,{value:"Module"});Object.defineProperty(h,"__esModule",{value:!0})};l.t=function(h,b){b&1&&(h=l(h));if(b&8||b&4&&"object"===typeof h&&h&&h.__esModule)return h;var a=Object.create(null);l.r(a);Object.defineProperty(a,"default",{enumerable:!0,value:h});if(b&2&&"string"!=typeof h)for(var c in h)l.d(a,c,function(a){return h[a]}.bind(null,c));return a};l.n=function(h){var b=h&&h.__esModule?
function(){return h["default"]}:function(){return h};l.d(b,"a",b);return b};l.o=function(h,b){return Object.prototype.hasOwnProperty.call(h,b)};l.p="";return l(l.s=8)}([function(u,l,p){p.d(l,"a",function(){return b});p.d(l,"c",function(){return a});p.d(l,"b",function(){return c});class h{constructor(a,d,c){this.subtype=a;this.deltaTime=d;this.time=c}}class b extends h{constructor(a,d,c,b,r,m){super(a,d,c);this.channel=b;this.parameter1=r;this.parameter2=m}}class a extends h{constructor(a,d,c,b){super(a,
d,c);this.data=b}}class c extends h{constructor(a,d,c,b){super(a,d,c);this.data=b}}},function(u,l,p){p.d(l,"a",function(){return h});class h{constructor(a,c={}){this.input=a;this.ip=c.index||0;this.length=c.length||a.length-this.ip;this.offset=this.ip;this.padding=void 0!==c.padding?c.padding:!0;this.bigEndian=void 0!==c.bigEndian?c.bigEndian:!1}parse(){const a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()}parseChunk(){var a=this.input;let c=this.ip;this.chunkList.push(new b(String.fromCharCode(a[c++],
a[c++],a[c++],a[c++]),a=this.bigEndian?(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0:(a[c++]|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,c));c+=a;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}getChunk(a){a=this.chunkList[a];return void 0===a?null:a}getNumberOfChunks(){return this.chunkList.length}}class b{constructor(a,c,b){this.type=a;this.size=c;this.offset=b}}},function(u,l,p){p.r(l);p.d(l,"default",function(){return a});var h=p(1),b=p(0);class a{constructor(a,b={}){b.padding=!1;b.bigEndian=!0;this.input=
a;this.ip=b.index||0;this.chunkIndex=0;this.riffParser_=new h.a(a,b);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[]}parse(){let a,b;this.riffParser_.parse();this.parseHeaderChunk();a=0;for(b=this.numberOfTracks;a<b;++a)this.parseTrackChunk()}parseHeaderChunk(){const a=this.riffParser_.getChunk(this.chunkIndex++),b=this.input;let d=a.offset;if(!a||"MThd"!==a.type)throw Error("invalid header signature");this.formatType=b[d++]<<8|b[d++];this.numberOfTracks=
b[d++]<<8|b[d++];this.timeDivision=b[d++]<<8|b[d++]}parseTrackChunk(){var a=this.riffParser_.getChunk(this.chunkIndex++);const f=this.input;let d=a.offset,e=0;var k=0;let r=0;var m=0;let n=-1,q=-1,g=m=0;var v=0;let h=k=0,t;const l=()=>{let a=0,b;do b=f[d++],a=a<<7|b&127;while(0!==(b&128));return a};if(!a||"MTrk"!==a.type)throw Error("invalid header signature");e=a.offset+a.size;a=[];const p=[];for(;d<e;){k=l();g+=k;v=d;h=f[d++];r=h>>4&15;m=h&15;8>r?(r=n,m=q,h=n<<4|q,d--,v--):(n=r,q=m);const c=[,,
,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(r){case 8:case 9:case 10:case 11:case 13:case 14:t=new b.a(c[r],k,g,m,f[d++],f[d++]);break;case 12:t=new b.a(c[r],k,g,m,f[d++]);break;case 15:switch(m){case 0:m=l();if(247!==f[d+m-1])throw Error("invalid SysEx event");t=new b.c("SystemExclusive",k,g,f.subarray(d,(d+=m)-1));break;case 7:m=l();t=new b.c("SystemExclusive(F7)",k,g,f.subarray(d,d+=m));break;case 15:r=f[d++];m=l();switch(r){case 0:t=
new b.b("SequenceNumber",k,g,[f[d++],f[d++]]);break;case 1:t=new b.b("TextEvent",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 2:t=new b.b("CopyrightNotice",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 3:t=new b.b("SequenceTrackName",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 4:t=new b.b("InstrumentName",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 5:t=new b.b("Lyrics",k,g,[String.fromCharCode.apply(null,
f.subarray(d,d+=m))]);break;case 6:t=new b.b("Marker",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 7:t=new b.b("CuePoint",k,g,[String.fromCharCode.apply(null,f.subarray(d,d+=m))]);break;case 32:t=new b.b("MidiChannelPrefix",k,g,[f[d++]]);break;case 47:t=new b.b("EndOfTrack",k,g,[]);break;case 81:t=new b.b("SetTempo",k,g,[f[d++]<<16|f[d++]<<8|f[d++]]);break;case 84:t=new b.b("SmpteOffset",k,g,[f[d++],f[d++],f[d++],f[d++],f[d++]]);break;case 88:t=new b.b("TimeSignature",k,g,
[f[d++],f[d++],f[d++],f[d++]]);break;case 89:t=new b.b("KeySignature",k,g,[f[d++],f[d++]]);break;case 127:t=new b.b("SequencerSpecific",k,g,[f.subarray(d,d+=m)]);break;default:t=new b.b("Unknown",k,g,[r,f.subarray(d,d+=m)])}break;default:console.warn("unknown message:",h.toString(16))}break;default:throw Error("invalid status");}k=d-v;v=f.subarray(v,v+k);v[0]=h;t instanceof b.a&&"NoteOn"===t.subtype&&0===t.parameter2&&(t.subtype=c[8],v=new Uint8Array([128|t.channel,t.parameter1,t.parameter2]));p.push(v);
a.push(t)}this.tracks.push(a);this.plainTracks.push(p)}}},function(u,l,p){p.d(l,"a",function(){return h});class h{constructor(b,a={}){this.input=b;this.ip=a.index||0;this.timeDivision=a.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const b=this.input;let a=this.ip;const c=this.header={},f=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("melo"!==f)throw Error("invalid MFi signature:"+f);c.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>
0;c.trackOffset=(b[a++]<<16|b[a++])+a;c.dataMajorType=b[a++];c.dataMinorType=b[a++];c.numberOfTracks=b[a++];this.ip=a}parseDataInformation(){const b=this.input;let a=this.ip;const c=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let f,d;for(;a<this.header.trackOffset;)switch(f=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),d=b[a++]<<8|b[a++],f){case "titl":case "copy":case "vers":case "date":case "prot":c[f]=String.fromCharCode.apply(null,
b.subarray(a,a+=d));break;case "sorc":c[f]=b[a++];break;case "note":c[f]=b[a++]<<8|b[a++];break;case "exst":break;default:c[f]=b.subarray(a,a+=d)}this.ip=a}parseTracks(){const b=this.input;let a=this.ip;let c;const f=this.tracks=[];let d,e,k;const r=()=>{var d=b[a++]<<8|b[a++];d=a+d;const c=[];let e;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<d;)e={},e.part=b[a++]>>4&3,e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>
4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.octaveSelect=b[a++]&3,c.push(e);return c},m=()=>{var d=b[a++]<<8|b[a++];d=a+d;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=d-a)}};e=0;for(k=this.header.numberOfTracks;e<
k;++e){var n=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==n)throw Error("invalid track signature:"+n);n=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];n=a+n;for(d=f[e]=[];a<n;){c={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};c.deltaTime=deltaTime=b[a++];var q=b[a++];if(255!==q)c.type="note",c.subType="Note",c.voice=q>>6,c.key=q&63,noteLength=c.length=b[a++],1===this.dataInformation.note&&(q=b[a++],c.velocity=q>>2,c.octaveShift=q&3);else switch(c.type=
"meta",q=b[a++],q>>4){case 11:switch(q&15){case 0:c.subType="MasterVolume";c.value=b[a++];break;case 10:c.subType="DrumScale";c.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+q.toString(16));}break;case 12:c.subType="SetTempo";c.value={timeBase:7===(q&7)?NaN:Math.pow(2,q&7)*(0===(q&8)?6:15),tempo:b[a++]};break;case 13:switch(q&15){case 0:c.subType="Point";c.value=b[a++];break;case 13:c.subType="Loop";c.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;
case 14:c.subType="Nop";c.value=b[a++];break;case 15:c.subType="EndOfTrack";c.value=b[a++];break;default:throw Error("unkwnon message type:"+q.toString(16));}break;case 14:switch(q&15){case 0:c.subType="InstrumentLowPart";c.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:c.subType="InstrumentHighPart";c.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:c.subType="Volume";c.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:c.subType="Valance";c.value={part:b[a]>>6,valance:b[a++]&63};break;
case 4:c.subType="PitchBend";c.value={part:b[a]>>6,value:b[a++]&63};break;case 5:c.subType="ChannelAssign";c.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:c.subType="VolumeChange";c.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:c.subType="PitchBendRange";c.value={part:b[a]>>6,value:b[a++]&63};break;case 8:case 9:c.subType="MasterCoarseTuning";c.value={part:b[a]>>6,value:b[a++]&63};break;case 10:c.subType="Modulation";c.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+
q.toString(16));}break;case 15:switch(q&15){case 0:c.subType="EditInstrument";c.value=r();break;case 1:c.subType="Vibrato";q=c;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var g={part:b[a++]>>5&3,"switch":b[a++]>>6};q.value=g;break;case 15:c.subType="DeviceSpecific";c.value=m();break;default:throw Error("unkwnon message type:"+q.toString(16));}break;default:throw Error("unkwnon message type:"+q.toString(16));}d.push(c)}a=n}this.ip=a}convertToMidiTracks(){const b=[],a=this.tracks;
let c;let f,d,e,k,r,m,n;const q=[];for(k=0;16>k;++k)b[k]=[],q[k]=0;k=0;for(r=a.length;k<r;++k){var g=a[k];f=[];d=e=m=0;for(n=g.length;m<n;++m)switch(c=g[m],d+=c.deltaTime,c.id=e,c.time=d,c.subType){case "Nop":break;case "Note":f[e++]=c;f[e]={id:e,type:"internal",subType:"NoteOff",time:d+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};e++;break;case "InstrumentHighPart":var h=c;c=g[++m];if("InstrumentLowPart"!==c.subType)throw Error("broken instrument");f[e]={id:e,type:"internal",
subType:"ProgramChange",time:d,part:c.value.part,instrument:h.value.instrument<<6|c.value.instrument};e++;break;default:f[e++]=c}f.sort((d,a)=>d.time>a.time?1:d.time<a.time?-1:d.id>a.id?1:d.id<a.id?-1:0);d=m=0;for(n=f.length;m<n;++m){c=f[m];d=c.time;switch(c.subType){case "Note":h=this.applyOctaveShift(c.key+45,c.octaveShift);g=4*k+c.voice;9===g&&(h-=10);b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(144|g,h,2*c.velocity));break;case "NoteOff":h=this.applyOctaveShift(c.key+45,c.octaveShift);g=
4*k+c.voice;9===g&&(h-=10);b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(128|g,h,2*c.velocity));break;case "ProgramChange":g=4*k+c.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(192|g,c.instrument));break;case "SetTempo":h=288E7/(c.value.tempo*c.value.timeBase);g=0;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(255,81,3,h>>16&255,h>>8&255,h&255));break;case "Loop":h=c.value.count;h="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===h?-1:h);g=0;b[g].push(this.deltaTimeToByteArray(d-
q[g]).concat([255,6,h.length],h.split("").map(d=>d.charCodeAt(0))));break;case "MasterVolume":h=c.value;g=0;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(240,7,127,127,4,1,h,h,247));break;case "Modulation":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(176|g,1,2*c.value.depth));break;case "Volume":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(176|g,7,2*c.value.volume));break;case "Valance":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-
q[g]).concat(176|g,10,2*(c.value.valance-32)+64));break;case "PitchBend":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(224|g,2*c.value.value,2*c.value.value));break;case "PitchBendRange":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(176|g,100,0),[0,176|g,101,0],[0,176|g,6,2*c.value.value]);break;case "MasterCoarseTuning":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-q[g]).concat(176|g,100,0),[0,176|g,101,2],[0,176|g,6,2*c.value.value]);break;
default:continue}q[g]=c.time}}return this.toSMF(b)}applyOctaveShift(b,a){const c=[0,12,-24,-12];if(void 0!==c[a])return b+c[a];throw Error("invalid OctaveShift value:"+a);}toSMF(b){var a;let c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let f;if(void 0!==this.dataInformation.copy){var d=this.dataInformation.copy;var e=d.length;var k=Array(e);for(a=0;a<e;++a)k[a]=d.charCodeAt(a);a=d=k;d=a.length;a=[0,255,2].concat(this.deltaTimeToByteArray(d),a);b[0].unshift(a)}e=0;for(d=b.length;e<d;++e){const d=b[e];a=
[];k=0;for(f=d.length;k<f;++k)Array.prototype.push.apply(a,d[k]);f=a.length;k=[77,84,114,107,f>>24&255,f>>16&255,f>>8&255,f&255];c=c.concat(k,a)}return new Uint8Array(c)}deltaTimeToByteArray(b){const a=[];for(;128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a}}},function(u,l,p){p.d(l,"a",function(){return b});var h=p(0);class b{constructor(a={}){this.timeDivision=parseInt(a.timeDivision)||96;this.channel=parseInt(a.channel)||0;this.timeOffset=parseInt(a.timeOffset)||
0;this.PATTERN=/[A-GLNORTV<>][\+#-]?[0-9]*\.?&?/ig;this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};this.MINIM=2*this.timeDivision;this.SEMIBREVE=4*this.timeDivision;this.mml=a.mml.match(this.PATTERN);this.events=[];this.plainEvents=[];this.endTime=0;this.parse()}parse(){const a=this.mml;let b=this.timeOffset,f=this.timeDivision,d=0,e=!1,k=8,r=4;const m=[];for(const c in a)if(a.hasOwnProperty(c)){let g=f;if(a[c].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i)){var n=parseInt(RegExp.$2);1==e&&"&"!==RegExp.$4&&
(e=!1,m.push(new h.a("NoteOff",0,b,this.channel,d)));switch(RegExp.$1){case "L":case "l":1<=n&&n<=this.MINIM&&(f=Math.floor(this.SEMIBREVE/n),"."==RegExp.$3&&(f=Math.floor(1.5*f)));break;case "O":case "o":0<=n&&8>=n&&(r=n);break;case "T":case "t":m.push(new h.b("SetTempo",0,b,[Math.floor(6E7/n)]));break;case "V":case "v":0<=n&&15>=n&&(k=n);break;case "<":r=0>=r?0:r-1;break;case ">":r=8<=r?8:r+1}}else a[c].match(/([A-GN])([\+#-]?)([0-9]*)(\.?)(&?)/i)?(n=parseInt(RegExp.$3,10),"n"!==RegExp.$1&&"N"!==
RegExp.$1&&(1<=n&&n<=this.MINIM&&(g=Math.floor(this.SEMIBREVE/n)),"."===RegExp.$4&&(g=Math.floor(1.5*g)),n=12*r+this.NOTE_TABLE[RegExp.$1.toLowerCase()],"+"===RegExp.$2||"#"===RegExp.$2?n++:"-"===RegExp.$2&&n--),n+=12,0==e&&m.push(new h.a("NoteOn",0,b,this.channel,n,8*k)),1==e&&n!==d&&m.push(new h.a("NoteOff",0,b,this.channel,d)),b+=g,"&"===RegExp.$5?(e=!0,d=n):(e=!1,m.push(new h.a("NoteOff",-1,b,this.channel,n)))):a[c].match(/[rR]([0-9]*)(\.?)/)?(n=parseInt(RegExp.$1,10),1<=n&&n<=this.MINIM&&(g=
Math.floor(this.SEMIBREVE/n)),"."==RegExp.$2&&(g=Math.floor(1.5*g)),b+=g):console.warn("unknown signeture.",a[c]);1==e&&(e=!1,m.push(new h.a("NoteOff",0,b,this.channel,d)))}this.events=m;this.endTime=b}}},function(u,l,p){p.d(l,"a",function(){return c});var h=p(4);u=p(3);l=p(7);var b=p.n(l),a=p(0);class c extends u.a{constructor(a,d={}){super(a,d);a=String.fromCharCode.apply("",new Uint16Array(a));this.input=b.a.parse(a);this.tracks=[];this.dataInformation=[];this.plainTracks=[]}parse(){this.parseHeader();
this.parseTracks();this.toPlainTrack();console.log(this)}parseHeader(){const a=this.input.infomation;this.title=a.title;this.author=a.auther;this.timeDivision=parseInt(a.timeBase);delete this.input.infomation;delete this.input["mms-file"]}parseTracks(){const b=this.input;let d=[];const c=[];let k=0;for(const e in b)if(b.hasOwnProperty(e)){const r=[b[e].ch0_mml,b[e].ch1_mml,b[e].ch2_mml];d.push(new a.a("ProgramChange",0,96,k,parseInt(b[e].instrument)));d.push(new a.a("ControlChange",0,154,k,parseInt(b[e].panpot)));
for(let a=0;a<r.length;a++){const b=new h.a({timeDivision:this.timeDivision,channel:k,timeOffset:386,mml:r[a]});d=d.concat(b.events);c.push(b.endTime)}d.concat(new a.b("EndOfTrack",0,Math.max(c)));this.tracks.push(d);k++}}toPlainTrack(){const b=[];console.log(this.tracks);for(let d=0;d<this.tracks.length;d++){const c=this.tracks[d];for(let d=0;d<c.length;d++){const e=c[d];let k;if(e instanceof a.a)switch(e.subtype){case "NoteOn":k=0===e.parameter2?new Uint8Array([128|e.channel,e.parameter1,e.parameter2]):
new Uint8Array([144|e.channel,e.parameter1,e.parameter2]);break;case "NoteOff":k=new Uint8Array([128|e.channel,e.parameter1,e.parameter2]);break;case "ControlChange":k=new Uint8Array([11|e.channel,e.parameter1,e.parameter2]);break;case "ProgramChange":k=new Uint8Array([12|e.channel,e.parameter1,e.parameter2])}else if(e instanceof a.b)switch(e.subtype){case "SetTempo":k=new Uint8Array([255,81,3,7,161,32])}b.push(k)}}this.plainTracks.push(b)}}},function(u,l,p){p.d(l,"a",function(){return a});var h=
p(4);u=p(5);var b=p(0);class a extends u.a{constructor(a,b={}){super(a,b);this.input=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(a)),"text/xml").querySelectorAll("ms2 > *");this.timeDivision=b.timeDivision||96;this.tracks=[];this.plainTracks=[];this.dataInformation=[]}parse(){this.parseTracks();this.toPlainTrack();console.log(this)}parseTracks(){let a=[];const f=[];for(let d=0;d<this.input.length;d++){const b=new h.a({timeDivision:this.timeDivision,channel:0,mml:this.input[d].textContent.trim()});
a=a.concat(b.events);f.push(b.endTime)}a.concat(new b.b("EndOfTrack",0,Math.max(f)));this.tracks.push(a)}}},function(u,l){function p(d,b){var c=[],e="";"string"===typeof b?b={section:b,whitespace:!1}:(b=b||{},b.whitespace=!0===b.whitespace);var m=b.whitespace?" = ":"=";Object.keys(d).forEach(function(b,k,g){(k=d[b])&&Array.isArray(k)?k.forEach(function(d){e+=a(b+"[]")+m+a(d)+"\n"}):k&&"object"===typeof k?c.push(b):e+=a(b)+m+a(k)+f});b.section&&e.length&&(e="["+a(b.section)+"]"+f+e);c.forEach(function(a,
c,k){c=h(a).join("\\.");a=p(d[a],{section:(b.section?b.section+".":"")+c,whitespace:b.whitespace});e.length&&a.length&&(e+=f);e+=a});return e}function h(a){return a.replace(/\1/g,"\u0002LITERAL\\1LITERAL\u0002").replace(/\\\./g,"\u0001").split(/\./).map(function(a){return a.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"\u0001")})}function b(a){return'"'===a.charAt(0)&&'"'===a.slice(-1)||"'"===a.charAt(0)&&"'"===a.slice(-1)}function a(a){return"string"!==typeof a||a.match(/[=\r\n]/)||a.match(/^\[/)||
1<a.length&&b(a)||a!==a.trim()?JSON.stringify(a):a.replace(/;/g,"\\;").replace(/#/g,"\\#")}function c(a,c){a=(a||"").trim();if(b(a)){"'"===a.charAt(0)&&(a=a.substr(1,a.length-2));try{a=JSON.parse(a)}catch(q){}}else{c=!1;for(var d="",e=0,h=a.length;e<h;e++){var n=a.charAt(e);if(c)d=-1!=="\\;#".indexOf(n)?d+n:d+("\\"+n),c=!1;else if(-1!==";#".indexOf(n))break;else"\\"===n?c=!0:d+=n}c&&(d+="\\");return d.trim()}return a}l.parse=l.decode=function(a){var b={},d=b,f=null,m=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;
a.split(/[\r\n]+/g).forEach(function(a,e,g){if(a&&!a.match(/^\s*[;#]/)&&(e=a.match(m)))if(void 0!==e[1])f=c(e[1]),d=b[f]=b[f]||{};else{a=c(e[2]);e=e[3]?c(e[4]):!0;switch(e){case "true":case "false":case "null":e=JSON.parse(e)}2<a.length&&"[]"===a.slice(-2)&&(a=a.substring(0,a.length-2),d[a]?Array.isArray(d[a])||(d[a]=[d[a]]):d[a]=[]);Array.isArray(d[a])?d[a].push(e):d[a]=e}});Object.keys(b).filter(function(a,d,c){if(!b[a]||"object"!==typeof b[a]||Array.isArray(b[a]))return!1;d=h(a);var e=b;c=d.pop();
var g=c.replace(/\\\./g,".");d.forEach(function(a,b,d){e[a]&&"object"===typeof e[a]||(e[a]={});e=e[a]});if(e===b&&g===c)return!1;e[g]=b[a];return!0}).forEach(function(a,d,c){delete b[a]});return b};l.stringify=l.encode=p;l.safe=a;l.unsafe=c;var f="undefined"!==typeof process&&"win32"===process.platform?"\r\n":"\n"},function(u,l,p){p.r(l);p.d(l,"Player",function(){return f});var h=p(2),b=p(3),a=p(6),c=p(5);class f{constructor(a="#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=
[];this.timer=0;this.sequence={};this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=!1;this.tempoRate=1;this.masterVolume=16383;this.sequenceName="";this.copyright=[];this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a)}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=
Date.now();if(this.webMidiLink)for(a=0;16>a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();this.initSequence();this.pause=!0;this.track=null;this.resume=-1;this.copyright=this.sequenceName=this.sequence=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",b=>{"link,ready"===b.data&&
a.sendInitMessage()},!1)}initSequence(){this.tempo=5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+
"px",a.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+
",06,02","*"),a.postMessage("midi,b"+b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,d=a=>{"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);this.target.firstChild&&this.target.removeChild(this.target.firstChild);
const b=this.webMidiLink=this.window.document.createElement("iframe");b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",d,!1);const c=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",c,!1);let e=0;this.window.addEventListener("resize",()=>{0<e&&clearTimeout(e);e=setTimeout(c,100)},!1)}else this.webMidiLink.addEventListener("message",d,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&
this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,h=this.webMidiLink.contentWindow;let f=this.position||0;const n=[],q=()=>{const d=c[f].time,e=c.length;let k,l=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{var m=c[f].event;"SetTempo"===m.subtype&&(a.tempo=m.data[0]);"ControlChange"===
m.subtype&&111===m.parameter1&&(n[0]={pos:f});if("Marker"===m.subtype&&("A"===m.data[0]&&(n[0]={pos:f}),"B"===m.data[0]&&a.enableFalcomLoop&&n[0]&&"number"===typeof n[0].pos)){f=n[0].pos;a.timer=a.window.setTimeout(q,0);a.position=f;return}if("Marker"===m.subtype&&(m=m.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===m[1])n[m[2]|0]=n[m[2]]||{pos:f,count:m[3]|0};else if("END"===m[1]&&a.enableMFiLoop){k=n[m[2]|0];if(0!==k.count){0<k.count&&k.count--;f=k.pos;a.timer=a.window.setTimeout(q,
0);a.position=f;return}n[m[2]|0]=null}h.postMessage(c[f++].webMidiLink,"*")}while(f<e&&c[f].time===d);f<e?(l=Date.now()-l,a.timer=a.window.setTimeout(q,a.tempo/(1E3*b)*(c[f].time-d-l)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&n[0]&&"number"===typeof n[0].pos?f=n[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=f;a.time=d}};this.pause?(this.timer=a.window.setTimeout(q,this.resume),this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(q,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=
new h["default"](a);this.init();a.parse();this.mergeMidiTracks(a)}loadMldFile(a){a=new b.a(a);this.init();a.parse();this.mergeMidiTracks(a.convertToMidiTracks())}loadMs2MmlFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b)}loadMakiMabiSequenceFile(a){a=new c.a(a);this.init();a.parse();this.mergeMidiTracks(a)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var d=Array(c.length);const f=a.plainTracks,h=this.copyright=[];let l,g,p,u;l=0;for(g=c.length;l<g;++l)d[l]=0;l=0;for(g=c.length;l<
g;++l)for(d=c[l],p=0,u=d.length;p<u;++p)0===a.formatType&&"SequenceTrackName"===d[p].subtype&&(this.sequenceName=d[p].data[0]),"CopyrightNotice"===d[p].subtype&&h.push(d[p].data[0]),b.push({track:l,eventId:p,time:d[p].time,event:d[p],webMidiLink:"midi,"+Array.prototype.map.call(f[l][p],a=>a.toString(16)).join(",")});b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getPosition(){return this.position}setPosition(a){this.position=
a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(a){a*=this.tempo/6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
