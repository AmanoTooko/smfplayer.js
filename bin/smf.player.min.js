(function(){/*
   2019 Masashi Yoshikawa <https://logue.dev/> All rights reserved.
 @license     MIT
 @logue/smfplayer v0.3.2 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(r,l){"object"===typeof exports&&"object"===typeof module?module.exports=l():"function"===typeof define&&define.amd?define("SMF",[],l):"object"===typeof exports?exports.SMF=l():r.SMF=l()})("undefined"!==typeof self?self:this,function(){return function(r){function l(d){if(g[d])return g[d].exports;var b=g[d]={i:d,l:!1,exports:{}};r[d].call(b.exports,b,b.exports,l);b.l=!0;return b.exports}var g={};l.m=r;l.c=g;l.d=function(d,b,a){l.o(d,b)||Object.defineProperty(d,b,{enumerable:!0,
get:a})};l.r=function(d){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"});Object.defineProperty(d,"__esModule",{value:!0})};l.t=function(d,b){b&1&&(d=l(d));if(b&8||b&4&&"object"===typeof d&&d&&d.__esModule)return d;var a=Object.create(null);l.r(a);Object.defineProperty(a,"default",{enumerable:!0,value:d});if(b&2&&"string"!=typeof d)for(var c in d)l.d(a,c,function(a){return d[a]}.bind(null,c));return a};l.n=function(d){var b=d&&d.__esModule?
function(){return d["default"]}:function(){return d};l.d(b,"a",b);return b};l.o=function(d,b){return Object.prototype.hasOwnProperty.call(d,b)};l.p="";return l(l.s=11)}([function(r,l,g){g.d(l,"a",function(){return b});g.d(l,"c",function(){return a});g.d(l,"b",function(){return c});class d{constructor(a,c,b){this.subtype=a;this.deltaTime=c;this.time=b}}class b extends d{constructor(a,c,b,f,h,q){super(a,c,b);this.channel=f;this.parameter1=h;this.parameter2=q}}class a extends d{constructor(a,c,b,f){super(a,
c,b);this.data=f}}class c extends d{constructor(a,c,b,f){super(a,c,b);this.data=f}}},function(r,l,g){l.a={version:"0.3.2",date:"2019-12-14T16:35:03.998Z"}},function(r,l,g){g.d(l,"a",function(){return b});var d=g(0);class b{constructor(a={}){this.timeDivision=a.timeDivision|0||96;this.channel=a.channel|0;this.timeOffset=a.timeOffset|0;this.PATTERN=/[a-glnortv<>][+#-]?[0-9]*\.?&?/g;this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};this.MINIM=2*this.timeDivision;this.SEMIBREVE=4*this.timeDivision;this.VELOCITY_MAGNIFICATION=
7;this.mml=a.mml;this.events=[];this.plainEvents=[];this.endTime=0;this.noteOffNegativeOffset=2;this.ignoreTempo=a.igonreTempo|0;this.maxOctave=a.maxOctave|8;this.minOctave=a.minOctave|0;this.octaveMode=a.octaveMode|0;this.minNote=a.minNote|12;this.maxNote=a.minNote|98;this.parse()}parse(){var a=[];try{a=this.mml.toLowerCase().match(this.PATTERN)}catch(m){console.warn("Could not parse MML.",this.mml);return}if(a){var c=this.timeOffset,b=this.timeDivision,e=0,u=8,f=4,h=!1,q=[];for(const m of a){a=
b|0;let v,k;if(m.match(/([lotv<>])([1-9][0-9]*|0?)(\.?)(&?)/))switch(v=RegExp.$1.toLowerCase(),k=RegExp.$2|0,h&&"&"!==RegExp.$4&&(h=!1,q.push(new d.a("NoteOff",0,c-this.noteOffNegativeOffset,this.channel,e))),v){case "l":1<=k&&k<=this.MINIM&&(b=Math.floor(this.SEMIBREVE/k),"."===RegExp.$3&&(b=Math.floor(1.5*b)));break;case "o":k>=this.minOctave&&k<=this.maxOctave&&(f=k);break;case "t":q.push(new d.b("SetTempo",0,c,[Math.floor(6E7/k)]));break;case "v":0<=k&&15>=k&&(u=k);break;case "<":f=f<=this.minOctave?
this.minOctave:f-1;break;case ">":f=f>=this.maxOctave?this.maxOctave:f+1}else if(m.match(/([a-gn])([+#-]?)([0-9]*)(\.?)(&?)/)){let b=0;v=RegExp.$1.toLowerCase();k=RegExp.$3|0;"n"===v?b=k:(1<=k&&k<=this.MINIM&&(a=Math.floor(this.SEMIBREVE/k)),"."===RegExp.$4&&(a=Math.floor(1.5*a)),2!==this.octaveMode&&(b=12*f+this.NOTE_TABLE[v],"+"===RegExp.$2||"#"===RegExp.$2?b++:"-"===RegExp.$2&&b--));switch(this.octaveMode){case 1:for(;b<this.minNote;)b+=12;for(;b>this.maxNote;)b-=12;b+=12;break;case 2:b=this.maxNote;
break;default:b+=12}h?b!==e&&q.push(new d.a("NoteOff",0,c-this.noteOffNegativeOffset,this.channel,e)):q.push(new d.a("NoteOn",0,c,this.channel,b,u*this.VELOCITY_MAGNIFICATION));c+=a;"&"===RegExp.$5?(h=!0,e=b):(h=!1,q.push(new d.a("NoteOff",0,c-this.noteOffNegativeOffset,this.channel,b)))}else m.match(/R([0-9]*)(\.?)/i)?(k=RegExp.$1|0,1<=k&&k<=this.MINIM&&(a=Math.floor(this.SEMIBREVE/k)),"."===RegExp.$2&&(a=Math.floor(1.5*a)),c+=a):console.warn("unknown signeture.",m)}this.events=q;this.endTime=c}}}
},function(r,l,g){g.d(l,"a",function(){return c});var d=g(2);r=g(7);var b=g.n(r),a=g(0);class c{constructor(a,c={}){a=String.fromCharCode.apply("",new Uint16Array(a));this.input=b.a.parse(a);this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=c.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("shift_jis");const c=this.input.infomation;this.title=c.title;this.type=c.auther;this.timeDivision=c.timeBase|
0||96;this.mmsInstTable=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,65,66,67,68,69,70,71,72,73,74,75,76,18];const b=[];b.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));b.push(new a.b("SequenceTrackName",0,0,[this.title]));b.push(new a.b("CopyrightNotice",0,0,[this.author]));b.push(new a.b("TimeSignature",0,0,[c.rythmNum|0||4,c.rythmBase|0||4,0,0]));b.push(new a.b("EndOfTrack",0,0));this.tracks.push(b);delete this.input.infomation;delete this.input["mms-file"]}parseTracks(){const c=this.input;
let b=[];const u=[];let f=0;for(const e in c)if(c.hasOwnProperty(e)){const m=[c[e].ch0_mml,c[e].ch1_mml,c[e].ch2_mml];var h=Number(c[e].panpot)+64;b.push(new a.b("InsturumentName",0,48,[c[e].name]));b.push(new a.a("ProgramChange",0,96,f,this.mmsInstTable[c[e].instrument]|0));b.push(new a.a("ControlChange",0,154,f,10,h));for(h=0;h<m.length;h++){const a=new d.a({timeDivision:this.timeDivision,channel:f,timeOffset:386,mml:m[h]});b=b.concat(a.events);u.push(a.endTime)}f++;b.concat(new a.b("EndOfTrack",
0,Math.max(u)));this.tracks.push(b)}this.numberOfTracks=this.tracks.length}toPlainTrack(){for(let c=0;c<this.tracks.length;c++){let b=[],u=[];const f=this.tracks[c];for(let c=0;c<f.length;c++){const b=f[c];let h;if(b instanceof a.a)switch(b.subtype){case "NoteOn":h=0===b.parameter2?new Uint8Array([128|b.channel,b.parameter1,b.parameter2]):new Uint8Array([144|b.channel,b.parameter1,b.parameter2]);break;case "NoteOff":h=new Uint8Array([128|b.channel,b.parameter1,b.parameter2]);break;case "ControlChange":h=
new Uint8Array([176|b.channel,b.parameter1,b.parameter2]);break;case "ProgramChange":h=new Uint8Array([192|b.channel,b.parameter1])}else if(b instanceof a.b){const a=this.encoder.encode(b.data);switch(b.subtype){case "TextEvent":h=new Uint8Array([255,1].concat(a));break;case "SequenceTrackName":h=new Uint8Array([255,3].concat(a));break;case "CopyrightNotice":h=new Uint8Array([255,2].concat(a));break;case "InsturumentName":h=new Uint8Array([255,4].concat(a));break;case "SetTempo":h=new Uint8Array([255,
81].concat(a));break;case "TimeSignature":h=new Uint8Array([255,88].concat(a));break;case "EndOfTrack":h=new Uint8Array([255,47])}}else b instanceof a.c&&(h=new Uint8Array([240,5].concat(b.data)));u=u.concat(h)}b=b.concat(u);this.plainTracks[c]=b}}}},function(r,l,g){g.d(l,"a",function(){return d});class d{constructor(b,c={}){this.input=b;this.ip=c.index||0;this.length=c.length||b.length-this.ip;this.offset=this.ip;this.padding=void 0!==c.padding?c.padding:!0;this.bigEndian=void 0!==c.bigEndian?c.bigEndian:
!1}parse(){const b=this.length+this.offset;for(this.chunkList=[];this.ip<b;)this.parseChunk()}parseChunk(){var a=this.input;let c=this.ip;this.chunkList.push(new b(String.fromCharCode(a[c++],a[c++],a[c++],a[c++]),a=this.bigEndian?(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0:(a[c++]|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,c));c+=a;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}getChunk(b){b=this.chunkList[b];return void 0===b?null:b}getNumberOfChunks(){return this.chunkList.length}}class b{constructor(b,
c,v){this.type=b;this.size=c;this.offset=v}}},function(r,l,g){g.r(l);g.d(l,"default",function(){return c});var d=g(0),b=g(1),a=g(4);class c{constructor(c,e={}){e.padding=!1;e.bigEndian=!0;this.input=c;this.ip=e.index||0;this.chunkIndex=0;this.riffParser_=new a.a(c,e);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[];this.version=b.a.version;this.build=b.a.build}parse(){let b,c;this.riffParser_.parse();this.parseHeaderChunk();b=0;for(c=this.numberOfTracks;b<
c;++b)this.parseTrackChunk()}parseHeaderChunk(){const b=this.riffParser_.getChunk(this.chunkIndex++),c=this.input;let a=b.offset;if(!b||"MThd"!==b.type)throw Error("invalid header signature");this.formatType=c[a++]<<8|c[a++];this.numberOfTracks=c[a++]<<8|c[a++];this.timeDivision=c[a++]<<8|c[a++]}parseTrackChunk(){var b=this.riffParser_.getChunk(this.chunkIndex++);const c=this.input;let a=b.offset,f=0;var h=0;let q=0;var m=0;let p=-1,k=-1,n=m=0;var g=0;let l=h=0,t;const r=()=>{let b=0,h;do h=c[a++],
b=b<<7|h&127;while(0!==(h&128));return b};if(!b||"MTrk"!==b.type)throw Error("invalid header signature");f=b.offset+b.size;b=[];const w=[];for(;a<f;){h=r();n+=h;g=a;l=c[a++];q=l>>4&15;m=l&15;8>q?(q=p,m=k,l=p<<4|k,a--,g--):(p=q,k=m);const e=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(q){case 8:case 9:case 10:case 11:case 13:case 14:t=new d.a(e[q],h,n,m,c[a++],c[a++]);break;case 12:t=new d.a(e[q],h,n,m,c[a++]);break;case 15:switch(m){case 0:m=
r();if(247!==c[a+m-1])throw Error("invalid SysEx event");t=new d.c("SystemExclusive",h,n,c.subarray(a,(a+=m)-1));break;case 7:m=r();t=new d.c("SystemExclusive(F7)",h,n,c.subarray(a,a+=m));break;case 15:q=c[a++];m=r();switch(q){case 0:t=new d.b("SequenceNumber",h,n,[c[a++],c[a++]]);break;case 1:t=new d.b("TextEvent",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 2:t=new d.b("CopyrightNotice",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 3:t=new d.b("SequenceTrackName",
h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 4:t=new d.b("InstrumentName",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 5:t=new d.b("Lyrics",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 6:t=new d.b("Marker",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 7:t=new d.b("CuePoint",h,n,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 32:t=new d.b("MidiChannelPrefix",h,n,[c[a++]]);break;case 47:t=
new d.b("EndOfTrack",h,n,[]);break;case 81:t=new d.b("SetTempo",h,n,[c[a++]<<16|c[a++]<<8|c[a++]]);break;case 84:t=new d.b("SmpteOffset",h,n,[c[a++],c[a++],c[a++],c[a++],c[a++]]);break;case 88:t=new d.b("TimeSignature",h,n,[c[a++],c[a++],c[a++],c[a++]]);break;case 89:t=new d.b("KeySignature",h,n,[c[a++],c[a++]]);break;case 127:t=new d.b("SequencerSpecific",h,n,[c.subarray(a,a+=m)]);break;default:t=new d.b("Unknown",h,n,[q,c.subarray(a,a+=m)])}break;default:console.warn("unknown message:",l.toString(16))}break;
default:throw Error("invalid status");}h=a-g;g=c.subarray(g,g+h);g[0]=l;t instanceof d.a&&"NoteOn"===t.subtype&&0===t.parameter2&&(t.subtype=e[8],g=new Uint8Array([128|t.channel,t.parameter1,t.parameter2]));w.push(g);b.push(t)}this.tracks.push(b);this.plainTracks.push(w)}}},function(r,l,g){g.d(l,"a",function(){return a});var d=g(2);r=g(3);var b=g(0);class a extends r.a{constructor(a,b={}){super(a,b);this.input=String.fromCharCode.apply("",new Uint16Array(a)).split(/\r\n|\r|\n/);this.tracks=[];this.plainTracks=
[];this.numberOfTracks=1;this.timeDivision=b.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("utf-8");var a=["mml-track","name","program","songProgram","panpot"];const d={};var e=-1;d.track=[];for(let b=0;b<this.input.length;b++){const c=this.input[b].trim();if(0===b){if("[mml-score]"!==c)throw Error("Not MabiIcco File.");continue}const [h,u]=c.split("=");a.includes(h)?"mml-track"===h?(e++,d.track[e]={},d.track[e].mml=u):
d.track[e][h]="name"===h?u:u|0:d[h]=u}this.title=d.title;this.author=d.author;a=""!==d.tempo?d.tempo.split("T"):[0,120];this.timeDivision=96;this.tempo=a[1]|0;a=d.time.split("/");e=[];e.push(new b.c("SystemExclusive",0,0,[126,127,9,1]));e.push(new b.b("SequenceTrackName",0,0,[this.title]));e.push(new b.b("CopyrightNotice",0,0,[this.author]));e.push(new b.b("TimeSignature",0,0,[a[0]|0||4,a[1]|0||4,0,0]));e.push(new b.b("SetTempo",0,0,[Math.floor(6E7/this.tempo)]));e.push(new b.b("EndOfTrack",0,0));
this.tracks.push(e);this.input=d.track}parseTracks(){let a=[];const g=[];for(let c=0;c<this.input.length;c++){const f=this.input[c];if(!f.mml.match(/^(?:MML@)(.*)/gm))continue;const h=RegExp.$1.split(",");a.push(new b.b("InsturumentName",0,48,[f.name]));a.push(new b.a("ProgramChange",0,96,c,f.program));-1!==f.songProgram&&a.push(new b.a("ProgramChange",0,112,15,f.songProgram));a.push(new b.a("ControlChange",0,154,c,10,f.panpot));for(let b=0;b<f.mml.length;b++){var e=c;3===b&&-1!==f.songProgram&&(e=
15);void 0!==h[b]&&(e=new d.a({timeDivision:this.timeDivision,channel:e,timeOffset:386,mml:h[b],igonoreTempo:1===e}),a=a.concat(e.events),g.push(e.endTime))}a.concat(new b.b("EndOfTrack",0,Math.max(g)));this.tracks.push(a)}this.numberOfTracks=this.tracks.length}}},function(r,l){function g(b,c){var e=[],h="";"string"===typeof c?c={section:c,whitespace:!1}:(c=c||{},c.whitespace=!0===c.whitespace);var u=c.whitespace?" = ":"=";Object.keys(b).forEach(function(c,f,k){(f=b[c])&&Array.isArray(f)?f.forEach(function(b){h+=
a(c+"[]")+u+a(b)+"\n"}):f&&"object"===typeof f?e.push(c):h+=a(c)+u+a(f)+v});c.section&&h.length&&(h="["+a(c.section)+"]"+v+h);e.forEach(function(a,e,f){e=d(a).join("\\.");a=g(b[a],{section:(c.section?c.section+".":"")+e,whitespace:c.whitespace});h.length&&a.length&&(h+=v);h+=a});return h}function d(a){return a.replace(/\1/g,"\u0002LITERAL\\1LITERAL\u0002").replace(/\\\./g,"\u0001").split(/\./).map(function(a){return a.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"\u0001")})}function b(a){return'"'===
a.charAt(0)&&'"'===a.slice(-1)||"'"===a.charAt(0)&&"'"===a.slice(-1)}function a(a){return"string"!==typeof a||a.match(/[=\r\n]/)||a.match(/^\[/)||1<a.length&&b(a)||a!==a.trim()?JSON.stringify(a):a.replace(/;/g,"\\;").replace(/#/g,"\\#")}function c(a,c){a=(a||"").trim();if(b(a)){"'"===a.charAt(0)&&(a=a.substr(1,a.length-2));try{a=JSON.parse(a)}catch(p){}}else{c=!1;for(var f="",h=0,e=a.length;h<e;h++){var m=a.charAt(h);if(c)f=-1!=="\\;#".indexOf(m)?f+m:f+("\\"+m),c=!1;else if(-1!==";#".indexOf(m))break;
else"\\"===m?c=!0:f+=m}c&&(f+="\\");return f.trim()}return a}l.parse=l.decode=function(a){var b={},f=b,h=null,e=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;a.split(/[\r\n]+/g).forEach(function(a,d,k){if(a&&!a.match(/^\s*[;#]/)&&(d=a.match(e)))if(void 0!==d[1])h=c(d[1]),f=b[h]=b[h]||{};else{a=c(d[2]);d=d[3]?c(d[4]):!0;switch(d){case "true":case "false":case "null":d=JSON.parse(d)}2<a.length&&"[]"===a.slice(-2)&&(a=a.substring(0,a.length-2),f[a]?Array.isArray(f[a])||(f[a]=[f[a]]):f[a]=[]);Array.isArray(f[a])?
f[a].push(d):f[a]=d}});Object.keys(b).filter(function(a,c,h){if(!b[a]||"object"!==typeof b[a]||Array.isArray(b[a]))return!1;c=d(a);var f=b;h=c.pop();var k=h.replace(/\\\./g,".");c.forEach(function(a,b,c){f[a]&&"object"===typeof f[a]||(f[a]={});f=f[a]});if(f===b&&k===h)return!1;f[k]=b[a];return!0}).forEach(function(a,c,h){delete b[a]});return b};l.stringify=l.encode=g;l.safe=a;l.unsafe=c;var v="undefined"!==typeof process&&"win32"===process.platform?"\r\n":"\n"},function(r,l,g){g.d(l,"a",function(){return a});
var d=g(2);r=g(3);var b=g(0);class a extends r.a{constructor(a,b={}){super(a,b);this.encoder=new TextEncoder("utf-8");this.input=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(a)),"text/xml").querySelectorAll("ms2 > *");this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=b.timeDivision||96}parse(){this.parseTracks();this.toPlainTrack()}parseTracks(){let a=[];const g=[];for(let b=0;b<this.input.length;b++){const c=new d.a({timeDivision:this.timeDivision,
channel:0,mml:this.input[b].textContent.trim(),ignoreTempo:!1});a=a.concat(c.events);g.push(c.endTime)}a.concat(new b.b("EndOfTrack",0,Math.max(g)));this.tracks.push(a)}}},function(r,l,g){g.d(l,"a",function(){return d});class d{constructor(b,a={}){this.input=b;this.ip=a.index||0;this.timeDivision=a.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const b=this.input;let a=this.ip;const c=this.header={},d=String.fromCharCode(b[a++],b[a++],b[a++],
b[a++]);if("melo"!==d)throw Error("invalid MFi signature:"+d);c.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;c.trackOffset=(b[a++]<<16|b[a++])+a;c.dataMajorType=b[a++];c.dataMinorType=b[a++];c.numberOfTracks=b[a++];this.ip=a}parseDataInformation(){const b=this.input;let a=this.ip;const c=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let d,e;for(;a<this.header.trackOffset;)switch(d=String.fromCharCode(b[a++],b[a++],b[a++],
b[a++]),e=b[a++]<<8|b[a++],d){case "titl":case "copy":case "vers":case "date":case "prot":c[d]=String.fromCharCode.apply(null,b.subarray(a,a+=e));break;case "sorc":c[d]=b[a++];break;case "note":c[d]=b[a++]<<8|b[a++];break;case "exst":break;default:c[d]=b.subarray(a,a+=e)}this.ip=a}parseTracks(){const b=this.input;let a=this.ip;let c;const d=this.tracks=[];let e,g,f;const h=()=>{var c=b[a++]<<8|b[a++];c=a+c;const h=[];let f;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<
c;)f={},f.part=b[a++]>>4&3,f.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},f.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},f.octaveSelect=b[a++]&3,h.push(f);return h},q=()=>{var c=b[a++]<<8|b[a++];c=a+c;if(17!==
b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}};g=0;for(f=this.header.numberOfTracks;g<f;++g){var m=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==m)throw Error("invalid track signature:"+m);m=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];m=a+m;for(e=d[g]=[];a<m;){c={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};c.deltaTime=deltaTime=b[a++];var p=b[a++];if(255!==p)c.type="note",c.subType="Note",
c.voice=p>>6,c.key=p&63,noteLength=c.length=b[a++],1===this.dataInformation.note&&(p=b[a++],c.velocity=p>>2,c.octaveShift=p&3);else switch(c.type="meta",p=b[a++],p>>4){case 11:switch(p&15){case 0:c.subType="MasterVolume";c.value=b[a++];break;case 10:c.subType="DrumScale";c.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+p.toString(16));}break;case 12:c.subType="SetTempo";c.value={timeBase:7===(p&7)?NaN:Math.pow(2,p&7)*(0===(p&8)?6:15),tempo:b[a++]};break;
case 13:switch(p&15){case 0:c.subType="Point";c.value=b[a++];break;case 13:c.subType="Loop";c.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:c.subType="Nop";c.value=b[a++];break;case 15:c.subType="EndOfTrack";c.value=b[a++];break;default:throw Error("unkwnon message type:"+p.toString(16));}break;case 14:switch(p&15){case 0:c.subType="InstrumentLowPart";c.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:c.subType="InstrumentHighPart";c.value={part:b[a]>>6,instrument:b[a++]&
1};break;case 2:c.subType="Volume";c.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:c.subType="Valance";c.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:c.subType="PitchBend";c.value={part:b[a]>>6,value:b[a++]&63};break;case 5:c.subType="ChannelAssign";c.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:c.subType="VolumeChange";c.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:c.subType="PitchBendRange";c.value={part:b[a]>>6,value:b[a++]&63};break;case 8:case 9:c.subType="MasterCoarseTuning";
c.value={part:b[a]>>6,value:b[a++]&63};break;case 10:c.subType="Modulation";c.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+p.toString(16));}break;case 15:switch(p&15){case 0:c.subType="EditInstrument";c.value=h();break;case 1:c.subType="Vibrato";p=c;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var k={part:b[a++]>>5&3,switch:b[a++]>>6};p.value=k;break;case 15:c.subType="DeviceSpecific";c.value=q();break;default:throw Error("unkwnon message type:"+
p.toString(16));}break;default:throw Error("unkwnon message type:"+p.toString(16));}e.push(c)}a=m}this.ip=a}convertToMidiTracks(){const b=[],a=this.tracks;let c;let d,e,g,f,h,q,m;const p=[];for(f=0;16>f;++f)b[f]=[],p[f]=0;f=0;for(h=a.length;f<h;++f){var k=a[f];d=[];e=g=q=0;for(m=k.length;q<m;++q)switch(c=k[q],e+=c.deltaTime,c.id=g,c.time=e,c.subType){case "Nop":break;case "Note":d[g++]=c;d[g]={id:g,type:"internal",subType:"NoteOff",time:e+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};
g++;break;case "InstrumentHighPart":var n=c;c=k[++q];if("InstrumentLowPart"!==c.subType)throw Error("broken instrument");d[g]={id:g,type:"internal",subType:"ProgramChange",time:e,part:c.value.part,instrument:n.value.instrument<<6|c.value.instrument};g++;break;default:d[g++]=c}d.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0);e=q=0;for(m=d.length;q<m;++q){c=d[q];e=c.time;switch(c.subType){case "Note":n=this.applyOctaveShift(c.key+45,c.octaveShift);k=4*f+c.voice;9===k&&(n-=
10);b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(144|k,n,2*c.velocity));break;case "NoteOff":n=this.applyOctaveShift(c.key+45,c.octaveShift);k=4*f+c.voice;9===k&&(n-=10);b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(128|k,n,2*c.velocity));break;case "ProgramChange":k=4*f+c.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(192|k,c.instrument));break;case "SetTempo":n=288E7/(c.value.tempo*c.value.timeBase);k=0;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(255,81,3,n>>16&255,n>>
8&255,n&255));break;case "Loop":n=c.value.count;n="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===n?-1:n);k=0;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat([255,6,n.length],n.split("").map(a=>a.charCodeAt(0))));break;case "MasterVolume":n=c.value;k=0;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(240,7,127,127,4,1,n,n,247));break;case "Modulation":k=4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(176|k,1,2*c.value.depth));break;case "Volume":k=
4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(176|k,7,2*c.value.volume));break;case "Valance":k=4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(176|k,10,2*(c.value.valance-32)+64));break;case "PitchBend":k=4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(224|k,2*c.value.value,2*c.value.value));break;case "PitchBendRange":k=4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(176|k,100,0),[0,176|k,101,0],[0,176|k,6,2*c.value.value]);
break;case "MasterCoarseTuning":k=4*f+c.value.part;b[k].push(this.deltaTimeToByteArray(e-p[k]).concat(176|k,100,0),[0,176|k,101,2],[0,176|k,6,2*c.value.value]);break;default:continue}p[k]=c.time}}return this.toSMF(b)}applyOctaveShift(b,a){const c=[0,12,-24,-12];if(void 0!==c[a])return b+c[a];throw Error("invalid OctaveShift value:"+a);}toSMF(b){var a;let c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let d;if(void 0!==this.dataInformation.copy){var e=this.dataInformation.copy;var g=e.length;var f=Array(g);
for(a=0;a<g;++a)f[a]=e.charCodeAt(a);a=e=f;e=a.length;a=[0,255,2].concat(this.deltaTimeToByteArray(e),a);b[0].unshift(a)}g=0;for(e=b.length;g<e;++g){const h=b[g];a=[];f=0;for(d=h.length;f<d;++f)Array.prototype.push.apply(a,h[f]);d=a.length;f=[77,84,114,107,d>>24&255,d>>16&255,d>>8&255,d&255];c=c.concat(f,a)}return new Uint8Array(c)}deltaTimeToByteArray(b){const a=[];for(;128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a}}},function(r,l,g){g.d(l,"a",function(){return a});
var d=g(2),b=g(0);r=g(3);class a extends r.a{constructor(a,b={}){super(a,b)}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){const a=this.input.Settings;this.encoder=new TextEncoder(a.Encoding||"shift_jis");this.title=a.Title;this.author=a.Source;this.timeDivision=a.TimeBase|0||32;const d=[];d.push(new b.c("SystemExclusive",0,0,[126,127,9,1]));d.push(new b.b("SequenceTrackName",0,0,[this.title]));d.push(new b.b("CopyrightNotice",0,0,[this.author]));d.push(new b.b("TextEvent",
0,0,[a.Memo]));d.push(new b.b("TimeSignature",0,0,[a.TimeSignatureNN|0||4,a.TimeSignatureDD|0||4,0,0]));d.push(new b.b("EndOfTrack",0,0));this.tracks.push(d);delete this.input["3MLE EXTENSION"];delete this.input.Settings}parseTracks(){var a=this.input;const g=[];var e=[],l=[];for(const b in a)a.hasOwnProperty(b)&&(b.match(/^Channel(\d+)$/i)&&(e[(RegExp.$1|0)-1]=Object.keys(a[b]).join("").replace(/\/\*([^*]|\*[^\/])*\*\//g,"")),b.match(/^ChannelProperty(\d+)$/i)&&(l[(RegExp.$1|0)-1]={name:a[b].Name,
instrument:a[b].Patch|0,panpot:a[b].Pan|0}));a=[];for(const b in e)e.hasOwnProperty(b)&&(a[b]=void 0!==l[b]?{mml:e[b],name:l[b].name||"",instrument:l[b].instrument||0,panpot:l[b].panpot||64}:{mml:e[b],name:"",instrument:0,panpot:64});for(const c in a)a.hasOwnProperty(c)&&(l=c|0,e=[],""!==a[c].mml&&(e.push(new b.b("InsturumentName",0,48,[a[c].name])),e.push(new b.a("ProgramChange",0,96,l,a[c].instrument)),e.push(new b.a("ControlChange",0,154,l,10,a[c].panpot)),l=new d.a({timeDivision:this.timeDivision,
channel:l,timeOffset:386,mml:a[c].mml}),e=e.concat(l.events),g.push(l.endTime),e.concat(new b.b("EndOfTrack",0,Math.max(g))),this.tracks.push(e)));this.numberOfTracks=this.tracks.length}}},function(r,l,g){g.r(l);g.d(l,"Player",function(){return f});var d=g(6),b=g(3),a=g(8),c=g(1),v=g(9),e=g(5),u=g(10);class f{constructor(a="#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=[];this.timer=0;this.sequence={};this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=
!1;this.tempoRate=1;this.masterVolume=16383;this.lyrics=this.copyright=this.sequenceName=this.textEvent="";this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a);this.version=c.a.version;this.build=c.a.build}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(a=0;16>
a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();this.initSequence();this.pause=!0;this.track=null;this.resume=-1;this.textEvent=this.lyrics=this.copyright=this.sequenceName=this.sequence=this.text=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",b=>{"link,ready"===b.data&&
a.sendInitMessage()},!1)}initSequence(){this.tempo=5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+
"px",a.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+
",06,02","*"),a.postMessage("midi,b"+b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,c=a=>{"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);this.target.firstChild&&this.target.removeChild(this.target.firstChild);
const b=this.webMidiLink=this.window.document.createElement("iframe");b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",c,!1);const h=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",h,!1);let d=0;this.window.addEventListener("resize",()=>{0<d&&clearTimeout(d);d=setTimeout(h,100)},!1)}else this.webMidiLink.addEventListener("message",c,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&
this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,d=this.webMidiLink.contentWindow;let f=this.position||0;const e=[],g=()=>{const h=c[f].time,k=c.length;let l,m,n,p=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{l=c[f].event;switch(l.subtype){case "TextEvent":a.textEvent=
l.data[0];break;case "Lyrics":a.lyrics=l.data[0];break;case "Maker":if(a.enableFalcomLoop)switch(l.data[0]){case "A":e[0]={pos:f};break;case "B":if(e[0]&&"number"===typeof e[0].pos){f=e[0].pos;a.timer=a.window.setTimeout(g,0);a.position=f;return}}if(a.enableMFiLoop&&(m=l.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===m[1])e[m[2]|0]=e[m[2]]||{pos:f,count:m[3]|0};else if("END"===m[1]&&a.enableMFiLoop){n=e[m[2]|0];if(0!==n.count){0<n.count&&n.count--;f=n.pos;a.timer=a.window.setTimeout(g,
0);a.position=f;return}e[m[2]|0]=null}break;case "SetTempo":a.tempo=l.data[0]}"ControlChange"===l.subtype&&111===l.parameter1&&(e[0]={pos:f});d.postMessage(c[f++].webMidiLink,"*")}while(f<k&&c[f].time===h);f<k?(p=Date.now()-p,a.timer=a.window.setTimeout(g,a.tempo/(1E3*b)*(c[f].time-h-p)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&e[0]&&"number"===typeof e[0].pos?f=e[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=f;a.time=h}};this.pause?(this.timer=a.window.setTimeout(g,
this.resume),this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(g,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=new e["default"](a);this.init();a.parse();this.mergeMidiTracks(a)}loadMldFile(a){a=new v.a(a);this.init();a.parse();this.mergeMidiTracks(a.convertToMidiTracks())}loadMs2MmlFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b)}loadMakiMabiSequenceFile(a){a=new b.a(a);this.init();a.parse();this.mergeMidiTracks(a)}load3MleFile(a){a=new u.a(a);this.init();a.parse();
this.mergeMidiTracks(a)}loadMabiIccoFile(a){a=new d.a(a);this.init();a.parse();this.mergeMidiTracks(a)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var d=Array(c.length);const f=a.plainTracks;let e,h,g,l;e=0;for(h=c.length;e<h;++e)d[e]=0;e=0;for(h=c.length;e<h;++e)for(d=c[e],g=0,l=d.length;g<l;++g){if(0===a.formatType||0===e)"SequenceTrackName"===d[g].subtype?this.sequenceName=d[g].data[0]:"CopyrightNotice"===d[g].subtype&&(this.copyright=d[g].data[0]);b.push({track:e,eventId:g,time:d[g].time,
event:d[g],webMidiLink:"midi,"+Array.prototype.map.call(f[e][g],a=>a.toString(16)).join(",")})}b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getLyrics(){return this.lyrics}getTextEvent(){return this.textEvent}getPosition(){return this.position}setPosition(a){this.position=a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&
this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(a){a*=this.tempo/6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
