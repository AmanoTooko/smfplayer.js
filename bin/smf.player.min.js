(function(){/*
   2019 Masashi Yoshikawa <https://logue.dev/> All rights reserved.
 @license     MIT
 @logue/smfplayer v0.3.1 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(t,k){"object"===typeof exports&&"object"===typeof module?module.exports=k():"function"===typeof define&&define.amd?define("SMF",[],k):"object"===typeof exports?exports.SMF=k():t.SMF=k()})("undefined"!==typeof self?self:this,function(){return function(t){function k(g){if(e[g])return e[g].exports;var a=e[g]={i:g,l:!1,exports:{}};t[g].call(a.exports,a,a.exports,k);a.l=!0;return a.exports}var e={};k.m=t;k.c=e;k.d=function(g,a,b){k.o(g,a)||Object.defineProperty(g,a,{enumerable:!0,
get:b})};k.r=function(g){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"});Object.defineProperty(g,"__esModule",{value:!0})};k.t=function(g,a){a&1&&(g=k(g));if(a&8||a&4&&"object"===typeof g&&g&&g.__esModule)return g;var b=Object.create(null);k.r(b);Object.defineProperty(b,"default",{enumerable:!0,value:g});if(a&2&&"string"!=typeof g)for(var c in g)k.d(b,c,function(c){return g[c]}.bind(null,c));return b};k.n=function(g){var a=g&&g.__esModule?
function(){return g["default"]}:function(){return g};k.d(a,"a",a);return a};k.o=function(g,a){return Object.prototype.hasOwnProperty.call(g,a)};k.p="";return k(k.s=10)}([function(t,k,e){e.d(k,"a",function(){return a});e.d(k,"c",function(){return b});e.d(k,"b",function(){return c});class g{constructor(c,b,a){this.subtype=c;this.deltaTime=b;this.time=a}}class a extends g{constructor(c,b,a,f,q,r){super(c,b,a);this.channel=f;this.parameter1=q;this.parameter2=r}}class b extends g{constructor(c,b,a,f){super(c,
b,a);this.data=f}}class c extends g{constructor(c,b,a,f){super(c,b,a);this.data=f}}},function(t,k,e){e.d(k,"a",function(){return a});var g=e(0);class a{constructor(b={}){this.timeDivision=b.timeDivision|0||96;this.channel=b.channel|0;this.timeOffset=b.timeOffset|0;this.isGMMode=b.timeOffset|0;this.PATTERN=/[A-GLNORTV<>][+#-]?[0-9]*\.?&?/gi;this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};this.MINIM=2*this.timeDivision;this.SEMIBREVE=4*this.timeDivision;this.mml=b.mml;this.events=[];this.plainEvents=
[];this.endTime=0;this.noteOffNegativeOffset=2;this.ignoreTempo=b.igonreTempo|0;this.parse()}parse(){let b;try{b=this.mml.match(this.PATTERN)}catch(n){console.warn("Could not parse MML.",this.mml);return}let c=this.timeOffset,a=this.timeDivision,d=0,m=!1,f=8,q=4;const r=[];for(const p in b)if(b&&Object.prototype.hasOwnProperty.call(b,p)){let h=a|0;if(b[p].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i)){var l=parseInt(RegExp.$2);m&&"&"!==RegExp.$4&&(m=!1,r.push(new g.a("NoteOff",0,c-this.noteOffNegativeOffset,
this.channel,d)));switch(RegExp.$1){case "L":case "l":1<=l&&l<=this.MINIM&&(a=Math.floor(this.SEMIBREVE/l),"."===RegExp.$3&&(a=Math.floor(1.5*a)));break;case "O":case "o":0<=l&&8>=l&&(q=l);break;case "T":case "t":r.push(new g.b("SetTempo",0,c,[Math.floor(6E7/l)]));break;case "V":case "v":0<=l&&15>=l&&(f=l);break;case "<":q=0>=q?0:q-1;break;case ">":q=8<=q?8:q+1}}else b[p].match(/([A-GN])([+#-]?)([0-9]*)(\.?)(&?)/i)?(l=RegExp.$3|0,"n"!==RegExp.$1&&"N"!==RegExp.$1&&(1<=l&&l<=this.MINIM&&(h=Math.floor(this.SEMIBREVE/
l)),"."===RegExp.$4&&(h=Math.floor(1.5*h)),l=12*q+this.NOTE_TABLE[RegExp.$1.toLowerCase()],"+"===RegExp.$2||"#"===RegExp.$2?l++:"-"===RegExp.$2&&l--),l+=12,m?l!==d&&r.push(new g.a("NoteOff",0,c-this.noteOffNegativeOffset,this.channel,d)):r.push(new g.a("NoteOn",0,c,this.channel,l,8*f)),c+=h,"&"===RegExp.$5?(m=!0,d=l):(m=!1,r.push(new g.a("NoteOff",0,c-this.noteOffNegativeOffset,this.channel,l)))):b[p].match(/[rR]([0-9]*)(\.?)/)?(l=RegExp.$1|0,1<=l&&l<=this.MINIM&&(h=Math.floor(this.SEMIBREVE/l)),
"."===RegExp.$2&&(h=Math.floor(1.5*h)),c+=h):console.warn("unknown signeture.",b[p])}this.events=r;this.endTime=c}}},function(t,k,e){e.d(k,"a",function(){return c});var g=e(1);t=e(7);var a=e.n(t),b=e(0);class c{constructor(c,b={}){c=String.fromCharCode.apply("",new Uint16Array(c));this.input=a.a.parse(c);this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=b.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("shift_jis");
const c=this.input.infomation;this.title=c.title;this.type=c.auther;this.timeDivision=c.timeBase|0||96;this.mmsInstTable=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,65,66,67,68,69,70,71,72,73,74,75,76,18];const a=[];a.push(new b.c("SystemExclusive",0,0,[126,127,9,1]));a.push(new b.b("SequenceTrackName",0,0,[this.title]));a.push(new b.b("CopyrightNotice",0,0,[this.author]));a.push(new b.b("TimeSignature",0,0,[c.rythmNum|0||4,c.rythmBase|0||4,0,0]));a.push(new b.b("EndOfTrack",0,0));this.tracks.push(a);
delete this.input.infomation;delete this.input["mms-file"]}parseTracks(){const c=this.input;let a=[];const m=[];let f=0;for(const d in c)if(c.hasOwnProperty(d)){const p=[c[d].ch0_mml,c[d].ch1_mml,c[d].ch2_mml];var q=Number(c[d].panpot)+64;a.push(new b.b("InsturumentName",0,48,[c[d].name]));a.push(new b.a("ProgramChange",0,96,f,this.mmsInstTable[c[d].instrument]|0));a.push(new b.a("ControlChange",0,154,f,10,q));for(q=0;q<p.length;q++){const c=new g.a({timeDivision:this.timeDivision,channel:f,timeOffset:386,
mml:p[q]});a=a.concat(c.events);m.push(c.endTime)}f++;a.concat(new b.b("EndOfTrack",0,Math.max(m)));this.tracks.push(a)}this.numberOfTracks=this.tracks.length}toPlainTrack(){for(let c=0;c<this.tracks.length;c++){let a=[],p=[];const f=this.tracks[c];for(let c=0;c<f.length;c++){const a=f[c];let d;if(a instanceof b.a)switch(a.subtype){case "NoteOn":d=0===a.parameter2?new Uint8Array([128|a.channel,a.parameter1,a.parameter2]):new Uint8Array([144|a.channel,a.parameter1,a.parameter2]);break;case "NoteOff":d=
new Uint8Array([128|a.channel,a.parameter1,a.parameter2]);break;case "ControlChange":d=new Uint8Array([176|a.channel,a.parameter1,a.parameter2]);break;case "ProgramChange":d=new Uint8Array([192|a.channel,a.parameter1])}else if(a instanceof b.b){const c=this.encoder.encode(a.data);switch(a.subtype){case "TextEvent":d=new Uint8Array([255,1].concat(c));break;case "SequenceTrackName":d=new Uint8Array([255,3].concat(c));break;case "CopyrightNotice":d=new Uint8Array([255,2].concat(c));break;case "InsturumentName":d=
new Uint8Array([255,4].concat(c));break;case "SetTempo":d=new Uint8Array([255,81].concat(c));break;case "TimeSignature":d=new Uint8Array([255,88].concat(c));break;case "EndOfTrack":d=new Uint8Array([255,47])}}else a instanceof b.c&&(d=new Uint8Array([240,5].concat(a.data)));p=p.concat(d)}a=a.concat(p);this.plainTracks[c]=a}}}},function(t,k,e){e.d(k,"a",function(){return g});class g{constructor(a,c={}){this.input=a;this.ip=c.index||0;this.length=c.length||a.length-this.ip;this.offset=this.ip;this.padding=
void 0!==c.padding?c.padding:!0;this.bigEndian=void 0!==c.bigEndian?c.bigEndian:!1}parse(){const a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()}parseChunk(){var b=this.input;let c=this.ip;this.chunkList.push(new a(String.fromCharCode(b[c++],b[c++],b[c++],b[c++]),b=this.bigEndian?(b[c++]<<24|b[c++]<<16|b[c++]<<8|b[c++])>>>0:(b[c++]|b[c++]<<8|b[c++]<<16|b[c++]<<24)>>>0,c));c+=b;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}getChunk(a){a=this.chunkList[a];return void 0===
a?null:a}getNumberOfChunks(){return this.chunkList.length}}class a{constructor(a,c,p){this.type=a;this.size=c;this.offset=p}}},function(t,k,e){e.r(k);e.d(k,"default",function(){return b});var g=e(3),a=e(0);class b{constructor(c,a={}){a.padding=!1;a.bigEndian=!0;this.input=c;this.ip=a.index||0;this.chunkIndex=0;this.riffParser_=new g.a(c,a);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[]}parse(){let a,b;this.riffParser_.parse();this.parseHeaderChunk();a=0;
for(b=this.numberOfTracks;a<b;++a)this.parseTrackChunk()}parseHeaderChunk(){const a=this.riffParser_.getChunk(this.chunkIndex++),b=this.input;let d=a.offset;if(!a||"MThd"!==a.type)throw Error("invalid header signature");this.formatType=b[d++]<<8|b[d++];this.numberOfTracks=b[d++]<<8|b[d++];this.timeDivision=b[d++]<<8|b[d++]}parseTrackChunk(){var c=this.riffParser_.getChunk(this.chunkIndex++);const b=this.input;let d=c.offset,m=0;var f=0;let q=0;var r=0;let l=-1,n=-1,h=r=0;var u=0;let g=f=0,e;const k=
()=>{let a=0,c;do c=b[d++],a=a<<7|c&127;while(0!==(c&128));return a};if(!c||"MTrk"!==c.type)throw Error("invalid header signature");m=c.offset+c.size;c=[];const t=[];for(;d<m;){f=k();h+=f;u=d;g=b[d++];q=g>>4&15;r=g&15;8>q?(q=l,r=n,g=l<<4|n,d--,u--):(l=q,n=r);const m=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(q){case 8:case 9:case 10:case 11:case 13:case 14:e=new a.a(m[q],f,h,r,b[d++],b[d++]);break;case 12:e=new a.a(m[q],f,h,
r,b[d++]);break;case 15:switch(r){case 0:r=k();if(247!==b[d+r-1])throw Error("invalid SysEx event");e=new a.c("SystemExclusive",f,h,b.subarray(d,(d+=r)-1));break;case 7:r=k();e=new a.c("SystemExclusive(F7)",f,h,b.subarray(d,d+=r));break;case 15:q=b[d++];r=k();switch(q){case 0:e=new a.b("SequenceNumber",f,h,[b[d++],b[d++]]);break;case 1:e=new a.b("TextEvent",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 2:e=new a.b("CopyrightNotice",f,h,[String.fromCharCode.apply(null,b.subarray(d,
d+=r))]);break;case 3:e=new a.b("SequenceTrackName",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 4:e=new a.b("InstrumentName",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 5:e=new a.b("Lyrics",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 6:e=new a.b("Marker",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 7:e=new a.b("CuePoint",f,h,[String.fromCharCode.apply(null,b.subarray(d,d+=r))]);break;case 32:e=new a.b("MidiChannelPrefix",
f,h,[b[d++]]);break;case 47:e=new a.b("EndOfTrack",f,h,[]);break;case 81:e=new a.b("SetTempo",f,h,[b[d++]<<16|b[d++]<<8|b[d++]]);break;case 84:e=new a.b("SmpteOffset",f,h,[b[d++],b[d++],b[d++],b[d++],b[d++]]);break;case 88:e=new a.b("TimeSignature",f,h,[b[d++],b[d++],b[d++],b[d++]]);break;case 89:e=new a.b("KeySignature",f,h,[b[d++],b[d++]]);break;case 127:e=new a.b("SequencerSpecific",f,h,[b.subarray(d,d+=r)]);break;default:e=new a.b("Unknown",f,h,[q,b.subarray(d,d+=r)])}break;default:console.warn("unknown message:",
g.toString(16))}break;default:throw Error("invalid status");}f=d-u;u=b.subarray(u,u+f);u[0]=g;e instanceof a.a&&"NoteOn"===e.subtype&&0===e.parameter2&&(e.subtype=m[8],u=new Uint8Array([128|e.channel,e.parameter1,e.parameter2]));t.push(u);c.push(e)}this.tracks.push(c);this.plainTracks.push(t)}}},function(t,k,e){e.d(k,"a",function(){return g});class g{constructor(a,b={}){this.input=a;this.ip=b.index||0;this.timeDivision=b.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const a=
this.input;let b=this.ip;const c=this.header={},p=String.fromCharCode(a[b++],a[b++],a[b++],a[b++]);if("melo"!==p)throw Error("invalid MFi signature:"+p);c.fileLength=(a[b++]<<24|a[b++]<<16|a[b++]<<8|a[b++])>>>0;c.trackOffset=(a[b++]<<16|a[b++])+b;c.dataMajorType=a[b++];c.dataMinorType=a[b++];c.numberOfTracks=a[b++];this.ip=b}parseDataInformation(){const a=this.input;let b=this.ip;const c=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};
let p,d;for(;b<this.header.trackOffset;)switch(p=String.fromCharCode(a[b++],a[b++],a[b++],a[b++]),d=a[b++]<<8|a[b++],p){case "titl":case "copy":case "vers":case "date":case "prot":c[p]=String.fromCharCode.apply(null,a.subarray(b,b+=d));break;case "sorc":c[p]=a[b++];break;case "note":c[p]=a[b++]<<8|a[b++];break;case "exst":break;default:c[p]=a.subarray(b,b+=d)}this.ip=b}parseTracks(){const a=this.input;let b=this.ip;let c;const p=this.tracks=[];let d,m,f;const q=()=>{var c=a[b++]<<8|a[b++];c=b+c;const f=
[];let d;if(1!==a[b++])throw Error("invalid EditInstrument const value:"+a[b-1]);for(;b<c;)d={},d.part=a[b++]>>4&3,d.modulator={ML:a[b]>>5,VIV:a[b]>>4&1,EG:a[b]>>3&1,SUS:a[b]>>2&1,RR:(a[b++]&3)<<2|a[b]>>6,DR:a[b]>>4&15,AR:(a[b++]&3)<<2|a[b]>>6,SL:a[b]>>4&15,TL:(a[b++]&3)<<4|a[b]>>4,WF:a[b]>>3&1,FB:a[b++]&7},d.carrier={ML:a[b]>>5,VIV:a[b]>>4&1,EG:a[b]>>3&1,SUS:a[b]>>2&1,RR:(a[b++]&3)<<2|a[b]>>6,DR:a[b]>>4&15,AR:(a[b++]&3)<<2|a[b]>>6,SL:a[b]>>4&15,TL:(a[b++]&3)<<4|a[b]>>4,WF:a[b]>>3&1,FB:a[b++]&7},
d.octaveSelect=a[b++]&3,f.push(d);return f},e=()=>{var c=a[b++]<<8|a[b++];c=b+c;if(17!==a[b++])throw Error("invalid DeviceSpecific const value:"+a[b-1]);return{data:a.subarray(b,b+=c-b)}};m=0;for(f=this.header.numberOfTracks;m<f;++m){var l=String.fromCharCode(a[b++],a[b++],a[b++],a[b++]);if("trac"!==l)throw Error("invalid track signature:"+l);l=a[b++]<<24|a[b++]<<16|a[b++]<<8|a[b++];l=b+l;for(d=p[m]=[];b<l;){c={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};
c.deltaTime=deltaTime=a[b++];var n=a[b++];if(255!==n)c.type="note",c.subType="Note",c.voice=n>>6,c.key=n&63,noteLength=c.length=a[b++],1===this.dataInformation.note&&(n=a[b++],c.velocity=n>>2,c.octaveShift=n&3);else switch(c.type="meta",n=a[b++],n>>4){case 11:switch(n&15){case 0:c.subType="MasterVolume";c.value=a[b++];break;case 10:c.subType="DrumScale";c.value={channel:a[b]>>3&7,drum:a[b++]&1};break;default:throw Error("unknown message type:"+n.toString(16));}break;case 12:c.subType="SetTempo";c.value=
{timeBase:7===(n&7)?NaN:Math.pow(2,n&7)*(0===(n&8)?6:15),tempo:a[b++]};break;case 13:switch(n&15){case 0:c.subType="Point";c.value=a[b++];break;case 13:c.subType="Loop";c.value={id:a[b]>>6,count:a[b]>>2&15,point:a[b++]&3};break;case 14:c.subType="Nop";c.value=a[b++];break;case 15:c.subType="EndOfTrack";c.value=a[b++];break;default:throw Error("unkwnon message type:"+n.toString(16));}break;case 14:switch(n&15){case 0:c.subType="InstrumentLowPart";c.value={part:a[b]>>6,instrument:a[b++]&63};break;case 1:c.subType=
"InstrumentHighPart";c.value={part:a[b]>>6,instrument:a[b++]&1};break;case 2:c.subType="Volume";c.value={part:a[b]>>6,volume:a[b++]&63};break;case 3:c.subType="Valance";c.value={part:a[b]>>6,valance:a[b++]&63};break;case 4:c.subType="PitchBend";c.value={part:a[b]>>6,value:a[b++]&63};break;case 5:c.subType="ChannelAssign";c.value={part:a[b]>>6,channel:a[b++]&63};break;case 6:c.subType="VolumeChange";c.value={part:a[b]>>6,volume:(a[b++]&63)<<26>>26};break;case 7:c.subType="PitchBendRange";c.value={part:a[b]>>
6,value:a[b++]&63};break;case 8:case 9:c.subType="MasterCoarseTuning";c.value={part:a[b]>>6,value:a[b++]&63};break;case 10:c.subType="Modulation";c.value={part:a[b]>>6,depth:a[b++]&63};break;default:throw Error("unkwnon message type:"+n.toString(16));}break;case 15:switch(n&15){case 0:c.subType="EditInstrument";c.value=q();break;case 1:c.subType="Vibrato";n=c;if(1!==a[b++])throw Error("invalid Vibrato const value:"+a[b-1]);var h={part:a[b++]>>5&3,switch:a[b++]>>6};n.value=h;break;case 15:c.subType=
"DeviceSpecific";c.value=e();break;default:throw Error("unkwnon message type:"+n.toString(16));}break;default:throw Error("unkwnon message type:"+n.toString(16));}d.push(c)}b=l}this.ip=b}convertToMidiTracks(){const a=[],b=this.tracks;let c;let p,d,m,f,q,e,l;const n=[];for(f=0;16>f;++f)a[f]=[],n[f]=0;f=0;for(q=b.length;f<q;++f){var h=b[f];p=[];d=m=e=0;for(l=h.length;e<l;++e)switch(c=h[e],d+=c.deltaTime,c.id=m,c.time=d,c.subType){case "Nop":break;case "Note":p[m++]=c;p[m]={id:m,type:"internal",subType:"NoteOff",
time:d+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};m++;break;case "InstrumentHighPart":var g=c;c=h[++e];if("InstrumentLowPart"!==c.subType)throw Error("broken instrument");p[m]={id:m,type:"internal",subType:"ProgramChange",time:d,part:c.value.part,instrument:g.value.instrument<<6|c.value.instrument};m++;break;default:p[m++]=c}p.sort((a,c)=>a.time>c.time?1:a.time<c.time?-1:a.id>c.id?1:a.id<c.id?-1:0);d=e=0;for(l=p.length;e<l;++e){c=p[e];d=c.time;switch(c.subType){case "Note":g=
this.applyOctaveShift(c.key+45,c.octaveShift);h=4*f+c.voice;9===h&&(g-=10);a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(144|h,g,2*c.velocity));break;case "NoteOff":g=this.applyOctaveShift(c.key+45,c.octaveShift);h=4*f+c.voice;9===h&&(g-=10);a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(128|h,g,2*c.velocity));break;case "ProgramChange":h=4*f+c.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(192|h,c.instrument));break;case "SetTempo":g=288E7/(c.value.tempo*c.value.timeBase);h=0;a[h].push(this.deltaTimeToByteArray(d-
n[h]).concat(255,81,3,g>>16&255,g>>8&255,g&255));break;case "Loop":g=c.value.count;g="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===g?-1:g);h=0;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat([255,6,g.length],g.split("").map(a=>a.charCodeAt(0))));break;case "MasterVolume":g=c.value;h=0;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(240,7,127,127,4,1,g,g,247));break;case "Modulation":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(176|h,1,2*
c.value.depth));break;case "Volume":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(176|h,7,2*c.value.volume));break;case "Valance":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(176|h,10,2*(c.value.valance-32)+64));break;case "PitchBend":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(224|h,2*c.value.value,2*c.value.value));break;case "PitchBendRange":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(176|h,100,
0),[0,176|h,101,0],[0,176|h,6,2*c.value.value]);break;case "MasterCoarseTuning":h=4*f+c.value.part;a[h].push(this.deltaTimeToByteArray(d-n[h]).concat(176|h,100,0),[0,176|h,101,2],[0,176|h,6,2*c.value.value]);break;default:continue}n[h]=c.time}}return this.toSMF(a)}applyOctaveShift(a,b){const c=[0,12,-24,-12];if(void 0!==c[b])return a+c[b];throw Error("invalid OctaveShift value:"+b);}toSMF(a){var b;let c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let e;if(void 0!==this.dataInformation.copy){var d=this.dataInformation.copy;
var m=d.length;var f=Array(m);for(b=0;b<m;++b)f[b]=d.charCodeAt(b);b=d=f;d=b.length;b=[0,255,2].concat(this.deltaTimeToByteArray(d),b);a[0].unshift(b)}m=0;for(d=a.length;m<d;++m){const d=a[m];b=[];f=0;for(e=d.length;f<e;++f)Array.prototype.push.apply(b,d[f]);e=b.length;f=[77,84,114,107,e>>24&255,e>>16&255,e>>8&255,e&255];c=c.concat(f,b)}return new Uint8Array(c)}deltaTimeToByteArray(a){const b=[];for(;128<=a;)b.unshift(a&127|(0===b.length?0:128)),a>>>=7;b.unshift(a|(0===b.length?0:128));return b}}
},function(t,k,e){e.d(k,"a",function(){return b});var g=e(1);t=e(2);var a=e(0);class b extends t.a{constructor(a,b={}){super(a,b);this.encoder=new TextEncoder("utf-8");this.input=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(a)),"text/xml").querySelectorAll("ms2 > *");this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=b.timeDivision||96}parse(){this.parseTracks();this.toPlainTrack()}parseTracks(){let c=[];const b=[];for(let a=0;a<this.input.length;a++){const d=
new g.a({timeDivision:this.timeDivision,channel:0,mml:this.input[a].textContent.trim(),ignoreTempo:!1});c=c.concat(d.events);b.push(d.endTime)}c.concat(new a.b("EndOfTrack",0,Math.max(b)));this.tracks.push(c)}}},function(t,k){function e(a,c){var f=[],d="";"string"===typeof c?c={section:c,whitespace:!1}:(c=c||{},c.whitespace=!0===c.whitespace);var m=c.whitespace?" = ":"=";Object.keys(a).forEach(function(c,e,h){(e=a[c])&&Array.isArray(e)?e.forEach(function(a){d+=b(c+"[]")+m+b(a)+"\n"}):e&&"object"===
typeof e?f.push(c):d+=b(c)+m+b(e)+p});c.section&&d.length&&(d="["+b(c.section)+"]"+p+d);f.forEach(function(b,f,h){f=g(b).join("\\.");b=e(a[b],{section:(c.section?c.section+".":"")+f,whitespace:c.whitespace});d.length&&b.length&&(d+=p);d+=b});return d}function g(a){return a.replace(/\1/g,"\u0002LITERAL\\1LITERAL\u0002").replace(/\\\./g,"\u0001").split(/\./).map(function(a){return a.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"\u0001")})}function a(a){return'"'===a.charAt(0)&&'"'===a.slice(-1)||
"'"===a.charAt(0)&&"'"===a.slice(-1)}function b(c){return"string"!==typeof c||c.match(/[=\r\n]/)||c.match(/^\[/)||1<c.length&&a(c)||c!==c.trim()?JSON.stringify(c):c.replace(/;/g,"\\;").replace(/#/g,"\\#")}function c(c,b){c=(c||"").trim();if(a(c)){"'"===c.charAt(0)&&(c=c.substr(1,c.length-2));try{c=JSON.parse(c)}catch(n){}}else{b=!1;for(var f="",d=0,e=c.length;d<e;d++){var l=c.charAt(d);if(b)f=-1!=="\\;#".indexOf(l)?f+l:f+("\\"+l),b=!1;else if(-1!==";#".indexOf(l))break;else"\\"===l?b=!0:f+=l}b&&(f+=
"\\");return f.trim()}return c}k.parse=k.decode=function(a){var b={},f=b,d=null,e=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;a.split(/[\r\n]+/g).forEach(function(a,g,h){if(a&&!a.match(/^\s*[;#]/)&&(g=a.match(e)))if(void 0!==g[1])d=c(g[1]),f=b[d]=b[d]||{};else{a=c(g[2]);g=g[3]?c(g[4]):!0;switch(g){case "true":case "false":case "null":g=JSON.parse(g)}2<a.length&&"[]"===a.slice(-2)&&(a=a.substring(0,a.length-2),f[a]?Array.isArray(f[a])||(f[a]=[f[a]]):f[a]=[]);Array.isArray(f[a])?f[a].push(g):f[a]=g}});Object.keys(b).filter(function(a,
c,f){if(!b[a]||"object"!==typeof b[a]||Array.isArray(b[a]))return!1;c=g(a);var d=b;f=c.pop();var h=f.replace(/\\\./g,".");c.forEach(function(a,c,b){d[a]&&"object"===typeof d[a]||(d[a]={});d=d[a]});if(d===b&&h===f)return!1;d[h]=b[a];return!0}).forEach(function(a,c,f){delete b[a]});return b};k.stringify=k.encode=e;k.safe=b;k.unsafe=c;var p="undefined"!==typeof process&&"win32"===process.platform?"\r\n":"\n"},function(t,k,e){e.d(k,"a",function(){return b});var g=e(1),a=e(0);t=e(2);class b extends t.a{constructor(a,
b={}){super(a,b)}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){const c=this.input.Settings;this.encoder=new TextEncoder(c.Encoding||"shift_jis");this.title=c.Title;this.author=c.Source;this.timeDivision=c.TimeBase|0||32;const b=[];b.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));b.push(new a.b("SequenceTrackName",0,0,[this.title]));b.push(new a.b("CopyrightNotice",0,0,[this.author]));b.push(new a.b("TextEvent",0,0,[c.Memo]));b.push(new a.b("TimeSignature",0,0,
[c.TimeSignatureNN|0||4,c.TimeSignatureDD|0||4,0,0]));b.push(new a.b("EndOfTrack",0,0));this.tracks.push(b);delete this.input["3MLE EXTENSION"];delete this.input.Settings}parseTracks(){var c=this.input;const b=[];var d=[],e=[];for(const a in c)c.hasOwnProperty(a)&&(a.match(/^Channel(\d+)$/i)&&(d[(RegExp.$1|0)-1]=Object.keys(c[a]).join("").replace(/\/\*([^*]|\*[^\/])*\*\//g,"")),a.match(/^ChannelProperty(\d+)$/i)&&(e[(RegExp.$1|0)-1]={name:c[a].Name,instrument:c[a].Patch|0,panpot:c[a].Pan|0}));c=[];
for(const a in d)d.hasOwnProperty(a)&&(c[a]=void 0!==e[a]?{mml:d[a],name:e[a].name||"",instrument:e[a].instrument||0,panpot:e[a].panpot||64}:{mml:d[a],name:"",instrument:0,panpot:64});for(const f in c)c.hasOwnProperty(f)&&(e=f|0,d=[],""!==c[f].mml&&(d.push(new a.b("InsturumentName",0,48,[c[f].name])),d.push(new a.a("ProgramChange",0,96,e,c[f].instrument)),d.push(new a.a("ControlChange",0,154,e,10,c[f].panpot)),e=new g.a({timeDivision:this.timeDivision,channel:e,timeOffset:386,mml:c[f].mml}),d=d.concat(e.events),
b.push(e.endTime),d.concat(new a.b("EndOfTrack",0,Math.max(b))),this.tracks.push(d)));this.numberOfTracks=this.tracks.length}}},function(t,k,e){e.d(k,"a",function(){return b});var g=e(1);t=e(2);var a=e(0);class b extends t.a{constructor(a,b={}){super(a,b);this.input=String.fromCharCode.apply("",new Uint16Array(a)).split(/\r\n|\r|\n/);this.tracks=[];this.plainTracks=[];this.numberOfTracks=1;this.timeDivision=b.timeDivision||96}parse(){this.parseHeader();this.parseTracks();this.toPlainTrack()}parseHeader(){this.encoder=
new TextEncoder("utf-8");var c=["mml-track","name","program","songProgram","panpot"];const b={};var d=-1;b.track=[];for(let a=0;a<this.input.length;a++){const f=this.input[a].trim();if(0===a){if("[mml-score]"!==f)throw Error("Not MabiIcco File.");continue}const [e,g]=f.split("=");c.includes(e)?"mml-track"===e?(d++,b.track[d]={},b.track[d].mml=g):b.track[d][e]="name"===e?g:g|0:b[e]=g}this.title=b.title;this.author=b.author;c=""!==b.tempo?b.tempo.split("T"):[0,120];this.timeDivision=96;this.tempo=c[1]|
0;c=b.time.split("/");d=[];d.push(new a.c("SystemExclusive",0,0,[126,127,9,1]));d.push(new a.b("SequenceTrackName",0,0,[this.title]));d.push(new a.b("CopyrightNotice",0,0,[this.author]));d.push(new a.b("TimeSignature",0,0,[c[0]|0||4,c[1]|0||4,0,0]));d.push(new a.b("SetTempo",0,0,[Math.floor(6E7/this.tempo)]));d.push(new a.b("EndOfTrack",0,0));this.tracks.push(d);this.input=b.track}parseTracks(){let b=[];const e=[];for(let c=0;c<this.input.length;c++){const f=this.input[c];if(!f.mml.match(/^(?:MML@)(.*)/gm))continue;
const q=RegExp.$1.split(",");b.push(new a.b("InsturumentName",0,48,[f.name]));b.push(new a.a("ProgramChange",0,96,c,f.program));-1!==f.songProgram&&b.push(new a.a("ProgramChange",0,112,15,f.songProgram));b.push(new a.a("ControlChange",0,154,c,10,f.panpot));for(let a=0;a<f.mml.length;a++){var d=c;3===a&&-1!==f.songProgram&&(d=15);void 0!==q[a]&&(d=new g.a({timeDivision:this.timeDivision,channel:d,timeOffset:386,mml:q[a],igonoreTempo:1===d}),b=b.concat(d.events),e.push(d.endTime))}b.concat(new a.b("EndOfTrack",
0,Math.max(e)));this.tracks.push(b)}this.numberOfTracks=this.tracks.length}}},function(t,k,e){e.r(k);e.d(k,"Player",function(){return m});var g=e(4),a=e(5),b=e(6),c=e(2),p=e(8),d=e(9);class m{constructor(a="#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=[];this.timer=0;this.sequence={};this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=!1;this.tempoRate=1;this.masterVolume=16383;this.lyrics=this.copyright=this.sequenceName=this.textEvent="";
this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a)}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(a=0;16>a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();this.initSequence();
this.pause=!0;this.track=null;this.resume=-1;this.textEvent=this.lyrics=this.copyright=this.sequenceName=this.sequence=this.text=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",b=>{"link,ready"===b.data&&a.sendInitMessage()},!1)}initSequence(){this.tempo=5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");
this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px",a.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=
0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+",06,02","*"),a.postMessage("midi,b"+b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,c=a=>{"string"===
typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);this.target.firstChild&&this.target.removeChild(this.target.firstChild);const b=this.webMidiLink=this.window.document.createElement("iframe");b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",
c,!1);const f=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",f,!1);let d=0;this.window.addEventListener("resize",()=>{0<d&&clearTimeout(d);d=setTimeout(f,100)},!1)}else this.webMidiLink.addEventListener("message",c,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),
"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,d=this.webMidiLink.contentWindow;let e=this.position||0;const h=[],g=()=>{const f=c[e].time,l=c.length;let k,n,m,q=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{k=c[e].event;switch(k.subtype){case "TextEvent":a.textEvent=k.data[0];break;case "Lyrics":a.lyrics=k.data[0];break;case "Maker":if(a.enableFalcomLoop)switch(k.data[0]){case "A":h[0]={pos:e};break;case "B":if(h[0]&&"number"===
typeof h[0].pos){e=h[0].pos;a.timer=a.window.setTimeout(g,0);a.position=e;return}}if(a.enableMFiLoop&&(n=k.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===n[1])h[n[2]|0]=h[n[2]]||{pos:e,count:n[3]|0};else if("END"===n[1]&&a.enableMFiLoop){m=h[n[2]|0];if(0!==m.count){0<m.count&&m.count--;e=m.pos;a.timer=a.window.setTimeout(g,0);a.position=e;return}h[n[2]|0]=null}break;case "SetTempo":a.tempo=k.data[0]}"ControlChange"===k.subtype&&111===k.parameter1&&(h[0]={pos:e});d.postMessage(c[e++].webMidiLink,
"*")}while(e<l&&c[e].time===f);e<l?(q=Date.now()-q,a.timer=a.window.setTimeout(g,a.tempo/(1E3*b)*(c[e].time-f-q)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&h[0]&&"number"===typeof h[0].pos?e=h[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=e;a.time=f}};this.pause?(this.timer=a.window.setTimeout(g,this.resume),this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(g,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=new g["default"](a);this.init();a.parse();
this.mergeMidiTracks(a)}loadMldFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b.convertToMidiTracks())}loadMs2MmlFile(a){a=new b.a(a);this.init();a.parse();this.mergeMidiTracks(a)}loadMakiMabiSequenceFile(a){a=new c.a(a);this.init();a.parse();this.mergeMidiTracks(a)}load3MleFile(a){a=new p.a(a);this.init();a.parse();this.mergeMidiTracks(a)}loadMabiIccoFile(a){a=new d.a(a);this.init();a.parse();this.mergeMidiTracks(a)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var d=Array(c.length);
const e=a.plainTracks;let f,g,k,m;f=0;for(g=c.length;f<g;++f)d[f]=0;f=0;for(g=c.length;f<g;++f)for(d=c[f],k=0,m=d.length;k<m;++k){if(0===a.formatType||0===f)"SequenceTrackName"===d[k].subtype?this.sequenceName=d[k].data[0]:"CopyrightNotice"===d[k].subtype&&(this.copyright=d[k].data[0]);b.push({track:f,eventId:k,time:d[k].time,event:d[k],webMidiLink:"midi,"+Array.prototype.map.call(e[f][k],a=>a.toString(16)).join(",")})}b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?
-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getLyrics(){return this.lyrics}getTextEvent(){return this.textEvent}getPosition(){return this.position}setPosition(a){this.position=a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0",
"*")}getTime(a){a*=this.tempo/6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
