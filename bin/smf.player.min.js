(function(){/*
 2007-2013,2018,2019 Logue <http://logue.be/> All rights reserved.
 @license MIT
 @logue/smfplayer v0.2.2 | imaya / GREE Inc. / Logue | license: MIT */
'use strict';(function(u,h){"object"===typeof exports&&"object"===typeof module?module.exports=h():"function"===typeof define&&define.amd?define("SMF",[],h):"object"===typeof exports?exports.SMF=h():u.SMF=h()})("undefined"!==typeof self?self:this,function(){return function(u){function h(f){if(l[f])return l[f].exports;var b=l[f]={i:f,l:!1,exports:{}};u[f].call(b.exports,b,b.exports,h);b.l=!0;return b.exports}var l={};h.m=u;h.c=l;h.d=function(f,b,a){h.o(f,b)||Object.defineProperty(f,b,{enumerable:!0,
get:a})};h.r=function(f){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(f,Symbol.toStringTag,{value:"Module"});Object.defineProperty(f,"__esModule",{value:!0})};h.t=function(f,b){b&1&&(f=h(f));if(b&8||b&4&&"object"===typeof f&&f&&f.__esModule)return f;var a=Object.create(null);h.r(a);Object.defineProperty(a,"default",{enumerable:!0,value:f});if(b&2&&"string"!=typeof f)for(var c in f)h.d(a,c,function(a){return f[a]}.bind(null,c));return a};h.n=function(f){var b=f&&f.__esModule?
function(){return f["default"]}:function(){return f};h.d(b,"a",b);return b};h.o=function(f,b){return Object.prototype.hasOwnProperty.call(f,b)};h.p="";return h(h.s=6)}([function(u,h,l){l.d(h,"a",function(){return b});l.d(h,"c",function(){return a});l.d(h,"b",function(){return c});class f{constructor(a,b,c){this.subtype=a;this.deltaTime=b;this.time=c}}class b extends f{constructor(a,b,c,k,f,q){super(a,b,c);this.channel=k;this.parameter1=f;this.parameter2=q}}class a extends f{constructor(a,b,c,k){super(a,
b,c);this.data=k}}class c extends f{constructor(a,b,c,k){super(a,b,c);this.data=k}}},function(u,h,l){l.d(h,"a",function(){return f});class f{constructor(a,b={}){this.input=a;this.ip=b.index||0;this.length=b.length||a.length-this.ip;this.offset=this.ip;this.padding=void 0!==b.padding?b.padding:!0;this.bigEndian=void 0!==b.bigEndian?b.bigEndian:!1}parse(){const a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()}parseChunk(){var a=this.input;let c=this.ip;this.chunkList.push(new b(String.fromCharCode(a[c++],
a[c++],a[c++],a[c++]),a=this.bigEndian?(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0:(a[c++]|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,c));c+=a;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}getChunk(a){a=this.chunkList[a];return void 0===a?null:a}getNumberOfChunks(){return this.chunkList.length}}class b{constructor(a,b,e){this.type=a;this.size=b;this.offset=e}}},function(u,h,l){l.r(h);l.d(h,"default",function(){return a});var f=l(1),b=l(0);class a{constructor(a,b={}){b.padding=!1;b.bigEndian=!0;this.input=
a;this.ip=b.index||0;this.chunkIndex=0;this.riffParser_=new f.a(a,b);this.timeDivision=this.numberOfTracks=this.formatType=0;this.tracks=[];this.plainTracks=[]}parse(){let a,b;this.riffParser_.parse();this.parseHeaderChunk();a=0;for(b=this.numberOfTracks;a<b;++a)this.parseTrackChunk()}parseHeaderChunk(){const a=this.riffParser_.getChunk(this.chunkIndex++),b=this.input;let d=a.offset;if(!a||"MThd"!==a.type)throw Error("invalid header signature");this.formatType=b[d++]<<8|b[d++];this.numberOfTracks=
b[d++]<<8|b[d++];this.timeDivision=b[d++]<<8|b[d++]}parseTrackChunk(){var a=this.riffParser_.getChunk(this.chunkIndex++);const e=this.input;let d=a.offset,f=0;var k=0;let t=0;var q=0;let v=-1,n=-1,g=q=0;var p=0;let r=k=0,m;const h=()=>{let a=0,b;do b=e[d++],a=a<<7|b&127;while(0!==(b&128));return a};if(!a||"MTrk"!==a.type)throw Error("invalid header signature");f=a.offset+a.size;a=[];const l=[];for(;d<f;){k=h();g+=k;p=d;r=e[d++];t=r>>4&15;q=r&15;8>t?(t=v,q=n,r=v<<4|n,d--,p--):(v=t,n=q);const c=[,,
,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(t){case 8:case 9:case 10:case 11:case 13:case 14:m=new b.a(c[t],k,g,q,e[d++],e[d++]);break;case 12:m=new b.a(c[t],k,g,q,e[d++]);break;case 15:switch(q){case 0:q=h();if(247!==e[d+q-1])throw Error("invalid SysEx event");m=new b.c("SystemExclusive",k,g,e.subarray(d,(d+=q)-1));break;case 7:q=h();m=new b.c("SystemExclusive(F7)",k,g,e.subarray(d,d+=q));break;case 15:t=e[d++];q=h();switch(t){case 0:m=
new b.b("SequenceNumber",k,g,[e[d++],e[d++]]);break;case 1:m=new b.b("TextEvent",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 2:m=new b.b("CopyrightNotice",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 3:m=new b.b("SequenceTrackName",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 4:m=new b.b("InstrumentName",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 5:m=new b.b("Lyrics",k,g,[String.fromCharCode.apply(null,
e.subarray(d,d+=q))]);break;case 6:m=new b.b("Marker",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 7:m=new b.b("CuePoint",k,g,[String.fromCharCode.apply(null,e.subarray(d,d+=q))]);break;case 32:m=new b.b("MidiChannelPrefix",k,g,[e[d++]]);break;case 47:m=new b.b("EndOfTrack",k,g,[]);break;case 81:m=new b.b("SetTempo",k,g,[e[d++]<<16|e[d++]<<8|e[d++]]);break;case 84:m=new b.b("SmpteOffset",k,g,[e[d++],e[d++],e[d++],e[d++],e[d++]]);break;case 88:m=new b.b("TimeSignature",k,g,
[e[d++],e[d++],e[d++],e[d++]]);break;case 89:m=new b.b("KeySignature",k,g,[e[d++],e[d++]]);break;case 127:m=new b.b("SequencerSpecific",k,g,[e.subarray(d,d+=q)]);break;default:m=new b.b("Unknown",k,g,[t,e.subarray(d,d+=q)])}break;default:console.warn("unknown message:",r.toString(16))}break;default:throw Error("invalid status");}k=d-p;p=e.subarray(p,p+k);p[0]=r;m instanceof b.a&&"NoteOn"===m.subtype&&0===m.parameter2&&(m.subtype=c[8],p=new Uint8Array([128|m.channel,m.parameter1,m.parameter2]));l.push(p);
a.push(m)}this.tracks.push(a);this.plainTracks.push(l)}}},function(u,h,l){l.d(h,"a",function(){return f});class f{constructor(b,a={}){this.input=b;this.ip=a.index||0;this.timeDivision=a.timeDivision||48}parse(){this.parseHeader();this.parseDataInformation();this.parseTracks()}parseHeader(){const b=this.input;let a=this.ip;const c=this.header={},e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("melo"!==e)throw Error("invalid MFi signature:"+e);c.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>
0;c.trackOffset=(b[a++]<<16|b[a++])+a;c.dataMajorType=b[a++];c.dataMinorType=b[a++];c.numberOfTracks=b[a++];this.ip=a}parseDataInformation(){const b=this.input;let a=this.ip;const c=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let e,d;for(;a<this.header.trackOffset;)switch(e=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),d=b[a++]<<8|b[a++],e){case "titl":case "copy":case "vers":case "date":case "prot":c[e]=String.fromCharCode.apply(null,
b.subarray(a,a+=d));break;case "sorc":c[e]=b[a++];break;case "note":c[e]=b[a++]<<8|b[a++];break;case "exst":break;default:c[e]=b.subarray(a,a+=d)}this.ip=a}parseTracks(){const b=this.input;let a=this.ip;let c;const e=this.tracks=[];let d,f,k;const t=()=>{var e=b[a++]<<8|b[a++];e=a+e;const c=[];let d;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<e;)d={},d.part=b[a++]>>4&3,d.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>
4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},d.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},d.octaveSelect=b[a++]&3,c.push(d);return c},q=()=>{var e=b[a++]<<8|b[a++];e=a+e;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=e-a)}};f=0;for(k=this.header.numberOfTracks;f<
k;++f){var h=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==h)throw Error("invalid track signature:"+h);h=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];h=a+h;for(d=e[f]=[];a<h;){c={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null};c.deltaTime=deltaTime=b[a++];var n=b[a++];if(255!==n)c.type="note",c.subType="Note",c.voice=n>>6,c.key=n&63,noteLength=c.length=b[a++],1===this.dataInformation.note&&(n=b[a++],c.velocity=n>>2,c.octaveShift=n&3);else switch(c.type=
"meta",n=b[a++],n>>4){case 11:switch(n&15){case 0:c.subType="MasterVolume";c.value=b[a++];break;case 10:c.subType="DrumScale";c.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+n.toString(16));}break;case 12:c.subType="SetTempo";c.value={timeBase:7===(n&7)?NaN:Math.pow(2,n&7)*(0===(n&8)?6:15),tempo:b[a++]};break;case 13:switch(n&15){case 0:c.subType="Point";c.value=b[a++];break;case 13:c.subType="Loop";c.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;
case 14:c.subType="Nop";c.value=b[a++];break;case 15:c.subType="EndOfTrack";c.value=b[a++];break;default:throw Error("unkwnon message type:"+n.toString(16));}break;case 14:switch(n&15){case 0:c.subType="InstrumentLowPart";c.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:c.subType="InstrumentHighPart";c.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:c.subType="Volume";c.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:c.subType="Valance";c.value={part:b[a]>>6,valance:b[a++]&63};break;
case 4:c.subType="PitchBend";c.value={part:b[a]>>6,value:b[a++]&63};break;case 5:c.subType="ChannelAssign";c.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:c.subType="VolumeChange";c.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:c.subType="PitchBendRange";c.value={part:b[a]>>6,value:b[a++]&63};break;case 8:case 9:c.subType="MasterCoarseTuning";c.value={part:b[a]>>6,value:b[a++]&63};break;case 10:c.subType="Modulation";c.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+
n.toString(16));}break;case 15:switch(n&15){case 0:c.subType="EditInstrument";c.value=t();break;case 1:c.subType="Vibrato";n=c;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var g={part:b[a++]>>5&3,"switch":b[a++]>>6};n.value=g;break;case 15:c.subType="DeviceSpecific";c.value=q();break;default:throw Error("unkwnon message type:"+n.toString(16));}break;default:throw Error("unkwnon message type:"+n.toString(16));}d.push(c)}a=h}this.ip=a}convertToMidiTracks(){const b=[],a=this.tracks;
let c;let e,d,f,k,h,q,l;const n=[];for(k=0;16>k;++k)b[k]=[],n[k]=0;k=0;for(h=a.length;k<h;++k){var g=a[k];e=[];d=f=q=0;for(l=g.length;q<l;++q)switch(c=g[q],d+=c.deltaTime,c.id=f,c.time=d,c.subType){case "Nop":break;case "Note":e[f++]=c;e[f]={id:f,type:"internal",subType:"NoteOff",time:d+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};f++;break;case "InstrumentHighPart":var p=c;c=g[++q];if("InstrumentLowPart"!==c.subType)throw Error("broken instrument");e[f]={id:f,type:"internal",
subType:"ProgramChange",time:d,part:c.value.part,instrument:p.value.instrument<<6|c.value.instrument};f++;break;default:e[f++]=c}e.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0);d=q=0;for(l=e.length;q<l;++q){c=e[q];d=c.time;switch(c.subType){case "Note":p=this.applyOctaveShift(c.key+45,c.octaveShift);g=4*k+c.voice;9===g&&(p-=10);b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(144|g,p,2*c.velocity));break;case "NoteOff":p=this.applyOctaveShift(c.key+45,c.octaveShift);g=
4*k+c.voice;9===g&&(p-=10);b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(128|g,p,2*c.velocity));break;case "ProgramChange":g=4*k+c.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(192|g,c.instrument));break;case "SetTempo":p=288E7/(c.value.tempo*c.value.timeBase);g=0;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(255,81,3,p>>16&255,p>>8&255,p&255));break;case "Loop":p=c.value.count;p="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===p?-1:p);g=0;b[g].push(this.deltaTimeToByteArray(d-
n[g]).concat([255,6,p.length],p.split("").map(a=>a.charCodeAt(0))));break;case "MasterVolume":p=c.value;g=0;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(240,7,127,127,4,1,p,p,247));break;case "Modulation":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(176|g,1,2*c.value.depth));break;case "Volume":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(176|g,7,2*c.value.volume));break;case "Valance":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-
n[g]).concat(176|g,10,2*(c.value.valance-32)+64));break;case "PitchBend":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(224|g,2*c.value.value,2*c.value.value));break;case "PitchBendRange":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(176|g,100,0),[0,176|g,101,0],[0,176|g,6,2*c.value.value]);break;case "MasterCoarseTuning":g=4*k+c.value.part;b[g].push(this.deltaTimeToByteArray(d-n[g]).concat(176|g,100,0),[0,176|g,101,2],[0,176|g,6,2*c.value.value]);break;
default:continue}n[g]=c.time}}console.log(b);return this.toSMF(b)}applyOctaveShift(b,a){const c=[0,12,-24,-12];if(void 0!==c[a])return b+c[a];throw Error("invalid OctaveShift value:"+a);}toSMF(b){var a;let c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];let e;if(void 0!==this.dataInformation.copy){var d=this.dataInformation.copy;var f=d.length;var k=Array(f);for(a=0;a<f;++a)k[a]=d.charCodeAt(a);a=d=k;d=a.length;a=[0,255,2].concat(this.deltaTimeToByteArray(d),a);b[0].unshift(a)}f=0;for(d=b.length;f<d;++f){const d=
b[f];a=[];k=0;for(e=d.length;k<e;++k)Array.prototype.push.apply(a,d[k]);e=a.length;k=[77,84,114,107,e>>24&255,e>>16&255,e>>8&255,e&255];c=c.concat(k,a)}return new Uint8Array(c)}deltaTimeToByteArray(b){const a=[];for(;128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a}}},function(u,h,l){l.d(h,"a",function(){return b});var f=l(5);u=l(3);class b extends u.a{constructor(a,b){super(a,b);this.input=a;this.tracks=[]}parse(){this.parseHeader();this.parseTracks()}parseHeader(){this.trackElements=
(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(this.input)),"text/xml").querySelectorAll("ms2 > *");this.tracks=[];this.timeDivision=96;this.dataInformation=[];this.plainTracks=[]}parseTracks(){let a=[],b=[];for(let c=0;c<this.trackElements.length;c++){var e=new f.a({timeDivision:this.timeDivision});const d=e.parse(this.trackElements[c].textContent.trim(),0);a=a.concat(d);e=e.toPlainTrack(d);b=b.concat(e)}this.tracks.push(a);this.plainTracks.push(b)}}},function(u,h,l){l.d(h,
"a",function(){return b});var f=l(0);class b{constructor(a={}){this.timeDivision=a.division||96}parse(a,b){let e=0,c=!1,h=8,k=4,t=this.timeDivision;const q={c:0,d:2,e:4,f:5,g:7,a:9,b:11};a=a.match(/[A-GLNORTV<>][\+#-]?[0-9]*\.?&?/ig);const l=[],n=2*this.timeDivision,g=4*this.timeDivision;let p=0;for(const d in a)if(a.hasOwnProperty(d)){let m=t;if(a[d].match(/([LOTV<>])([1-9][0-9]*|0?)(\.?)(&?)/i)){var r=parseInt(RegExp.$2);1==c&&"&"!==RegExp.$4&&(c=!1,l.push(new f.a("NoteOff",0,p,b,e)));switch(RegExp.$1){case "L":case "l":1<=
r&&r<=n&&(t=Math.floor(g/r),"."==RegExp.$3&&(t=Math.floor(1.5*t)));break;case "O":case "o":0<=r&&8>=r&&(k=r);break;case "T":case "t":l.push(new f.b("SetTempo",0,p,[Math.floor(6E7/r)]));break;case "V":case "v":0<=r&&15>=r&&(h=r);break;case "<":k=0>=k?0:k-1;break;case ">":k=8<=k?8:k+1}}else a[d].match(/([A-GN])([\+#-]?)([0-9]*)(\.?)(&?)/i)?(r=parseInt(RegExp.$3,10),"n"!==RegExp.$1&&"N"!==RegExp.$1&&(1<=r&&r<=n&&(m=Math.floor(g/r)),"."===RegExp.$4&&(m=Math.floor(1.5*m)),r=12*k+q[RegExp.$1.toLowerCase()],
"+"===RegExp.$2||"#"===RegExp.$2?r++:"-"===RegExp.$2&&r--),r+=12,0==c&&l.push(new f.a("NoteOn",0,p,b,r,8*h)),1==c&&r!==e&&l.push(new f.a("NoteOff",0,p,b,e)),p+=m,"&"==RegExp.$5?(c=!0,e=r):(c=!1,l.push(new f.a("NoteOff",0,p,b,r)))):a[d].match(/[rR]([0-9]*)(\.?)/)?(r=parseInt(RegExp.$1,10),1<=r&&r<=n&&(m=Math.floor(g/r)),"."==RegExp.$2&&(m=Math.floor(1.5*m)),p+=m):console.warn("unknown signeture.",a[d]);1==c&&(c=!1,l.push(new f.a("NoteOff",0,p,b,e)))}return l}toPlainTrack(a){const b=[];for(const e in a)if(a.hasOwnProperty(e)){const c=
a[e];let h;if(c instanceof f.a)switch(c.subtype){case "NoteOn":h=0===c.parameter2?new Uint8Array([128|c.channel,c.parameter1,c.parameter2]):new Uint8Array([144|c.channel,c.parameter1,c.parameter2]);break;case "NoteOff":h=new Uint8Array([128|c.channel,c.parameter1,c.parameter2])}else if(c instanceof f.b)switch(c.subtype){case "SetTempo":h=new Uint8Array([255,81,3,7,161,32])}b.push(h)}return b}}},function(u,h,l){l.r(h);l.d(h,"Player",function(){return c});var f=l(2),b=l(3),a=l(4);class c{constructor(a=
"#wml"){this.tempo=5E5;this.pause=!0;this.ready=!1;this.position=0;this.track=[];this.timer=0;this.sequence={};this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=!1;this.tempoRate=1;this.masterVolume=16383;this.sequenceName="";this.copyright=[];this.webMidiLink=null;this.loaded=this.time=this.length=0;this.window=window;this.target=this.window.document.querySelector(a)}setCC111Loop(a){this.enableCC111Loop=a}setFalcomLoop(a){this.enableFalcomLoop=a}setMFiLoop(a){this.enableMFiLoop=
a}setLoop(a){this.enableLoop=a}stop(){let a;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(a=0;16>a;++a)this.webMidiLink.contentWindow.postMessage("midi,b"+a.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop();this.initSequence();this.pause=!0;this.track=null;this.resume=-1;this.copyright=this.sequenceName=this.sequence=null;this.timeTotal=this.time=this.position=this.length=0;this.window.clearTimeout(this.timer);const a=this;this.ready?this.sendInitMessage():
this.window.addEventListener("message",b=>{"link,ready"===b.data&&a.sendInitMessage()},!1)}initSequence(){this.tempo=5E5;this.position=0;this.sendInitMessage();this.pause=!1}play(){const a=this;if(!this.webMidiLink)throw Error("WebMidiLink not found");this.ready?this.track?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):console.warn("Midi file is not loaded."):this.window.addEventListener("message",b=>{"link,ready"===b.data&&
(a.ready=!0,a.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px",a.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const a=this.webMidiLink.contentWindow;let b;for(b=0;16>b;++b)a.postMessage("midi,b"+b.toString(16)+",128,0","*"),a.postMessage("midi,b"+b.toString(16)+",07,64","*"),a.postMessage("midi,b"+b.toString(16)+",0a,40","*"),a.postMessage("midi,e"+b.toString(16)+",00,40","*"),a.postMessage("midi,b"+b.toString(16)+
",64,00","*"),a.postMessage("midi,b"+b.toString(16)+",65,00","*"),a.postMessage("midi,b"+b.toString(16)+",06,02","*"),a.postMessage("midi,b"+b.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(a="./wml.html"){const b=this,c=a=>{"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(b.ready=!0,b.loaded=100,b.setMasterVolume(b.masterVolume)):"progress"===a[1]&&(b.loaded=Math.round(a[2]/a[3]*1E4))))};if("string"===typeof a){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink);
this.target.firstChild&&this.target.removeChild(this.target.firstChild);const b=this.webMidiLink=this.window.document.createElement("iframe");b.src=a;b.className="wml";this.target.appendChild(b);this.window.addEventListener("message",c,!1);const e=()=>{b.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",e,!1);let d=0;this.window.addEventListener("resize",()=>{0<d&&clearTimeout(d);d=setTimeout(e,100)},!1)}else this.webMidiLink.addEventListener("message",
c,!1)}setMasterVolume(a){this.masterVolume=a;this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(a&127).toString(16)).substr(-2),("0"+(a>>7&127).toString(16)).substr(-2),"7f"].join(),"*")}setTempoRate(a){this.tempoRate=a}playSequence(){const a=this,b=this.sequence.timeDivision,c=this.track,k=this.webMidiLink.contentWindow;let f=this.position||0;const h=[],l=()=>{const d=c[f].time,e=c.length;let p,r=Date.now();if(a.pause)a.resume=Date.now()-a.resume;else{do{var m=
c[f].event;"SetTempo"===m.subtype&&(a.tempo=m.data[0]);"ControlChange"===m.subtype&&111===m.parameter1&&(h[0]={pos:f});if("Marker"===m.subtype&&("A"===m.data[0]&&(h[0]={pos:f}),"B"===m.data[0]&&a.enableFalcomLoop&&h[0]&&"number"===typeof h[0].pos)){f=h[0].pos;a.timer=a.window.setTimeout(l,0);a.position=f;return}if("Marker"===m.subtype&&(m=m.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===m[1])h[m[2]|0]=h[m[2]]||{pos:f,count:m[3]|0};else if("END"===m[1]&&a.enableMFiLoop){p=
h[m[2]|0];if(0!==p.count){0<p.count&&p.count--;f=p.pos;a.timer=a.window.setTimeout(l,0);a.position=f;return}h[m[2]|0]=null}k.postMessage(c[f++].webMidiLink,"*")}while(f<e&&c[f].time===d);f<e?(r=Date.now()-r,a.timer=a.window.setTimeout(l,a.tempo/(1E3*b)*(c[f].time-d-r)*(1/a.tempoRate))):(a.ended(),a.pause=!0,a.enableCC111Loop&&h[0]&&"number"===typeof h[0].pos?f=h[0].pos:a.enableLoop&&(a.initSequence(),a.playSequence()));a.position=f;a.time=d}};this.pause?(this.timer=a.window.setTimeout(l,this.resume),
this.pause=!1,this.resume=-1):this.timer=a.window.setTimeout(l,this.tempo/1E3*b*this.track[0].time)}loadMidiFile(a){a=new f["default"](a);this.init();a.parse();this.mergeMidiTracks(a)}loadMldFile(a){a=new b.a(a);this.init();a.parse();this.mergeMidiTracks(a.convertToMidiTracks())}loadMs2MmlFile(b){b=new a.a(b);this.init();b.parse();this.mergeMidiTracks(b)}mergeMidiTracks(a){const b=this.track=[],c=a.tracks;var e=Array(c.length);const f=a.plainTracks,h=this.copyright=[];let l,n,g,p;l=0;for(n=c.length;l<
n;++l)e[l]=0;l=0;for(n=c.length;l<n;++l)for(e=c[l],g=0,p=e.length;g<p;++g)0===a.formatType&&"SequenceTrackName"===e[g].subtype&&(this.sequenceName=e[g].data[0]),"CopyrightNotice"===e[g].subtype&&h.push(e[g].data[0]),b.push({track:l,eventId:g,time:e[g].time,event:e[g],webMidiLink:"midi,"+Array.prototype.map.call(f[l][g],a=>a.toString(16)).join(",")});b.sort((a,b)=>a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0);this.timeTotal=b.slice(-1)[0].time;
this.sequence=a}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getPosition(){return this.position}setPosition(a){this.position=a}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(a){a*=this.tempo/6E6;const b=a%3600,c=Math.ceil(b%60);return Math.floor(a/3600)+":"+("00"+Math.floor(b/
60)).slice(-2)+":"+("00"+c).slice(-2)}}}])});}).call(this || window)
