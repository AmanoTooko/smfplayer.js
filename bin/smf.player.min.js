/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {var t,u=this;function v(c,d){c=c.split(".");var e=u;c[0]in e||!e.execScript||e.execScript("var "+c[0]);for(var b;c.length&&(b=c.shift());)c.length||void 0===d?e[b]?e=e[b]:e=e[b]={}:e[b]=d}function w(c,d){function e(){}e.prototype=d.prototype;c.ma=d.prototype;c.prototype=new e;c.prototype.constructor=c;c.ga=function(b,a,c){for(var e=Array(arguments.length-2),k=2;k<arguments.length;k++)e[k-2]=arguments[k];return d.prototype[a].apply(b,e)}};function x(c,d){d=d||{};this.c=c;this.a=d.index||0;this.length=d.length||c.length-this.a;this.offset=this.a;this.padding=void 0!==d.padding?d.padding:!0;this.j=void 0!==d.j?d.j:!1}function y(c,d){c=c.b[d];return void 0===c?null:c};function z(c,d,e){this.g=c;this.P=d;this.time=e}function B(c,d,e,b,a,n){z.call(this,c,d,e);this.b=b;this.F=a;this.a=n}w(B,z);function C(c,d,e,b){z.call(this,c,d,e);this.data=b}w(C,z);function D(c,d,e,b){z.call(this,c,d,e);this.data=b}w(D,z);function F(c){var d=d||{};d.padding=!1;d.j=!0;this.b=c;this.c=0;this.a=new x(c,d);this.o=[];this.G=[]}
function G(c){function d(){var c=0;do{var d=b[a++];c=c<<7|d&127}while(0!==(d&128));return c}var e=y(c.a,c.c++),b=c.b,a=e.offset,n=-1,m=-1,k=0;if(!e||"MTrk"!==e.type)throw Error("invalid header signature");e=e.offset+e.size;for(var r=[],g=[];a<e;){var f=d();k+=f;var l=a;var h=b[a++];var q=h>>4&15;var A=h&15;8>q?(q=n,A=m,h=n<<4|m,a--,l--):(n=q,m=A);var E=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(q){case 8:case 9:case 10:case 11:case 13:case 14:var p=
new B(E[q],f,k,A,b[a++],b[a++]);break;case 12:p=new B(E[q],f,k,A,b[a++]);break;case 15:switch(A){case 0:p=d();if(247!==b[a+p-1])throw Error("invalid SysEx event");p=new C("SystemExclusive",f,k,b.subarray(a,(a+=p)-1));break;case 7:p=d();p=new C("SystemExclusive(F7)",f,k,b.subarray(a,a+=p));break;case 15:q=b[a++];p=d();switch(q){case 0:p=new D("SequenceNumber",f,k,[b[a++],b[a++]]);break;case 1:p=new D("TextEvent",f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 2:p=new D("CopyrightNotice",
f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 3:p=new D("SequenceTrackName",f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 4:p=new D("InstrumentName",f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 5:p=new D("Lyrics",f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 6:p=new D("Marker",f,k,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 7:p=new D("CuePoint",f,k,[String.fromCharCode.apply(null,b.subarray(a,
a+=p))]);break;case 32:p=new D("MidiChannelPrefix",f,k,[b[a++]]);break;case 47:p=new D("EndOfTrack",f,k,[]);break;case 81:p=new D("SetTempo",f,k,[b[a++]<<16|b[a++]<<8|b[a++]]);break;case 84:p=new D("SmpteOffset",f,k,[b[a++],b[a++],b[a++],b[a++],b[a++]]);break;case 88:p=new D("TimeSignature",f,k,[b[a++],b[a++],b[a++],b[a++]]);break;case 89:p=new D("KeySignature",f,k,[b[a++],b[a++]]);break;case 127:p=new D("SequencerSpecific",f,k,[b.subarray(a,a+=p)]);break;default:p=new D("Unknown",f,k,[q,b.subarray(a,
a+=p)])}break;default:u.console.log("unknown message:",h.toString(16))}break;default:throw Error("invalid status");}f=a-l;l=b.subarray(l,l+f);l[0]=h;p instanceof B&&"NoteOn"===p.g&&0===p.a&&(p.g=E[8],l=new Uint8Array([128|p.b,p.F,p.a]));g.push(l);r.push(p)}c.o.push(r);c.G.push(g)};function H(c){var d=d||{};this.b=c;this.a=d.index||0}
function I(c){function d(){var c=b[a++]<<8|b[a++];c=a+c;var d=[];if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;){var e={};e.part=b[a++]>>4&3;e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7};e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>
4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7};e.octaveSelect=b[a++]&3;d.push(e)}return d}function e(){var c=b[a++]<<8|b[a++];c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}}var b=c.b,a=c.a,n=c.o=[],m,k;var r=0;for(k=c.f.s;r<k;++r){var g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==g)throw Error("invalid track signature:"+g);g=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];g=a+g;for(m=n[r]=[];a<g;){var f={};f.P=b[a++];
var l=b[a++];if(255!==l)f.type="note",f.h="Note",f.oa=l>>6,f.key=l&63,f.length=b[a++],1===c.c.ka&&(l=b[a++],f.na=l>>2,f.la=l&3);else switch(f.type="meta",l=b[a++],l>>4){case 11:switch(l&15){case 0:f.h="MasterVolume";f.value=b[a++];break;case 10:f.h="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+l.toString(16));}break;case 12:f.h="SetTempo";f.value={timeBase:7===(l&7)?NaN:Math.pow(2,l&7)*(0===(l&8)?6:15),tempo:b[a++]};break;case 13:switch(l&
15){case 0:f.h="Point";f.value=b[a++];break;case 13:f.h="Loop";f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.h="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 14:switch(l&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";
f.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:f.subType="Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType="PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,
value:b[a++]&63};break;case 10:f.subType="Modulation";f.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 15:switch(l&15){case 0:f.subType="EditInstrument";f.value=d();break;case 1:f.subType="Vibrato";l=f;a++;a++;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var h={part:b[a++]>>5&3,"switch":b[a++]>>6};l.value=h;break;case 15:f.subType="DeviceSpecific";f.value=e();break;default:throw Error("unkwnon message type:"+l.toString(16));
}break;default:throw Error("unkwnon message type:"+l.toString(16));}m.push(f)}a=g}c.a=a}
function J(c){var d=[],e=c.o,b,a,n,m,k,r=[];for(a=0;16>a;++a)d[a]=[],r[a]=0;a=0;for(n=e.length;a<n;++a){var g=e[a];var f=[];var l=b=m=0;for(k=g.length;m<k;++m){var h=g[m];l+=h.deltaTime;h.id=b;h.time=l;switch(h.subType){case "Nop":break;case "Note":f[b++]=h;f[b]={id:b,type:"internal",subType:"NoteOff",time:l+h.length,key:h.key,voice:h.voice,velocity:h.velocity,octaveShift:h.octaveShift};b++;break;case "InstrumentHighPart":var q=h;h=g[++m];if("InstrumentLowPart"!==h.subType)throw Error("broken instrument");
f[b]={id:b,type:"internal",subType:"ProgramChange",time:l,part:h.value.part,instrument:q.value.instrument<<6|h.value.instrument};b++;break;default:f[b++]=h}}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});l=m=0;for(k=f.length;m<k;++m){h=f[m];l=h.time;switch(h.subType){case "Note":q=K(h.key+45,h.octaveShift);g=4*a+h.voice;9===g&&(q-=10);d[g].push(L(l-r[g]).concat(144|g,q,2*h.velocity));break;case "NoteOff":q=K(h.key+45,h.octaveShift);g=4*a+h.voice;9===g&&(q-=
10);d[g].push(L(l-r[g]).concat(128|g,q,2*h.velocity));break;case "ProgramChange":g=4*a+h.part;d[g].push(L(l-r[g]).concat(192|g,h.instrument));break;case "SetTempo":q=288E7/(h.value.tempo*h.value.timeBase);g=0;d[g].push(L(l-r[g]).concat(255,81,3,q>>16&255,q>>8&255,q&255));break;case "Loop":q=h.value.count;q="LOOP_"+(0===h.value.point?"START":"END")+"=ID:"+h.value.id+",COUNT:"+(0===q?-1:q);g=0;d[g].push(L(l-r[g]).concat([255,6,q.length],q.split("").map(function(a){return a.charCodeAt(0)})));break;case "MasterVolume":q=
h.value;g=0;d[g].push(L(l-r[g]).concat(240,7,127,127,4,1,q,q,247));break;case "Modulation":g=4*a+h.value.part;d[g].push(L(l-r[g]).concat(176|g,1,2*h.value.depth));break;case "Volume":g=4*a+h.value.part;d[g].push(L(l-r[g]).concat(176|g,7,2*h.value.volume));break;case "Valance":g=4*a+h.value.part;d[g].push(L(l-r[g]).concat(176|g,10,2*(h.value.valance-32)+64));break;case "PitchBend":g=4*a+h.value.part;d[g].push(L(l-r[g]).concat(224|g,2*h.value.value,2*h.value.value));break;case "PitchBendRange":g=4*
a+h.value.part;d[g].push(L(l-r[g]).concat(176|g,100,0),[0,176|g,101,0],[0,176|g,6,2*h.value.value]);break;case "MasterCoarseTuning":g=4*a+h.value.part;d[g].push(L(l-r[g]).concat(176|g,100,0),[0,176|g,101,2],[0,176|g,6,2*h.value.value]);break;default:continue}r[g]=h.time}}return M(c,d)}function K(c,d){var e=[0,12,-24,-12];if(void 0!==e[d])return c+e[d];throw Error("invalid OctaveShift value:"+d);}
function M(c,d){var e,b=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],a;if(void 0!==c.c.copy){c=c.c.copy;var n=c.length;var m=Array(n);for(e=0;e<n;++e)m[e]=c.charCodeAt(e);e=m;c=e.length;e=[0,255,2].concat(L(c),e);d[0].unshift(e)}n=0;for(c=d.length;n<c;++n){var k=d[n];e=[];m=0;for(a=k.length;m<a;++m)Array.prototype.push.apply(e,k[m]);a=e.length;m=[77,84,114,107,a>>24&255,a>>16&255,a>>8&255,a&255];b=b.concat(m,e)}return new Uint8Array(b)}
function L(c){for(var d=[];128<=c;)d.unshift(c&127|(0===d.length?0:128)),c>>>=7;d.unshift(c|(0===d.length?0:128));return d};function N(){this.m=5E5;this.pause=!0;this.l=!1;this.b=0;this.D=this.H=this.C=this.A=!1;this.u=1;this.K=16383}t=N.prototype;t.Z=function(c){this.A=c};t.$=function(c){this.C=c};t.ba=function(c){this.H=c};t.aa=function(c){this.D=c};t.v=function(){var c;this.pause=!0;this.i=Date.now();if(this.a)for(c=0;16>c;++c)this.a.contentWindow.postMessage("midi,b"+c.toString(16)+",78,0","*")};t.W=function(){return this.a};
function O(c){c.v();P(c);c.pause=!0;c.c=null;c.i=-1;c.L=null;c.M=null;c.w=null;c.length=0;c.b=0;u.window.clearTimeout(c.f);c.l?Q(c):u.window.addEventListener("message",function(d){"link,ready"===d.data&&Q(c)},!1)}function P(c){c.m=5E5;c.b=0;Q(c);c.pause=!1}
t.N=function(){var c=this;if(!this.a)throw Error("WebMidiLink not found");this.l?this.c?(this.length=this.c.length,this.c instanceof Array&&this.b>=this.length&&(this.b=0),R(this)):u.console.warn("Midi file is not loaded."):u.window.addEventListener("message",function(d){"link,ready"===d.data&&(c.l=!0,R(c))},!1)};
function Q(c){var d=c.a.contentWindow,e;for(e=0;16>e;++e)d.postMessage("midi,b"+e.toString(16)+",128,0","*"),d.postMessage("midi,b"+e.toString(16)+",07,64","*"),d.postMessage("midi,b"+e.toString(16)+",0a,40","*"),d.postMessage("midi,e"+e.toString(16)+",00,40","*"),d.postMessage("midi,b"+e.toString(16)+",64,00","*"),d.postMessage("midi,b"+e.toString(16)+",65,00","*"),d.postMessage("midi,b"+e.toString(16)+",06,02","*"),d.postMessage("midi,b"+e.toString(16)+",26,00","*");c.I()}
t.da=function(c,d){d||(d="wml");var e=this,b=u.window.document.getElementById(d);this.a&&(this.a=b.innerHTML=null);d=this.a=u.window.document.createElement("iframe");d.src=c||"//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html";d.className="wml";b.appendChild(d);u.window.addEventListener("message",function(a){"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(e.l=!0,e.loaded=100,e.J(e.K)):"progress"===a[1]&&(e.loaded=Math.round(a[2]/a[3]*1E4))))},!1)};
t.J=function(c){this.K=c;this.a&&this.a.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(c&127).toString(16)).substr(-2),("0"+(c>>7&127).toString(16)).substr(-2),"7f"].join(),"*")};t.ca=function(c){this.u=c};
function R(c){function d(){var c=a[m].time,f=a.length,l=Date.now();if(e.pause)e.i=Date.now()-e.i;else{do{var h=a[m].event;"SetTempo"===h.g&&(e.m=h.data[0]);"ControlChange"===h.g&&111===h.F&&(k[0]={pos:m});if("Marker"===h.g&&("A"===h.data[0]&&(k[0]={pos:m}),"B"===h.data[0]&&e.C&&k[0]&&"number"===typeof k[0].pos)){m=k[0].pos;e.f=r.setTimeout(d,0);e.b=m;return}if("Marker"===h.g&&(h=h.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===h[1])k[h[2]|0]=k[h[2]]||{pos:m,count:h[3]|0};
else if("END"===h[1]&&e.H){var q=k[h[2]|0];if(0!==q.count){0<q.count&&q.count--;m=q.pos;e.f=r.setTimeout(d,0);e.b=m;return}k[h[2]|0]=null}n.postMessage(a[m++].webMidiLink,"*")}while(m<f&&a[m].time===c);m<f?(l=Date.now()-l,e.f=r.setTimeout(d,e.m/(1E3*b)*(a[m].time-c-l)*(1/e.u))):(u.window.postMessage("endoftrack","*"),this.pause=!0,e.A&&k[0]&&"number"===typeof k[0].pos?(m=k[0].pos,e.f=r.setTimeout(d,0)):e.D&&(P(e),R(e)));e.b=m}}var e=c,b=c.L.ea,a=c.c,n=c.a.contentWindow,m=c.b||0,k=[],r=u.window;c.pause?
(c.f=r.setTimeout(d,c.i),c.pause=!1,c.i=-1):c.f=r.setTimeout(d,c.m/1E3*b*c.c[0].time)}
t.B=function(c){c=new F(c);O(this);var d=c.a;var e=d.length+d.offset;for(d.b=[];d.a<e;){var b=d;var a=b.c;var n=b.a;b.b.push({type:String.fromCharCode(a[n++],a[n++],a[n++],a[n++]),size:a=b.j?(a[n++]<<24|a[n++]<<16|a[n++]<<8|a[n++])>>>0:(a[n++]|a[n++]<<8|a[n++]<<16|a[n++]<<24)>>>0,offset:n});n+=a;b.padding&&1===(n-b.offset&1)&&n++;b.a=n}d=y(c.a,c.c++);e=c.b;b=d.offset;if(!d||"MThd"!==d.type)throw Error("invalid header signature");c.R=e[b++]<<8|e[b++];c.s=e[b++]<<8|e[b++];c.ea=e[b++]<<8|e[b++];d=0;
for(e=c.s;d<e;++d)G(c);S(this,c)};
t.X=function(c){c=new H(c);O(this);var d=c.b,e=c.a,b=c.f={},a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]);if("melo"!==a)throw Error("invalid MFi signature:"+a);b.ja=(d[e++]<<24|d[e++]<<16|d[e++]<<8|d[e++])>>>0;b.fa=(d[e++]<<16|d[e++])+e;b.ha=d[e++];b.ia=d[e++];b.s=d[e++];c.a=e;d=c.b;e=c.a;b=c.c={};for(var n;e<c.f.fa;)switch(a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]),n=d[e++]<<8|d[e++],a){case "titl":case "copy":case "vers":case "date":case "prot":b[a]=String.fromCharCode.apply(null,d.subarray(e,
e+=n));break;case "sorc":b[a]=d[e++];break;case "note":b[a]=d[e++]<<8|d[e++];break;case "exst":break;default:b[a]=d.subarray(e,e+=n)}c.a=e;I(c);this.B(J(c))};
function S(c,d){var e=c.c=[],b=c.w=[],a,n;var m=d.o;var k=Array(m.length);var r=d.G;var g=0;for(a=m.length;g<a;++g)k[g]=0;g=0;for(a=m.length;g<a;++g){k=m[g];var f=0;for(n=k.length;f<n;++f)0===d.R&&"SequenceTrackName"===k[f].g&&(c.M=k[f].data[0]),"CopyrightNotice"===k[f].g&&b.push(k[f].data[0]),e.push({track:g,eventId:f,time:k[f].time,event:k[f],webMidiLink:"midi,"+Array.prototype.map.call(r[g][f],function(a){return a.toString(16)}).join(",")})}e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?
-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});c.L=d}t.V=function(){return this.M};t.S=function(){return this.w};t.U=function(){return this.b};t.O=function(c){this.b=c};t.T=function(){return this.length};t.I=function(){this.a&&this.a.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")};t.Y=function(){this.a&&this.a.contentWindow.postMessage("midi,b0,78,0","*")};v("SMF.Player",N);v("SMF.Player.prototype.play",N.prototype.N);v("SMF.Player.prototype.stop",N.prototype.v);v("SMF.Player.prototype.loadMidiFile",N.prototype.B);v("SMF.Player.prototype.loadMldFile",N.prototype.X);v("SMF.Player.prototype.setLoop",N.prototype.aa);v("SMF.Player.prototype.setCC111Loop",N.prototype.Z);v("SMF.Player.prototype.setFalcomLoop",N.prototype.$);v("SMF.Player.prototype.setMFiLoop",N.prototype.ba);v("SMF.Player.prototype.setWebMidiLink",N.prototype.da);
v("SMF.Player.prototype.getWebMidiLink",N.prototype.W);v("SMF.Player.prototype.setTempoRate",N.prototype.ca);v("SMF.Player.prototype.setMasterVolume",N.prototype.J);v("SMF.Player.prototype.getCopyright",N.prototype.S);v("SMF.Player.prototype.getSequenceName",N.prototype.V);v("SMF.Player.prototype.getLength",N.prototype.T);v("SMF.Player.prototype.setPosition",N.prototype.O);v("SMF.Player.prototype.getPosition",N.prototype.U);v("SMF.Player.prototype.sendGmReset",N.prototype.I);
v("SMF.Player.prototype.sendAllSoundOff",N.prototype.Y);}).call(this); //# sourceMappingURL=smf.player.min.js.map
