/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {var t,u=this;function v(c,d){c=c.split(".");var e=u;c[0]in e||!e.execScript||e.execScript("var "+c[0]);for(var b;c.length&&(b=c.shift());)c.length||void 0===d?e[b]?e=e[b]:e=e[b]={}:e[b]=d}function w(c,d){function e(){}e.prototype=d.prototype;c.ma=d.prototype;c.prototype=new e;c.prototype.constructor=c;c.ga=function(b,a,c){for(var e=Array(arguments.length-2),l=2;l<arguments.length;l++)e[l-2]=arguments[l];return d.prototype[a].apply(b,e)}};function x(c,d){d=d||{};this.c=c;this.a=d.index||0;this.length=d.length||c.length-this.a;this.offset=this.a;this.padding=void 0!==d.padding?d.padding:!0;this.j=void 0!==d.j?d.j:!1}function y(c,d){c=c.b[d];return void 0===c?null:c};function A(c,d,e){this.g=c;this.P=d;this.time=e}function B(c,d,e,b,a,n){A.call(this,c,d,e);this.b=b;this.G=a;this.a=n}w(B,A);function C(c,d,e,b){A.call(this,c,d,e);this.data=b}w(C,A);function D(c,d,e,b){A.call(this,c,d,e);this.data=b}w(D,A);function F(c){var d=d||{};d.padding=!1;d.j=!0;this.b=c;this.c=0;this.a=new x(c,d);this.s=[];this.H=[]}
function G(c){function d(){var c=0;do{var d=b[a++];c=c<<7|d&127}while(0!==(d&128));return c}var e=y(c.a,c.c++),b=c.b,a=e.offset,n=-1,m=-1,l=0;if(!e||"MTrk"!==e.type)throw Error("invalid header signature");e=e.offset+e.size;for(var r=[],g=[];a<e;){var f=d();l+=f;var h=a;var k=b[a++];var q=k>>4&15;var z=k&15;8>q?(q=n,z=m,k=n<<4|m,a--,h--):(n=q,m=z);var E=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(q){case 8:case 9:case 10:case 11:case 13:case 14:var p=
new B(E[q],f,l,z,b[a++],b[a++]);break;case 12:p=new B(E[q],f,l,z,b[a++]);break;case 15:switch(z){case 0:p=d();if(247!==b[a+p-1])throw Error("invalid SysEx event");p=new C("SystemExclusive",f,l,b.subarray(a,(a+=p)-1));break;case 7:p=d();p=new C("SystemExclusive(F7)",f,l,b.subarray(a,a+=p));break;case 15:q=b[a++];p=d();switch(q){case 0:p=new D("SequenceNumber",f,l,[b[a++],b[a++]]);break;case 1:p=new D("TextEvent",f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 2:p=new D("CopyrightNotice",
f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 3:p=new D("SequenceTrackName",f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 4:p=new D("InstrumentName",f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 5:p=new D("Lyrics",f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 6:p=new D("Marker",f,l,[String.fromCharCode.apply(null,b.subarray(a,a+=p))]);break;case 7:p=new D("CuePoint",f,l,[String.fromCharCode.apply(null,b.subarray(a,
a+=p))]);break;case 32:p=new D("MidiChannelPrefix",f,l,[b[a++]]);break;case 47:p=new D("EndOfTrack",f,l,[]);break;case 81:p=new D("SetTempo",f,l,[b[a++]<<16|b[a++]<<8|b[a++]]);break;case 84:p=new D("SmpteOffset",f,l,[b[a++],b[a++],b[a++],b[a++],b[a++]]);break;case 88:p=new D("TimeSignature",f,l,[b[a++],b[a++],b[a++],b[a++]]);break;case 89:p=new D("KeySignature",f,l,[b[a++],b[a++]]);break;case 127:p=new D("SequencerSpecific",f,l,[b.subarray(a,a+=p)]);break;default:p=new D("Unknown",f,l,[q,b.subarray(a,
a+=p)])}break;default:u.console.log("unknown message:",k.toString(16))}break;default:throw Error("invalid status");}f=a-h;h=b.subarray(h,h+f);h[0]=k;p instanceof B&&"NoteOn"===p.g&&0===p.a&&(p.g=E[8],h=new Uint8Array([128|p.b,p.G,p.a]));g.push(h);r.push(p)}c.s.push(r);c.H.push(g)};function H(c){var d=d||{};this.b=c;this.a=d.index||0}
function I(c){function d(){var c=b[a++]<<8|b[a++];c=a+c;var d=[];if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;){var e={};e.part=b[a++]>>4&3;e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7};e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>
4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7};e.octaveSelect=b[a++]&3;d.push(e)}return d}function e(){var c=b[a++]<<8|b[a++];c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}}var b=c.b,a=c.a,n=c.s=[],m,l;var r=0;for(l=c.f.u;r<l;++r){var g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==g)throw Error("invalid track signature:"+g);g=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];g=a+g;for(m=n[r]=[];a<g;){var f={};f.P=b[a++];
var h=b[a++];if(255!==h)f.type="note",f.h="Note",f.oa=h>>6,f.key=h&63,f.length=b[a++],1===c.c.ka&&(h=b[a++],f.na=h>>2,f.la=h&3);else switch(f.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:f.h="MasterVolume";f.value=b[a++];break;case 10:f.h="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+h.toString(16));}break;case 12:f.h="SetTempo";f.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&7)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&
15){case 0:f.h="Point";f.value=b[a++];break;case 13:f.h="Loop";f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.h="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 14:switch(h&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";
f.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:f.subType="Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType="PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,
value:b[a++]&63};break;case 10:f.subType="Modulation";f.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 15:switch(h&15){case 0:f.subType="EditInstrument";f.value=d();break;case 1:f.subType="Vibrato";h=f;a++;a++;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);var k={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=k;break;case 15:f.subType="DeviceSpecific";f.value=e();break;default:throw Error("unkwnon message type:"+h.toString(16));
}break;default:throw Error("unkwnon message type:"+h.toString(16));}m.push(f)}a=g}c.a=a}
function J(c){var d=[],e=c.s,b,a,n,m,l,r=[];for(a=0;16>a;++a)d[a]=[],r[a]=0;a=0;for(n=e.length;a<n;++a){var g=e[a];var f=[];var h=b=m=0;for(l=g.length;m<l;++m){var k=g[m];h+=k.deltaTime;k.id=b;k.time=h;switch(k.subType){case "Nop":break;case "Note":f[b++]=k;f[b]={id:b,type:"internal",subType:"NoteOff",time:h+k.length,key:k.key,voice:k.voice,velocity:k.velocity,octaveShift:k.octaveShift};b++;break;case "InstrumentHighPart":var q=k;k=g[++m];if("InstrumentLowPart"!==k.subType)throw Error("broken instrument");
f[b]={id:b,type:"internal",subType:"ProgramChange",time:h,part:k.value.part,instrument:q.value.instrument<<6|k.value.instrument};b++;break;default:f[b++]=k}}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});h=m=0;for(l=f.length;m<l;++m){k=f[m];h=k.time;switch(k.subType){case "Note":q=K(k.key+45,k.octaveShift);g=4*a+k.voice;9===g&&(q-=10);d[g].push(L(h-r[g]).concat(144|g,q,2*k.velocity));break;case "NoteOff":q=K(k.key+45,k.octaveShift);g=4*a+k.voice;9===g&&(q-=
10);d[g].push(L(h-r[g]).concat(128|g,q,2*k.velocity));break;case "ProgramChange":g=4*a+k.part;d[g].push(L(h-r[g]).concat(192|g,k.instrument));break;case "SetTempo":q=288E7/(k.value.tempo*k.value.timeBase);g=0;d[g].push(L(h-r[g]).concat(255,81,3,q>>16&255,q>>8&255,q&255));break;case "Loop":q=k.value.count;q="LOOP_"+(0===k.value.point?"START":"END")+"=ID:"+k.value.id+",COUNT:"+(0===q?-1:q);g=0;d[g].push(L(h-r[g]).concat([255,6,q.length],q.split("").map(function(a){return a.charCodeAt(0)})));break;case "MasterVolume":q=
k.value;g=0;d[g].push(L(h-r[g]).concat(240,7,127,127,4,1,q,q,247));break;case "Modulation":g=4*a+k.value.part;d[g].push(L(h-r[g]).concat(176|g,1,2*k.value.depth));break;case "Volume":g=4*a+k.value.part;d[g].push(L(h-r[g]).concat(176|g,7,2*k.value.volume));break;case "Valance":g=4*a+k.value.part;d[g].push(L(h-r[g]).concat(176|g,10,2*(k.value.valance-32)+64));break;case "PitchBend":g=4*a+k.value.part;d[g].push(L(h-r[g]).concat(224|g,2*k.value.value,2*k.value.value));break;case "PitchBendRange":g=4*
a+k.value.part;d[g].push(L(h-r[g]).concat(176|g,100,0),[0,176|g,101,0],[0,176|g,6,2*k.value.value]);break;case "MasterCoarseTuning":g=4*a+k.value.part;d[g].push(L(h-r[g]).concat(176|g,100,0),[0,176|g,101,2],[0,176|g,6,2*k.value.value]);break;default:continue}r[g]=k.time}}return M(c,d)}function K(c,d){var e=[0,12,-24,-12];if(void 0!==e[d])return c+e[d];throw Error("invalid OctaveShift value:"+d);}
function M(c,d){var e,b=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],a;if(void 0!==c.c.copy){c=c.c.copy;var n=c.length;var m=Array(n);for(e=0;e<n;++e)m[e]=c.charCodeAt(e);e=m;c=e.length;e=[0,255,2].concat(L(c),e);d[0].unshift(e)}n=0;for(c=d.length;n<c;++n){var l=d[n];e=[];m=0;for(a=l.length;m<a;++m)Array.prototype.push.apply(e,l[m]);a=e.length;m=[77,84,114,107,a>>24&255,a>>16&255,a>>8&255,a&255];b=b.concat(m,e)}return new Uint8Array(b)}
function L(c){for(var d=[];128<=c;)d.unshift(c&127|(0===d.length?0:128)),c>>>=7;d.unshift(c|(0===d.length?0:128));return d};function N(){this.o=5E5;this.m=!1;this.b=0;this.I=this.L=this.F=this.D=!1;this.w=1;this.M=16383;this.window=u.window}t=N.prototype;t.Z=function(c){this.D=c};t.$=function(c){this.F=c};t.ba=function(c){this.L=c};t.aa=function(c){this.I=c};t.A=function(){var c;this.l=!0;this.i=Date.now();if(this.a)for(c=0;16>c;++c)this.a.postMessage("midi,b"+c.toString(16)+",78,0")};t.W=function(){return this.a};
function O(c){c.A();P(c);c.l=!1;c.c=null;c.i=-1;c.N=null;c.v=null;c.B=null;c.length=0;c.window.clearTimeout(c.f);c.m?Q(c):c.a.addEventListener("message",function(d){"link,ready"===d.data&&Q(c)},!1)}function P(c){c.o=5E5;c.b=0;Q(c)}t.O=function(){var c=this;if(!this.a)throw Error("WebMidiLink not found");this.m?(this.length=this.c.length,this.c instanceof Array&&this.b>=this.c.length&&(this.b=0),R(this)):this.a.addEventListener("message",function(d){"link,ready"===d.data&&(c.m=!0,R(c))},!1)};
function Q(c){var d;for(d=0;16>d;++d)c.a.postMessage("midi,b"+d.toString(16)+",07,64"),c.a.postMessage("midi,b"+d.toString(16)+",0a,40"),c.a.postMessage("midi,e"+d.toString(16)+",00,40"),c.a.postMessage("midi,b"+d.toString(16)+",64,00"),c.a.postMessage("midi,b"+d.toString(16)+",65,00"),c.a.postMessage("midi,b"+d.toString(16)+",06,02"),c.a.postMessage("midi,b"+d.toString(16)+",26,00");c.J()}
t.da=function(c){var d=this;this.a=c;this.a.addEventListener("message",function(c){"link,ready"===c.data&&(d.m=!0,d.K(d.M))},!1)};t.K=function(c){this.M=c;this.a&&this.a.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(c&127).toString(16)).substr(-2),("0"+(c>>7&127).toString(16)).substr(-2),"7f"].join())};t.ca=function(c){this.w=c};
function R(c){function d(){var c=a[m].time,g=a.length,f=Date.now();if(e.l)e.i=Date.now()-e.i;else{do{var h=a[m].event;"SetTempo"===h.g&&(e.o=h.data[0]);"ControlChange"===h.g&&111===h.G&&(l[0]={pos:m});if("Marker"===h.g&&("A"===h.data[0]&&(l[0]={pos:m}),"B"===h.data[0]&&e.F&&l[0]&&"number"===typeof l[0].pos)){m=l[0].pos;e.f=this.window.setTimeout(d,0);e.b=m;return}if("Marker"===h.g&&(h=h.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===h[1])l[h[2]|0]=l[h[2]]||{pos:m,count:h[3]|
0};else if("END"===h[1]&&e.L){var k=l[h[2]|0];if(0!==k.count){0<k.count&&k.count--;m=k.pos;e.f=this.window.setTimeout(d,0);e.b=m;return}l[h[2]|0]=null}n.postMessage(a[m++].webMidiLink)}while(m<g&&a[m].time===c);m<g?(f=Date.now()-f,e.f=this.window.setTimeout(d,e.o/(1E3*b)*(a[m].time-c-f)*(1/e.w))):(this.window.postMessage("endoftrack","*"),e.D&&l[0]&&"number"===typeof l[0].pos?(m=l[0].pos,e.f=this.window.setTimeout(d,0)):e.I&&(P(e),R(e)));e.b=m}}var e=c,b=c.N.ea,a=c.c,n=c.a,m=c.b||0,l=[];c.l?(c.f=
c.window.setTimeout(d,c.i),c.l=!1,c.i=-1):c.f=c.window.setTimeout(d,c.o/1E3*b*c.c[0].time)}
t.C=function(c){c=new F(c);O(this);var d=c.a;var e=d.length+d.offset;for(d.b=[];d.a<e;){var b=d;var a=b.c;var n=b.a;b.b.push({type:String.fromCharCode(a[n++],a[n++],a[n++],a[n++]),size:a=b.j?(a[n++]<<24|a[n++]<<16|a[n++]<<8|a[n++])>>>0:(a[n++]|a[n++]<<8|a[n++]<<16|a[n++]<<24)>>>0,offset:n});n+=a;b.padding&&1===(n-b.offset&1)&&n++;b.a=n}d=y(c.a,c.c++);e=c.b;b=d.offset;if(!d||"MThd"!==d.type)throw Error("invalid header signature");c.R=e[b++]<<8|e[b++];c.u=e[b++]<<8|e[b++];c.ea=e[b++]<<8|e[b++];d=0;
for(e=c.u;d<e;++d)G(c);S(this,c)};
t.X=function(c){c=new H(c);O(this);var d=c.b,e=c.a,b=c.f={},a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]);if("melo"!==a)throw Error("invalid MFi signature:"+a);b.ja=(d[e++]<<24|d[e++]<<16|d[e++]<<8|d[e++])>>>0;b.fa=(d[e++]<<16|d[e++])+e;b.ha=d[e++];b.ia=d[e++];b.u=d[e++];c.a=e;d=c.b;e=c.a;b=c.c={};for(var n;e<c.f.fa;)switch(a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]),n=d[e++]<<8|d[e++],a){case "titl":case "copy":case "vers":case "date":case "prot":b[a]=String.fromCharCode.apply(null,d.subarray(e,
e+=n));break;case "sorc":b[a]=d[e++];break;case "note":b[a]=d[e++]<<8|d[e++];break;case "exst":break;default:b[a]=d.subarray(e,e+=n)}c.a=e;I(c);this.C(J(c))};
function S(c,d){var e=c.c=[],b=c.B=[],a,n;var m=d.s;var l=Array(m.length);var r=d.H;var g=0;for(a=m.length;g<a;++g)l[g]=0;g=0;for(a=m.length;g<a;++g){l=m[g];var f=0;for(n=l.length;f<n;++f)0===d.R&&"SequenceTrackName"===l[f].g&&(c.v=l[f].data[0]),"CopyrightNotice"===l[f].g&&b.push(l[f].data[0]),e.push({track:g,eventId:f,time:l[f].time,event:l[f],webMidiLink:"midi,"+Array.prototype.map.call(r[g][f],function(a){return a.toString(16)}).join(",")})}e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?
-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});c.N=d}t.V=function(){return this.v};t.S=function(){return this.B};t.U=function(){return this.b};t.T=function(){return this.length};t.J=function(){this.a&&this.a.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")};t.Y=function(){this.a&&this.a.contentWindow.postMessage("midi,b0,78,0","*")};v("SMF.Worker",N);v("SMF.Worker.prototype.play",N.prototype.O);v("SMF.Worker.prototype.stop",N.prototype.A);v("SMF.Worker.prototype.loadMidiFile",N.prototype.C);v("SMF.Worker.prototype.loadMldFile",N.prototype.X);v("SMF.Worker.prototype.setLoop",N.prototype.aa);v("SMF.Worker.prototype.setCC111Loop",N.prototype.Z);v("SMF.Worker.prototype.setFalcomLoop",N.prototype.$);v("SMF.Worker.prototype.setMFiLoop",N.prototype.ba);v("SMF.Worker.prototype.setWebMidiLink",N.prototype.da);
v("SMF.Worker.prototype.getWebMidiLink",N.prototype.W);v("SMF.Worker.prototype.setTempoRate",N.prototype.ca);v("SMF.Worker.prototype.setMasterVolume",N.prototype.K);v("SMF.Worker.prototype.getCopyright",N.prototype.S);v("SMF.Worker.prototype.getSequenceName",N.prototype.V);v("SMF.Worker.prototype.getLength",N.prototype.T);v("SMF.Worker.prototype.getPosition",N.prototype.U);v("SMF.Worker.prototype.sendGmReset",N.prototype.J);v("SMF.Worker.prototype.sendAllSoundOff",N.prototype.Y);}).call(this); //# sourceMappingURL=smf.worker.min.js.map
